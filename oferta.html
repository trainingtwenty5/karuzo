<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grunteo - Szczegóły działki</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png">
  <link rel="icon" type="image/png" sizes="64x64" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png">
  <link rel="icon" type="image/png" sizes="192x192" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png">
  <link rel="icon" type="image/png" sizes="512x512" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png">

  <link rel="stylesheet" href="assets/main.css">
  <link rel="stylesheet" href="assets/header.css">
  <link rel="stylesheet" href="assets/oferta.css">
</head>
<body class="property-details-page">
  <div class="top-navbar">
    <div class="contact-info">
      <i class="fas fa-clock"></i> Poniedziałek - Piątek 9:00 - 18:00
      <span><i class="fas fa-phone"></i> +48 505 849 404</span>
    </div>

    <div class="auth-buttons" id="authButtons">
      <button class="btn btn-outline-primary btn-sm" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i> Zaloguj się
      </button>
      <button class="btn btn-primary btn-sm" id="registerBtn">
        <i class="fas fa-user-plus"></i> Zarejestruj się
      </button>
    </div>

    <div class="user-menu" id="userMenu" style="display:none;">
      <button class="btn btn-outline-primary btn-sm" id="accountBtn">
        <i class="fas fa-user"></i> Moje konto
      </button>
      <button class="btn btn-secondary btn-sm" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Wyloguj
      </button>
    </div>
  </div>

  <header>
    <a href="index.html" class="logo">
      <img src="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png" alt="Grunteo">
      <span>Grunteo</span>
    </a>

    <nav class="desktop-nav">
      <a href="index.html" class="nav-link">Strona główna</a>
      <a href="oferty.html" class="nav-link">Oferty</a>
      <a href="dodaj.html" class="nav-link">Dodaj</a>
      <a href="#contact" class="nav-link">Kontakt</a>
    </nav>

    <a href="dodaj.html" class="desktop-add-offer">
      <i class="fas fa-plus"></i> Dodaj ofertę
    </a>

    <a href="dodaj.html" class="mobile-add-offer">
      <i class="fas fa-plus"></i> Dodaj ofertę
    </a>

    <button class="mobile-menu-btn" aria-label="Otwórz menu">
      <i class="fas fa-bars"></i>
    </button>

    <nav class="nav-menu">
      <a href="index.html" class="nav-link">Strona główna</a>
      <a href="oferty.html" class="nav-link">Oferty</a>
      <a href="dodaj.html" class="nav-link">Dodaj</a>
      <a href="#contact" class="nav-link">Kontakt</a>
      <div class="mobile-auth" id="mobileAuth" style="display:none;"></div>
    </nav>
  </header>

  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <main class="property-main">
    <div class="container">
      <div class="page-state" id="loadingState">Ładuję dane działki...</div>
      <div class="page-state hidden" id="errorState">
        <p>Nie udało się wczytać szczegółów tej działki.</p>
        <a class="btn btn-secondary" href="oferty.html">
          <i class="fas fa-arrow-left"></i> Powrót do listy ofert
        </a>
      </div>

      <section id="propertyContent" class="hidden">
        <section class="property-hero" aria-labelledby="propertyTitle">
          <div class="property-heading">
            <div class="title-group">
              <div class="inline-edit inline-edit--title">
                <h1 id="propertyTitle" class="inline-edit__display">Działka</h1>
                <input type="text" id="editTitle" class="inline-edit__input" autocomplete="off" placeholder="Tytuł ogłoszenia">
              </div>
              <div class="property-meta">
                <div class="meta-item">
                  <span class="meta-chip"><i class="fas fa-map-marker-alt"></i> <span id="propertyLocation" class="inline-edit__display">Polska</span></span>
                  <div class="meta-edit-fields">
                    <label for="editCity">Miasto / miejscowość</label>
                    <input type="text" id="editCity" class="inline-edit__input" autocomplete="off" placeholder="np. Kraków">
                    <label for="editMunicipality">Gmina</label>
                    <input type="text" id="editMunicipality" class="inline-edit__input" autocomplete="off" placeholder="np. Wola Justowska">
                    <label for="editVoivodeship">Województwo</label>
                    <input type="text" id="editVoivodeship" class="inline-edit__input" autocomplete="off" placeholder="np. Małopolskie">
                  </div>
                </div>
                <div class="meta-item">
                  <span class="meta-chip"><i class="fas fa-ruler-combined"></i> <span id="propertyArea" class="inline-edit__display">0 m²</span></span>
                </div>
                <div class="meta-item">
                  <span class="meta-chip"><i class="fas fa-layer-group"></i> <span id="propertyType" class="inline-edit__display">Rodzaj</span></span>
                  <div class="meta-edit-fields">
                    <label for="editPlotType">Rodzaj działki</label>
                    <input type="text" id="editPlotType" class="inline-edit__input" autocomplete="off" placeholder="np. Budowlana">
                  </div>
                </div>
                <div class="meta-item">
                  <span class="meta-chip"><i class="fas fa-landmark"></i> <span id="ownershipStatus" class="inline-edit__display">Własność</span></span>
                  <div class="meta-edit-fields">
                    <label for="editOwnership">Status własności</label>
                    <input type="text" id="editOwnership" class="inline-edit__input" autocomplete="off" placeholder="np. Własność">
                  </div>
                </div>
              </div>
            </div>
            <div class="price-editor" aria-live="polite">
              <div class="price-label">Cena całkowita</div>
              <div class="inline-edit inline-edit--price">
                <div class="price-display empty inline-edit__display" id="priceValueDisplay">—</div>
                <input type="number" id="editPrice" class="inline-edit__input" min="0" step="1" placeholder="Podaj cenę w PLN">
              </div>
              <div class="price-meta">
                <span>cena za m²: <strong id="pricePerSqm">0 PLN/m²</strong></span>
                <span id="priceUpdatedAt">Aktualizacja: —</span>
              </div>
              <div class="edit-controls hidden" id="editControls">
                <button type="button" class="btn btn-outline-primary btn-sm" id="editToggleBtn">
                  <i class="fas fa-pen"></i> Edytuj dane
                </button>
                <button type="button" class="btn btn-secondary btn-sm hidden" id="cancelEditBtn">
                  <i class="fas fa-times"></i> Anuluj
                </button>
                <button type="button" class="btn btn-primary btn-sm hidden" id="saveChangesBtn">
                  <i class="fas fa-save"></i> Zapisz zmiany
                </button>
              </div>
              <p class="edit-hint hidden" id="editHint"></p>
            </div>
          </div>
          <div class="property-stats">
            <div class="stat-card">
              <h4>Numer działki</h4>
              <p id="plotNumber" class="inline-edit__display">—</p>
              <input type="text" id="editPlotNumber" class="inline-edit__input inline-input" autocomplete="off" placeholder="Wpisz numer działki">
            </div>
            <div class="stat-card">
              <h4>Numer księgi wieczystej</h4>
              <p id="landRegister" class="inline-edit__display">—</p>
              <input type="text" id="editLandRegister" class="inline-edit__input inline-input" autocomplete="off" placeholder="Wpisz numer KW">
            </div>
            <div class="stat-card">
              <h4>Powierzchnia</h4>
              <p id="plotAreaStat" class="inline-edit__display">—</p>
              <input type="number" id="editArea" class="inline-edit__input inline-input" min="0" step="1" placeholder="Powierzchnia w m²">
            </div>
            <div class="stat-card">
              <h4>Status</h4>
              <p id="plotStatus" class="inline-edit__display">—</p>
              <input type="text" id="editPlotStatus" class="inline-edit__input inline-input" autocomplete="off" placeholder="np. Aktywna">
            </div>
          </div>
        </section>

        <section class="property-layout" id="mapSection">
          <div class="map-panel">
            <div class="map-toolbar">
              <h3>Mapa i lokalizacja</h3>
              <div class="map-modes" role="group" aria-label="Warstwy mapy">
                <button class="map-mode-btn active" data-mode="base">Mapa</button>
                <button class="map-mode-btn" data-mode="mpzp">MPZP</button>
                <button class="map-mode-btn" data-mode="studium">Studium</button>
              </div>
            </div>
            <div id="propertyMap" role="region" aria-label="Mapa działki"></div>
            <div class="location-details">
              <div class="location-card">
                <h4>Adres</h4>
                <p id="locationAddress" class="inline-edit__display">Dodaj adres działki</p>
                <textarea id="editAddress" class="inline-edit__input" rows="3" placeholder="Podaj dokładny adres działki"></textarea>
              </div>
              <div class="location-card">
                <h4>Dojazd i otoczenie</h4>
                <p id="locationAccess" class="inline-edit__display">Opisz komunikację, dostęp do drogi, najbliższe punkty orientacyjne.</p>
                <textarea id="editAccess" class="inline-edit__input" rows="3" placeholder="Opisz dojazd, komunikację i najbliższe udogodnienia"></textarea>
              </div>
            </div>
          </div>

          <aside class="plan-panel">
            <div class="section-header">
              <h3>Plan zagospodarowania</h3>
            </div>
            <div class="plan-badges" id="planBadges"></div>
            <div class="plan-edit-fields">
              <label for="editPlanType">Typ planu</label>
              <input type="text" id="editPlanType" class="inline-edit__input inline-input" autocomplete="off" placeholder="np. MPZP">
              <label for="editPlanSymbol">Symbol planu</label>
              <input type="text" id="editPlanSymbol" class="inline-edit__input inline-input" autocomplete="off" placeholder="np. MN/U">
            </div>
            <div class="plan-info-grid">
              <dl>
                <dt>Przeznaczenie</dt>
                <dd>
                  <span id="planDesignation" class="inline-edit__display">Brak informacji</span>
                  <input type="text" id="editPlanDesignation" class="inline-edit__input inline-input" autocomplete="off" placeholder="Opisz przeznaczenie terenu">
                </dd>
              </dl>
              <dl>
                <dt>Maks. wysokość</dt>
                <dd>
                  <span id="planHeight" class="inline-edit__display">—</span>
                  <input type="text" id="editPlanHeight" class="inline-edit__input inline-input" autocomplete="off" placeholder="np. 12 m">
                </dd>
              </dl>
              <dl>
                <dt>Intensywność zabudowy</dt>
                <dd>
                  <span id="planIntensity" class="inline-edit__display">—</span>
                  <input type="text" id="editPlanIntensity" class="inline-edit__input inline-input" autocomplete="off" placeholder="np. do 0.5">
                </dd>
              </dl>
              <dl>
                <dt>Pow. biologicznie czynna</dt>
                <dd>
                  <span id="planGreen" class="inline-edit__display">—</span>
                  <input type="text" id="editPlanGreen" class="inline-edit__input inline-input" autocomplete="off" placeholder="np. min. 40%">
                </dd>
              </dl>
            </div>
            <div class="plan-notes">
              <div id="planNotes" class="inline-edit__display">Uzupełnij najważniejsze zapisy z planu miejscowego lub studium.</div>
              <textarea id="editPlanNotes" class="inline-edit__input" rows="4" placeholder="Dodaj notatki o ograniczeniach, wskaźnikach oraz wymaganiach planistycznych"></textarea>
            </div>
          </aside>
        </section>

        <section class="utilities-section" aria-labelledby="utilitiesTitle">
          <div class="section-header">
            <h2 id="utilitiesTitle">Uzbrojenie terenu</h2>
            <span style="font-size:0.85rem;color:var(--gray);">Kliknij ikonę, aby zmienić status</span>
          </div>
          <div class="utilities-grid" id="utilitiesGrid">
            <div class="utility-card" data-utility="electricity" data-status="missing">
              <div class="utility-icon">⚡</div>
              <div class="utility-content">
                <h4>Prąd</h4>
                <div class="utility-status">Brak informacji</div>
                <select id="editUtilityElectricity" class="inline-edit__input inline-select">
                  <option value="">Brak informacji</option>
                  <option value="available">Dostępne</option>
                  <option value="planned">W drodze</option>
                  <option value="missing">Brak</option>
                </select>
              </div>
            </div>
            <div class="utility-card" data-utility="water" data-status="missing">
              <div class="utility-icon">💧</div>
              <div class="utility-content">
                <h4>Woda</h4>
                <div class="utility-status">Brak informacji</div>
                <select id="editUtilityWater" class="inline-edit__input inline-select">
                  <option value="">Brak informacji</option>
                  <option value="available">Dostępne</option>
                  <option value="planned">W drodze</option>
                  <option value="missing">Brak</option>
                </select>
              </div>
            </div>
            <div class="utility-card" data-utility="gas" data-status="missing">
              <div class="utility-icon">🔥</div>
              <div class="utility-content">
                <h4>Gaz</h4>
                <div class="utility-status">Brak informacji</div>
                <select id="editUtilityGas" class="inline-edit__input inline-select">
                  <option value="">Brak informacji</option>
                  <option value="available">Dostępne</option>
                  <option value="planned">W drodze</option>
                  <option value="missing">Brak</option>
                </select>
              </div>
            </div>
            <div class="utility-card" data-utility="sewage" data-status="missing">
              <div class="utility-icon">♻️</div>
              <div class="utility-content">
                <h4>Kanalizacja</h4>
                <div class="utility-status">Brak informacji</div>
                <select id="editUtilitySewage" class="inline-edit__input inline-select">
                  <option value="">Brak informacji</option>
                  <option value="available">Dostępne</option>
                  <option value="planned">W drodze</option>
                  <option value="missing">Brak</option>
                </select>
              </div>
            </div>
            <div class="utility-card" data-utility="fiber" data-status="missing">
              <div class="utility-icon">🌐</div>
              <div class="utility-content">
                <h4>Światłowód</h4>
                <div class="utility-status">Brak informacji</div>
                <select id="editUtilityFiber" class="inline-edit__input inline-select">
                  <option value="">Brak informacji</option>
                  <option value="available">Dostępne</option>
                  <option value="planned">W drodze</option>
                  <option value="missing">Brak</option>
                </select>
              </div>
            </div>
          </div>
        </section>


        <section class="description-section" aria-labelledby="descriptionTitle">
          <div class="section-header">
            <h2 id="descriptionTitle">Opis szczegółowy</h2>
          </div>
          <div class="description-card">
            <div id="descriptionContent" class="description-content inline-edit__display">Dodaj opis działki i jej najważniejsze atuty.</div>
            <textarea id="editDescription" class="inline-edit__input description-textarea" rows="6" placeholder="Opisz inwestycję, historię działki oraz jej największe atuty"></textarea>
            <div class="edit-highlights">
              <button type="button" data-highlight="✅ W pobliżu szkoła">Dodaj: ✅ W pobliżu szkoła</button>
              <button type="button" data-highlight="✅ Blisko las">Dodaj: ✅ Blisko las</button>
              <button type="button" data-highlight="✅ Dostępne media">Dodaj: ✅ Dostępne media</button>
              <button type="button" data-highlight="✅ Dojazd asfaltowy">Dodaj: ✅ Dojazd asfaltowy</button>
            </div>
          </div>
        </section>

        <section class="tags-section" aria-labelledby="tagsTitle">
          <div class="section-header">
            <h2 id="tagsTitle">Parametry dodatkowe</h2>
          </div>
            <div class="tags-card">
              <div class="tags-list" id="tagsList"></div>
              <div class="tags-editor inline-edit__input-group">
                <label for="editTags">Znaczniki (oddziel przecinkami)</label>
                <input type="text" id="editTags" class="inline-edit__input" placeholder="#Budowlana, #Dojazd-asfaltowy">
              </div>
            </div>
        </section>
        <section class="contact-section" id="contact" aria-labelledby="contactTitle">
          <div class="section-header">
            <h2 id="contactTitle">Skontaktuj się</h2>
          </div>
          <div class="contact-wrapper">
            <div class="contact-card">
              <div class="inline-edit inline-edit--contact-name">
                <h3 id="contactName" class="inline-edit__display">Właściciel</h3>
                <input type="text" id="editContactName" class="inline-edit__input" autocomplete="off" placeholder="Osoba kontaktowa / biuro">
              </div>
              <div class="contact-details">
                <span><i class="fas fa-phone"></i> <a href="#" id="contactPhoneLink">Brak numeru</a></span>
                <span><i class="fas fa-envelope"></i> <a href="#" id="contactEmailLink">Brak adresu</a></span>
              </div>
              <div class="contact-edit-grid inline-edit__input-group">
                <label for="editContactPhone">Telefon</label>
                <input type="tel" id="editContactPhone" class="inline-edit__input" autocomplete="off" placeholder="np. 505 000 000">
                <label for="editContactEmail">Adres e-mail</label>
                <input type="email" id="editContactEmail" class="inline-edit__input" autocomplete="off" placeholder="np. biuro@firma.pl">
              </div>
              <div class="contact-actions">
                <button class="btn btn-secondary" type="button" id="savePlotBtn">
                  <i class="fas fa-bookmark"></i> Zapisz działkę
                </button>
                <button class="btn btn-primary" type="button" id="contactCTA">
                  <i class="fas fa-comment-dots"></i> Wyślij wiadomość
                </button>
              </div>
            </div>
            <form class="contact-form" id="contactForm">
              <div class="form-row">
                <input type="text" id="inqName" placeholder="Twoje imię" required>
                <input type="tel" id="inqPhone" placeholder="Telefon (opcjonalnie)">
              </div>
              <input type="email" id="inqEmail" placeholder="Adres e-mail" required>
              <textarea id="inqMessage" placeholder="Twoja wiadomość do właściciela" required></textarea>
              <button type="submit" class="btn btn-primary">Wyślij zapytanie</button>
            </form>
          </div>
        </section>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
      const navMenu = document.querySelector('.nav-menu');
      const mobileAuth = document.getElementById('mobileAuth');

      mobileMenuBtn?.addEventListener('click', function () {
        navMenu.classList.toggle('active');
        if (mobileAuth) {
          mobileAuth.style.display = navMenu.classList.contains('active') ? 'flex' : 'none';
        }
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          navMenu.classList.remove('active');
          if (mobileAuth) mobileAuth.style.display = 'none';
        }
      });
    });

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const wrap = document.createElement('div');
      wrap.className = `toast-lite toast-${type}`;
      wrap.setAttribute('role', 'status');
      wrap.setAttribute('aria-live', 'polite');

      const icon = {
        success: '✓',
        info: 'ℹ',
        warning: '!',
        error: '✕'
      }[type] || 'ℹ';

      wrap.innerHTML = `
        <div class="toast-icon" aria-hidden="true">${icon}</div>
        <div class="toast-msg">${message}</div>
        <button class="toast-close" aria-label="Zamknij">&times;</button>
      `;

      const close = () => {
        wrap.classList.remove('show');
        setTimeout(() => wrap.remove(), 180);
      };

      wrap.querySelector('.toast-close').addEventListener('click', close);
      container.appendChild(wrap);

      requestAnimationFrame(() => wrap.classList.add('show'));
      setTimeout(close, 4000);
    }
  </script>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Zaloguj się</h3>
        <button class="modal-close" aria-label="Zamknij">&times;</button>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Hasło</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Zaloguj się</button>
      </form>
      <div class="social-login">
        <button type="button" class="btn btn-google" id="googleLoginBtnLogin">
          <i class="fab fa-google"></i> Kontynuuj z Google
        </button>
      </div>
      <div class="form-footer">
        <p>Nie masz konta? <a href="#" id="switchToRegister">Zarejestruj się</a></p>
      </div>
    </div>
  </div>

  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Utwórz konto</h3>
        <button class="modal-close" aria-label="Zamknij">&times;</button>
      </div>
      <form id="registerForm">
        <div class="form-group">
          <label for="registerName">Imię i nazwisko</label>
          <input type="text" id="registerName" required>
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">Hasło</label>
          <input type="password" id="registerPassword" required>
        </div>
        <div class="form-group">
          <label for="registerConfirmPassword">Potwierdź hasło</label>
          <input type="password" id="registerConfirmPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Zarejestruj się</button>
      </form>
      <div class="social-login">
        <button type="button" class="btn btn-google" id="googleLoginBtn">
          <i class="fab fa-google"></i> Kontynuuj z Google
        </button>
      </div>
      <div class="domain-warning" id="domainWarning" style="display:none;">
        <i class="fas fa-exclamation-triangle"></i>
        Uwaga: dodaj swoją domenę do listy zaufanych w Firebase, aby logowanie działało poprawnie.
      </div>
      <div class="form-footer">
        <p>Masz już konto? <a href="#" id="switchToLogin">Zaloguj się</a></p>
      </div>
    </div>
  </div>

  <script>
    const mapScriptLoader = (() => {
      let loaded = false;
      return function loadGoogleMaps() {
        if (loaded) return;
        loaded = true;
        const apiKey = localStorage.getItem('googleMapsApiKey') || 'AIzaSyCr5TmFxnT3enxmyr6vujF8leP995giw8I';
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initPropertyMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      };
    })();
    document.addEventListener('DOMContentLoaded', mapScriptLoader);
  </script>

  <script type="module">
    import { initializeApp, getApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore, doc, getDoc, updateDoc, Timestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      updateProfile, signOut, GoogleAuthProvider, signInWithPopup, setPersistence,
      browserLocalPersistence, browserSessionPersistence
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE',
      authDomain: 'base-468e0.firebaseapp.com',
      projectId: 'base-468e0',
      storageBucket: 'base-468e0.firebasestorage.app',
      messagingSenderId: '829161895559',
      appId: '1:829161895559:web:d832541aac05b35847ea22'
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    auth.languageCode = 'pl';

    try {
      await setPersistence(auth, browserLocalPersistence);
    } catch (err) {
      try {
        await setPersistence(auth, browserSessionPersistence);
      } catch (_) {}
    }

    const state = {
      offerId: null,
      plotIndex: 0,
      offerData: null,
      plotData: null,
      favorites: new Set(),
      tags: [],
      currentUser: null,
      isOwner: false,
      editMode: false,
      pendingEditMode: false,
      saving: false
    };

    const DEFAULT_TAG_SUGGESTIONS = ['#Budowlana', '#Dostępne-media', '#Dojazd-asfaltowy'];

    window.__propertyPage = {
      mapData: null,
      mapInstance: null,
      polygon: null,
      marker: null,
      overlays: {},
      activeMode: 'base'
    };

    const params = new URLSearchParams(window.location.search);
    const editParam = params.get('edit');
    const offerId = params.get('id') || editParam || null;
    const plotIndex = Number(params.get('plot') || '0');
    const normalizedEditParam = (editParam || '').toLowerCase();
    const editModeRequested = params.get('mode') === 'edit'
      || params.get('start') === 'edit'
      || (editParam && offerId && !['0', 'false', 'no', 'off'].includes(normalizedEditParam));

    state.offerId = offerId;
    state.plotIndex = Number.isNaN(plotIndex) ? 0 : plotIndex;
    state.pendingEditMode = Boolean(editModeRequested);

    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const contentSection = document.getElementById('propertyContent');
    const priceDisplay = document.getElementById('priceValueDisplay');
    const pricePerSqmEl = document.getElementById('pricePerSqm');
    const priceUpdatedAt = document.getElementById('priceUpdatedAt');
    const tagsList = document.getElementById('tagsList');
    const descriptionContent = document.getElementById('descriptionContent');
    const utilitiesGrid = document.getElementById('utilitiesGrid');
    const mapModeButtons = document.querySelectorAll('.map-mode-btn');
    const contactForm = document.getElementById('contactForm');
    const contactCTA = document.getElementById('contactCTA');
    const savePlotBtn = document.getElementById('savePlotBtn');
    const editControls = document.getElementById('editControls');
    const editToggleBtn = document.getElementById('editToggleBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const saveChangesBtn = document.getElementById('saveChangesBtn');
    const editHint = document.getElementById('editHint');

    const editTitleInput = document.getElementById('editTitle');
    const editPlotNumberInput = document.getElementById('editPlotNumber');
    const editLandRegisterInput = document.getElementById('editLandRegister');
    const editAreaInput = document.getElementById('editArea');
    const editPlotTypeInput = document.getElementById('editPlotType');
    const editPlotStatusInput = document.getElementById('editPlotStatus');
    const editOwnershipInput = document.getElementById('editOwnership');
    const editPriceInput = document.getElementById('editPrice');
    const editCityInput = document.getElementById('editCity');
    const editMunicipalityInput = document.getElementById('editMunicipality');
    const editVoivodeshipInput = document.getElementById('editVoivodeship');
    const editAddressInput = document.getElementById('editAddress');
    const editAccessInput = document.getElementById('editAccess');
    const editPlanTypeInput = document.getElementById('editPlanType');
    const editPlanSymbolInput = document.getElementById('editPlanSymbol');
    const editPlanDesignationInput = document.getElementById('editPlanDesignation');
    const editPlanHeightInput = document.getElementById('editPlanHeight');
    const editPlanIntensityInput = document.getElementById('editPlanIntensity');
    const editPlanGreenInput = document.getElementById('editPlanGreen');
    const editPlanNotesInput = document.getElementById('editPlanNotes');
    const editDescriptionInput = document.getElementById('editDescription');
    const editTagsInput = document.getElementById('editTags');
    const editContactNameInput = document.getElementById('editContactName');
    const editContactPhoneInput = document.getElementById('editContactPhone');
    const editContactEmailInput = document.getElementById('editContactEmail');
    const editHighlights = document.querySelectorAll('.edit-highlights button');

    const utilitySelects = {
      electricity: document.getElementById('editUtilityElectricity'),
      water: document.getElementById('editUtilityWater'),
      gas: document.getElementById('editUtilityGas'),
      sewage: document.getElementById('editUtilitySewage'),
      fiber: document.getElementById('editUtilityFiber')
    };

    const editFields = [
      editTitleInput,
      editPlotNumberInput,
      editLandRegisterInput,
      editAreaInput,
      editPlotTypeInput,
      editPlotStatusInput,
      editOwnershipInput,
      editPriceInput,
      editCityInput,
      editMunicipalityInput,
      editVoivodeshipInput,
      editAddressInput,
      editAccessInput,
      editPlanTypeInput,
      editPlanSymbolInput,
      editPlanDesignationInput,
      editPlanHeightInput,
      editPlanIntensityInput,
      editPlanGreenInput,
      editPlanNotesInput,
      editDescriptionInput,
      editTagsInput,
      editContactNameInput,
      editContactPhoneInput,
      editContactEmailInput,
      ...Object.values(utilitySelects)
    ];

    const saveButtonDefaultLabel = saveChangesBtn?.innerHTML || '';

    function toggleState(showContent) {
      loadingState.classList.toggle('hidden', showContent || errorState.classList.contains('hidden') === false);
      contentSection.classList.toggle('hidden', !showContent);
    }

    function showError(message = 'Nie udało się wczytać szczegółów tej działki.') {
      loadingState.classList.add('hidden');
      contentSection.classList.add('hidden');
      errorState.classList.remove('hidden');
      errorState.querySelector('p').textContent = message;
    }

    const DISPLAY_CURRENCY = 'PLN';

    function formatNumber(value, options = {}) {
      if (value === null || value === undefined || value === '') return '';
      const number = Number(value);
      if (Number.isNaN(number)) return String(value);
      return number.toLocaleString('pl-PL', options);
    }

    function formatPhone(phone) {
      const digits = String(phone || '').replace(/\D/g, '');
      if (digits.length === 9) {
        return `+48 ${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
      }
      if (digits.length === 11 && digits.startsWith('48')) {
        return `+48 ${digits.slice(2,5)}-${digits.slice(5,8)}-${digits.slice(8)}`;
      }
      return phone || '';
    }

    function parseNumberField(input) {
      if (!input) return null;
      const raw = String(input.value ?? '').replace(',', '.').trim();
      if (!raw) return null;
      const value = Number(raw);
      return Number.isFinite(value) ? value : null;
    }

    function formatPriceValue(value) {
      if (value === null || value === undefined || value === '') return '—';
      return `${formatNumber(value)} ${DISPLAY_CURRENCY}`;
    }

    function updatePriceSummary(price, area) {
      if (priceDisplay) {
        const numericPrice = Number(price);
        const hasPrice = Number.isFinite(numericPrice) && numericPrice > 0;
        priceDisplay.textContent = formatPriceValue(price);
        priceDisplay.classList.toggle('empty', !hasPrice);
      }
      if (!pricePerSqmEl) return;
      const numericPrice = Number(price);
      const numericArea = Number(area);
      if (!numericPrice || !numericArea) {
        pricePerSqmEl.textContent = `0 ${DISPLAY_CURRENCY}/m²`;
        return;
      }
      const perSqm = Math.round(numericPrice / numericArea);
      pricePerSqmEl.textContent = `${formatNumber(perSqm)} ${DISPLAY_CURRENCY}/m²`;
    }

    function setDescriptionText(text) {
      if (!descriptionContent) return;
      const value = (text || '').trim();
      descriptionContent.textContent = value || 'Dodaj opis działki i jej najważniejsze atuty.';
    }

    function parseTagsInputValue(rawValue) {
      if (!rawValue) return [];
      return Array.from(new Set(rawValue
        .split(/[#,\s,]+/)
        .map(tag => tag.trim())
        .filter(Boolean)
        .map(tag => tag.startsWith('#') ? tag.replace(/^#+/, '#') : `#${tag}`)
      ));
    }

    function isEditingAllowed() {
      return state.editMode && state.isOwner && !state.saving;
    }

    function applyEditingState() {
      const editing = state.editMode && state.isOwner;
      document.body.classList.toggle('property-edit-mode', editing);

      const disableInputs = !editing || state.saving;
      editFields.forEach(field => {
        if (field) field.disabled = disableInputs;
      });

      Object.values(utilitySelects).forEach(select => {
        if (select) select.disabled = disableInputs;
      });

      editHighlights.forEach(btn => {
        btn.disabled = !editing || state.saving;
      });

      if (cancelEditBtn) {
        cancelEditBtn.disabled = state.saving;
      }
      if (saveChangesBtn) {
        saveChangesBtn.disabled = state.saving;
        saveChangesBtn.innerHTML = state.saving
          ? '<i class="fas fa-spinner fa-spin"></i> Zapisywanie...'
          : saveButtonDefaultLabel;
      }
    }

    function updateEditButtons() {
      const dataReady = Boolean(state.offerData && state.plotData);
      const showControls = state.isOwner && dataReady;
      editControls?.classList.toggle('hidden', !showControls);
      if (!showControls) {
        if (saveChangesBtn) {
          saveChangesBtn.disabled = false;
          saveChangesBtn.innerHTML = saveButtonDefaultLabel;
        }
        if (cancelEditBtn) {
          cancelEditBtn.disabled = false;
        }
        editToggleBtn?.classList.add('hidden');
        return;
      }

      editToggleBtn?.classList.toggle('hidden', state.editMode);
      if (editToggleBtn) {
        editToggleBtn.disabled = state.saving;
      }

      if (cancelEditBtn) {
        cancelEditBtn.classList.toggle('hidden', !state.editMode);
        cancelEditBtn.disabled = state.saving;
      }
      if (saveChangesBtn) {
        saveChangesBtn.classList.toggle('hidden', !state.editMode);
        if (!state.saving) {
          saveChangesBtn.innerHTML = saveButtonDefaultLabel;
        }
        saveChangesBtn.disabled = state.saving;
      }
    }

    function updateEditHint() {
      if (!editHint) return;
      if (!state.offerData || !state.plotData) {
        editHint.classList.add('hidden');
        editHint.classList.remove('active');
        return;
      }

      let message = '';
      if (!state.currentUser) {
        message = '';
      } else if (!state.isOwner) {
        message = 'Tylko właściciel ogłoszenia może wprowadzać zmiany.';
      } else if (state.editMode) {
        message = 'Tryb edycji aktywny — pamiętaj o zapisaniu zmian.';
      }

      editHint.textContent = message;
      editHint.classList.toggle('hidden', !message);
      editHint.classList.toggle('active', Boolean(state.editMode && state.isOwner));
    }

    function refreshEditPermissions() {
      const hasData = Boolean(state.offerData && state.plotData);
      const ownerUid = state.offerData?.userUid;
      state.isOwner = Boolean(state.currentUser && ownerUid && ownerUid === state.currentUser.uid);

      if ((!state.isOwner || !state.currentUser) && state.editMode) {
        state.editMode = false;
        if (hasData) {
          renderBasics(state.offerData, state.plotData);
        }
      }

      if (!hasData) {
        applyEditingState();
        updateEditButtons();
        updateEditHint();
        return;
      }

      if (state.pendingEditMode) {
        if (state.isOwner) {
          state.editMode = true;
          state.pendingEditMode = false;
          showToast('Tryb edycji aktywny. Wprowadź zmiany i zapisz.', 'info');
        } else {
          state.pendingEditMode = false;
          showToast('Tylko właściciel ogłoszenia może je edytować.', 'warning');
        }
      }

      applyEditingState();
      updateEditButtons();
      updateEditHint();

      renderTags(state.tags);
    }

    function normalizeStatus(value) {
      if (!value) return '';
      const normalized = String(value).toLowerCase();
      if (['dostepne', 'dostępne', 'available', 'tak', 'yes', 'jest', 'podlaczona', 'podłączona'].some(v => normalized.includes(v))) {
        return 'available';
      }
      if (['w drodze', 'planowane', 'planned', 'projekt', 'w trakcie'].some(v => normalized.includes(v))) {
        return 'planned';
      }
      if (['brak', 'nie', 'none'].some(v => normalized.includes(v))) {
        return 'missing';
      }
      return '';
    }

    function utilityLabel(status, hasValue) {
      switch (status) {
        case 'available':
          return 'Dostępne';
        case 'planned':
          return 'W drodze';
        case 'missing':
          return hasValue ? 'Brak' : 'Brak informacji';
        default:
          return 'Brak informacji';
      }
    }

    function updateUtilityCardsFromSelects() {
      if (!utilitiesGrid) return;
      utilitiesGrid.querySelectorAll('.utility-card').forEach(card => {
        const key = card.getAttribute('data-utility');
        if (!key) return;
        const select = utilitySelects[key];
        const value = select?.value || '';
        const status = value ? normalizeStatus(value) : '';
        card.dataset.status = status || '';
        const label = utilityLabel(status, Boolean(value));
        card.querySelector('.utility-status').textContent = label;
      });
    }

    function renderUtilities(data = {}) {
      const defaultUtilities = {
        electricity: data.electricity ?? data.power ?? data.prad,
        water: data.water ?? data.woda,
        gas: data.gas ?? data.gaz,
        sewage: data.sewage ?? data.kanalizacja,
        fiber: data.fiber ?? data.internet ?? data.swiatlowod
      };

      Object.entries(utilitySelects).forEach(([key, select]) => {
        if (!select) return;
        const raw = defaultUtilities[key];
        if (raw === undefined || raw === null || raw === '') {
          select.value = '';
        } else {
          select.value = normalizeStatus(raw);
        }
      });

      updateUtilityCardsFromSelects();
    }

    function collectUtilities() {
      const utilities = {};
      Object.entries(utilitySelects).forEach(([key, select]) => {
        if (!select) return;
        utilities[key] = select.value || '';
      });
      return utilities;
    }

    function renderTags(tags = []) {
      state.tags = Array.from(new Set((tags || []).filter(Boolean)));
      if (!tagsList) return;
      tagsList.innerHTML = '';

      if (!state.tags.length) {
        DEFAULT_TAG_SUGGESTIONS.forEach(example => {
          const el = document.createElement('span');
          el.className = 'tag-chip tag-chip--ghost';
          el.textContent = example;
          tagsList.appendChild(el);
        });
        return;
      }

      state.tags.forEach(tag => {
        const el = document.createElement('span');
        el.className = 'tag-chip';
        el.textContent = tag;
        tagsList.appendChild(el);
      });
    }

    applyEditingState();
    updateEditButtons();
    updateEditHint();

    editHighlights.forEach(btn => {
      btn.addEventListener('click', () => {
        if (!state.editMode || !state.isOwner || !editDescriptionInput) return;
        const text = btn.getAttribute('data-highlight');
        if (!text) return;
        const current = (editDescriptionInput.value || '').trim();
        editDescriptionInput.value = current ? `${current}\n${text}` : text;
        showToast('Dodano wyróżnienie do opisu.', 'success');
      });
    });

    Object.entries(utilitySelects).forEach(([key, select]) => {
      select?.addEventListener('change', () => {
        if (!state.editMode || !state.isOwner) return;
        updateUtilityCardsFromSelects();
      });
    });

    function parseGeometry(geometryString) {
      const coords = [];
      if (!geometryString) return coords;
      try {
        proj4.defs('EPSG:2180', '+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs');
        const match = geometryString.match(/\(\(([^)]+)\)\)/);
        if (!match) return coords;
        const points = match[1].split(',');
        points.forEach(point => {
          const [xStr, yStr] = point.trim().split(' ');
          const x = parseFloat(xStr);
          const y = parseFloat(yStr);
          if (!Number.isNaN(x) && !Number.isNaN(y)) {
            const [lng, lat] = proj4('EPSG:2180', 'WGS84', [x, y]);
            coords.push({ lat, lng });
          }
        });
      } catch (error) {
        console.error('Błąd parsowania geometrii', error);
      }
      return coords;
    }

    function geometryCenter(coords = []) {
      if (!coords.length) return null;
      const sum = coords.reduce((acc, c) => {
        acc.lat += c.lat;
        acc.lng += c.lng;
        return acc;
      }, { lat: 0, lng: 0 });
      return { lat: sum.lat / coords.length, lng: sum.lng / coords.length };
    }

    function updateMapData(plot) {
      const coords = parseGeometry(plot.geometry_uldk || plot.geometry || plot.geom);
      let center = null;
      if (plot.lat && plot.lng) {
        center = { lat: Number(plot.lat), lng: Number(plot.lng) };
      } else if (coords.length) {
        center = geometryCenter(coords);
      }

      window.__propertyPage.mapData = {
        center,
        coords,
        zoom: plot.zoom ? Number(plot.zoom) : 17,
        title: plot.Id || plot.title || 'Działka',
        area: plot.pow_dzialki_m2_uldk || plot.area || plot.areaM2
      };

      if (window.google?.maps && typeof window.initPropertyMap === 'function') {
        window.initPropertyMap();
      }
    }

    window.initPropertyMap = function initPropertyMap() {
      const ctx = window.__propertyPage;
      const mapContainer = document.getElementById('propertyMap');
      if (!mapContainer || !window.google?.maps || !ctx?.mapData) return;

      if (!ctx.mapInstance) {
        ctx.mapInstance = new google.maps.Map(mapContainer, {
          center: ctx.mapData.center || { lat: 52.0, lng: 19.0 },
          zoom: ctx.mapData.center ? ctx.mapData.zoom : 6,
          mapTypeId: google.maps.MapTypeId.HYBRID,
          gestureHandling: 'greedy'
        });
      } else if (ctx.mapData.center) {
        ctx.mapInstance.setCenter(ctx.mapData.center);
        ctx.mapInstance.setZoom(ctx.mapData.zoom || 17);
      }

      const map = ctx.mapInstance;
      if (ctx.marker) {
        ctx.marker.setMap(null);
        ctx.marker = null;
      }
      if (ctx.mapData.center) {
        ctx.marker = new google.maps.Marker({
          position: ctx.mapData.center,
          map,
          title: ctx.mapData.title || 'Działka'
        });
      }

      if (ctx.polygon) {
        ctx.polygon.setMap(null);
        ctx.polygon = null;
      }
      if (ctx.mapData.coords?.length) {
        ctx.polygon = new google.maps.Polygon({
          paths: ctx.mapData.coords,
          strokeColor: '#1e6fba',
          strokeOpacity: 0.9,
          strokeWeight: 3,
          fillColor: '#1e6fba',
          fillOpacity: 0.18,
          map
        });
        const bounds = new google.maps.LatLngBounds();
        ctx.mapData.coords.forEach(c => bounds.extend(c));
        map.fitBounds(bounds, 60);
      }

      applyMapMode(ctx.activeMode || 'base');
    };

    function createWmsOverlay(url, layerName, opacity = 0.6) {
      return new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
          const proj = window.__propertyPage.mapInstance.getProjection();
          const zfactor = Math.pow(2, zoom);
          const ul = proj.fromPointToLatLng(new google.maps.Point(coord.x * 256 / zfactor, coord.y * 256 / zfactor));
          const lr = proj.fromPointToLatLng(new google.maps.Point((coord.x + 1) * 256 / zfactor, (coord.y + 1) * 256 / zfactor));
          const bbox = `${ul.lng()},${lr.lat()},${lr.lng()},${ul.lat()}`;
          return `${url}?service=WMS&version=1.1.1&request=GetMap&layers=${layerName}&styles=&bbox=${bbox}&width=256&height=256&srs=EPSG:4326&format=image/png&transparent=true`;
        },
        tileSize: new google.maps.Size(256, 256),
        opacity,
        name: layerName
      });
    }

    function applyMapMode(mode) {
      const ctx = window.__propertyPage;
      if (!ctx) return;
      ctx.activeMode = mode;

      mapModeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));

      if (!ctx.mapInstance) return;
      ctx.mapInstance.overlayMapTypes.clear();

      if (mode === 'mpzp') {
        if (!ctx.overlays.mpzp && window.google?.maps) {
          ctx.overlays.mpzp = createWmsOverlay('https://mapy.geoportal.gov.pl/wss/service/pub/guest/G2_UPZP/MapServer/WMSServer', '0');
        }
        if (ctx.overlays.mpzp) ctx.mapInstance.overlayMapTypes.push(ctx.overlays.mpzp);
      } else if (mode === 'studium') {
        if (!ctx.overlays.studium && window.google?.maps) {
          ctx.overlays.studium = createWmsOverlay('https://mapy.geoportal.gov.pl/wss/service/pub/guest/G2_SUIPP/MapServer/WMSServer', '0', 0.55);
        }
        if (ctx.overlays.studium) ctx.mapInstance.overlayMapTypes.push(ctx.overlays.studium);
      }
    }

    mapModeButtons.forEach(btn => {
      btn.addEventListener('click', () => applyMapMode(btn.dataset.mode));
    });

    function renderPlanInfo(offer, plot) {
      const plan = plot.plan || plot.mpzp || offer?.plan || {};
      const designation = plan.designation || plan.przeznaczenie || plot.mpzp_przeznaczenie || 'Brak informacji';
      const height = plan.maxHeight || plan.wysokosc || plan.wysokość || '—';
      const intensity = plan.intensity || plan.intensywnosc || plan.intensywność || '—';
      const green = plan.green || plan.bio || plan.powierzchniaBiologicznieCzynna || '—';
      const notes = plan.notes || plan.opis || plot.planOpis || offer?.planNotes;
      const badges = [];
      if (plan.type) badges.push(plan.type);
      if (plan.symbol) badges.push(plan.symbol);
      if (!badges.length && designation && designation !== 'Brak informacji') badges.push('MPZP');
      if (!badges.length && (offer?.studium || plan.studium)) badges.push('Studium');

      document.getElementById('planDesignation').textContent = designation;
      document.getElementById('planHeight').textContent = height;
      document.getElementById('planIntensity').textContent = intensity;
      document.getElementById('planGreen').textContent = green;
      document.getElementById('planNotes').textContent = notes || 'Dodaj notatki dotyczące przeznaczenia terenu i ograniczeń zabudowy.';

      if (editPlanTypeInput) editPlanTypeInput.value = plan.type || '';
      if (editPlanSymbolInput) editPlanSymbolInput.value = plan.symbol || '';
      if (editPlanDesignationInput) editPlanDesignationInput.value = designation === 'Brak informacji' ? '' : designation;
      if (editPlanHeightInput) editPlanHeightInput.value = height === '—' ? '' : height;
      if (editPlanIntensityInput) editPlanIntensityInput.value = intensity === '—' ? '' : intensity;
      if (editPlanGreenInput) editPlanGreenInput.value = green === '—' ? '' : green;
      if (editPlanNotesInput) editPlanNotesInput.value = notes || '';

      const badgesWrap = document.getElementById('planBadges');
      badgesWrap.innerHTML = '';
      (badges.length ? badges : ['Brak MPZP - obowiązuje Studium']).forEach(item => {
        const el = document.createElement('span');
        el.className = 'plan-badge';
        el.textContent = item;
        badgesWrap.appendChild(el);
      });
    }

    function renderBasics(offer, plot) {
      const title = plot.title || plot.Id || offer.title || 'Oferta działki';
      document.getElementById('propertyTitle').textContent = title;
      if (editTitleInput) editTitleInput.value = title;

      const city = plot.city || offer.city || offer.location?.city || 'Polska';
      const municipality = plot.municipality || offer.location?.gmina || '';
      const voivodeship = plot.voivodeship || offer.location?.voivodeship || '';
      const locationParts = [city, municipality, voivodeship].filter(Boolean);
      document.getElementById('propertyLocation').textContent = locationParts.join(', ') || city;
      if (editCityInput) editCityInput.value = plot.city || offer.city || '';
      if (editMunicipalityInput) editMunicipalityInput.value = municipality;
      if (editVoivodeshipInput) editVoivodeshipInput.value = voivodeship;

      const area = Number(plot.pow_dzialki_m2_uldk || plot.area || plot.areaM2 || offer.area || 0);
      const areaText = area ? `${formatNumber(area)} m²` : '—';
      document.getElementById('propertyArea').textContent = areaText;
      document.getElementById('plotAreaStat').textContent = areaText;
      if (editAreaInput) editAreaInput.value = area ? String(area) : '';

      const type = plot.plotType || plot.type || plot.category || offer.category || 'Brak danych';
      document.getElementById('propertyType').textContent = type;
      if (editPlotTypeInput) editPlotTypeInput.value = type === 'Brak danych' ? '' : type;

      const ownership = plot.ownershipStatus || plot.ownership || offer.ownership || 'Brak informacji';
      document.getElementById('ownershipStatus').textContent = ownership;
      if (editOwnershipInput) editOwnershipInput.value = ownership === 'Brak informacji' ? '' : ownership;

      const status = plot.status || offer.status || 'Aktywna';
      document.getElementById('plotStatus').textContent = status;
      if (editPlotStatusInput) editPlotStatusInput.value = status;

      const plotNumber = plot.Id || plot.idDzialki_uldk || plot.number || '';
      document.getElementById('plotNumber').textContent = plotNumber || '—';
      if (editPlotNumberInput) editPlotNumberInput.value = plotNumber;

      const kw = plot.landRegister || plot.kw || plot.kwNumber || offer.landRegister || '';
      document.getElementById('landRegister').textContent = kw || '—';
      if (editLandRegisterInput) editLandRegisterInput.value = kw;

      const addressParts = [plot.street || offer.location?.street, city, plot.postalCode || offer.location?.postalCode, voivodeship];
      const address = plot.address || offer.address || addressParts.filter(Boolean).join(', ');
      document.getElementById('locationAddress').textContent = address || 'Dodaj adres działki';
      if (editAddressInput) editAddressInput.value = address || '';

      const access = plot.access || plot.roadAccess || offer.access || offer.accessDescription || '';
      document.getElementById('locationAccess').textContent = access || 'Opisz dojazd do działki oraz okoliczne udogodnienia.';
      if (editAccessInput) editAccessInput.value = access;

      const description = plot.description || offer.description || '';
      setDescriptionText(description);
      if (editDescriptionInput) editDescriptionInput.value = description;

      const tags = [];
      if (Array.isArray(plot.tags)) tags.push(...plot.tags);
      if (Array.isArray(offer.tags)) tags.push(...offer.tags);
      renderTags(tags);
      if (editTagsInput) editTagsInput.value = state.tags.join(', ');

      const utilities = plot.utilities || offer.utilities || plot.media || offer.media || {};
      renderUtilities(utilities);

      const price = plot.price ?? offer.price ?? '';
      if (editPriceInput) editPriceInput.value = price ? String(price) : '';
      updatePriceSummary(price, area);

      const updatedAt = plot.updatedAt || offer.updatedAt;
      if (updatedAt) {
        const date = updatedAt.toDate ? updatedAt.toDate() : new Date(updatedAt);
        priceUpdatedAt.textContent = `Aktualizacja: ${date.toLocaleDateString('pl-PL')}`;
      } else {
        priceUpdatedAt.textContent = 'Aktualizacja: —';
      }

      renderPlanInfo(offer, plot);
      updateMapData(plot);
      updateContactSection(offer);

      if (editContactNameInput) {
        editContactNameInput.value = offer.contactName || offer.owner || offer.firstName || '';
      }
      if (editContactPhoneInput) {
        editContactPhoneInput.value = offer.contactPhone || offer.phone || '';
      }
      if (editContactEmailInput) {
        editContactEmailInput.value = offer.contactEmail || offer.email || '';
      }
    }

    function updateContactSection(offer) {
      const name = offer.owner || offer.firstName || offer.contactName || 'Właściciel';
      const phone = offer.phone || offer.contactPhone || '';
      const email = offer.email || offer.contactEmail || '';
      document.getElementById('contactName').textContent = name;

      const phoneLink = document.getElementById('contactPhoneLink');
      const formattedPhone = formatPhone(phone);
      if (phone) {
        phoneLink.textContent = formattedPhone;
        phoneLink.href = `tel:${phone.replace(/\s/g, '')}`;
      } else {
        phoneLink.textContent = 'Brak numeru';
        phoneLink.href = '#';
      }

      const emailLink = document.getElementById('contactEmailLink');
      if (email) {
        emailLink.textContent = email;
        emailLink.href = `mailto:${email}`;
      } else {
        emailLink.textContent = 'Brak adresu';
        emailLink.href = '#';
      }
    }

    contactForm?.addEventListener('submit', (event) => {
      event.preventDefault();
      showToast('Wiadomość została zapisana lokalnie. Skontaktujemy się z Tobą wkrótce.', 'success');
      contactForm.reset();
    });

    contactCTA?.addEventListener('click', () => {
      document.getElementById('inqMessage')?.focus();
      showToast('Wypełnij formularz, aby przesłać zapytanie.', 'info');
    });

    const FAVORITES_KEY = 'savedPlots';
    try {
      const stored = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
      state.favorites = new Set(Array.isArray(stored) ? stored : []);
    } catch (_) {
      state.favorites = new Set();
    }

    function favoriteKey(id, index) {
      return `${id}__${index}`;
    }

    function updateFavoriteButton() {
      if (!state.offerId) return;
      const key = favoriteKey(state.offerId, state.plotIndex);
      const saved = state.favorites.has(key);
      savePlotBtn.classList.toggle('btn-secondary', !saved);
      savePlotBtn.classList.toggle('btn-accent', saved);
      savePlotBtn.innerHTML = saved
        ? '<i class="fas fa-bookmark"></i> Zapisano'
        : '<i class="fas fa-bookmark"></i> Zapisz działkę';
    }

    savePlotBtn?.addEventListener('click', () => {
      if (!state.offerId) return;
      const key = favoriteKey(state.offerId, state.plotIndex);
      if (state.favorites.has(key)) {
        state.favorites.delete(key);
        showToast('Usunięto działkę z zapisanych.', 'info');
      } else {
        state.favorites.add(key);
        showToast('Dodano działkę do zapisanych.', 'success');
      }
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(state.favorites)));
      updateFavoriteButton();
    });

    editToggleBtn?.addEventListener('click', () => {
      if (!state.isOwner) {
        showToast('Tylko właściciel ogłoszenia może je edytować.', 'warning');
        return;
      }
      state.editMode = true;
      refreshEditPermissions();
      showToast('Tryb edycji aktywny. Wprowadź zmiany i zapisz.', 'info');
    });

    cancelEditBtn?.addEventListener('click', () => {
      if (!state.editMode) return;
      state.editMode = false;
      if (state.offerData && state.plotData) {
        renderBasics(state.offerData, state.plotData);
      }
      refreshEditPermissions();
      showToast('Anulowano zmiany.', 'info');
    });

    async function saveChanges() {
      if (!state.isOwner || !state.editMode) {
        showToast('Brak uprawnień do zapisu zmian.', 'warning');
        return;
      }
      if (!state.offerId || !state.offerData || !Array.isArray(state.offerData.plots)) {
        showToast('Nie znaleziono danych oferty do zapisania.', 'error');
        return;
      }
      if (state.plotIndex < 0 || state.plotIndex >= state.offerData.plots.length) {
        showToast('Nie znaleziono tej działki w ofercie.', 'error');
        return;
      }

      const invalidField = editFields.find(field => field
        && !field.disabled
        && typeof field.checkValidity === 'function'
        && !field.checkValidity());
      if (invalidField) {
        invalidField.reportValidity?.();
        invalidField.focus?.();
        return;
      }

      const priceValue = parseNumberField(editPriceInput);
      const areaValue = parseNumberField(editAreaInput);
      const description = (editDescriptionInput?.value || '').trim();
      const tagsToSave = editTagsInput ? parseTagsInputValue(editTagsInput.value) : [...state.tags];
      const utilities = collectUtilities();
      const title = (editTitleInput?.value || '').trim();
      const plotNumber = (editPlotNumberInput?.value || '').trim();
      const kw = (editLandRegisterInput?.value || '').trim();
      const plotType = (editPlotTypeInput?.value || '').trim();
      const ownership = (editOwnershipInput?.value || '').trim();
      const status = (editPlotStatusInput?.value || '').trim();
      const city = (editCityInput?.value || '').trim();
      const municipality = (editMunicipalityInput?.value || '').trim();
      const voivodeship = (editVoivodeshipInput?.value || '').trim();
      const address = (editAddressInput?.value || '').trim();
      const access = (editAccessInput?.value || '').trim();
      const planType = (editPlanTypeInput?.value || '').trim();
      const planSymbol = (editPlanSymbolInput?.value || '').trim();
      const planDesignation = (editPlanDesignationInput?.value || '').trim();
      const planHeight = (editPlanHeightInput?.value || '').trim();
      const planIntensity = (editPlanIntensityInput?.value || '').trim();
      const planGreen = (editPlanGreenInput?.value || '').trim();
      const planNotes = (editPlanNotesInput?.value || '').trim();
      const contactName = (editContactNameInput?.value || '').trim();
      const contactPhone = (editContactPhoneInput?.value || '').trim();
      const contactEmail = (editContactEmailInput?.value || '').trim();

      const now = Timestamp.now();

      const plots = state.offerData.plots.map(plot => ({ ...(plot || {}) }));
      const currentPlot = { ...(plots[state.plotIndex] || {}) };

      const updatedPlan = {
        ...(currentPlot.plan || {}),
        type: planType || null,
        symbol: planSymbol || null,
        designation: planDesignation || null,
        maxHeight: planHeight || null,
        intensity: planIntensity || null,
        green: planGreen || null,
        notes: planNotes || null
      };

      const updatedPlot = {
        ...currentPlot,
        title: title || currentPlot.title || null,
        price: priceValue ?? null,
        currency: DISPLAY_CURRENCY,
        area: areaValue ?? currentPlot.area ?? null,
        areaM2: areaValue ?? currentPlot.areaM2 ?? null,
        pow_dzialki_m2_uldk: areaValue ?? currentPlot.pow_dzialki_m2_uldk ?? null,
        plotType: plotType || currentPlot.plotType || null,
        type: plotType || currentPlot.type || null,
        ownershipStatus: ownership || currentPlot.ownershipStatus || null,
        ownership: ownership || currentPlot.ownership || null,
        status: status || currentPlot.status || null,
        number: plotNumber || currentPlot.number || null,
        Id: plotNumber || currentPlot.Id || null,
        idDzialki_uldk: plotNumber || currentPlot.idDzialki_uldk || null,
        landRegister: kw || currentPlot.landRegister || null,
        kw: kw || currentPlot.kw || null,
        kwNumber: kw || currentPlot.kwNumber || null,
        city: city || currentPlot.city || null,
        municipality: municipality || currentPlot.municipality || null,
        voivodeship: voivodeship || currentPlot.voivodeship || null,
        address: address || currentPlot.address || null,
        access: access || currentPlot.access || null,
        description: description || null,
        tags: tagsToSave,
        utilities,
        plan: updatedPlan,
        updatedAt: now
      };

      plots[state.plotIndex] = updatedPlot;

      const locationPayload = {
        ...(state.offerData.location || {}),
        city: city || null,
        municipality: municipality || null,
        voivodeship: voivodeship || null,
        street: address || null,
        access: access || null
      };

      const payload = {
        plots,
        updatedAt: now,
        title: title || state.offerData.title || null,
        price: priceValue ?? state.offerData.price ?? null,
        currency: DISPLAY_CURRENCY,
        description: description || null,
        tags: tagsToSave,
        utilities,
        area: areaValue ?? state.offerData.area ?? null,
        city: city || null,
        municipality: municipality || null,
        voivodeship: voivodeship || null,
        address: address || null,
        access: access || null,
        location: locationPayload,
        plan: updatedPlan,
        contactName: contactName || null,
        contactPhone: contactPhone || null,
        contactEmail: contactEmail || null,
        owner: contactName || state.offerData.owner || null,
        phone: contactPhone || state.offerData.phone || null,
        email: contactEmail || state.offerData.email || null,
        lastEditorUid: state.currentUser?.uid || null,
        lastEditedAt: now
      };

      try {
        state.saving = true;
        applyEditingState();
        updateEditButtons();

        const ref = doc(db, 'propertyListings', state.offerId);
        await updateDoc(ref, payload);

        state.offerData = {
          ...state.offerData,
          ...payload,
          location: locationPayload,
          plan: updatedPlan,
          contactName: contactName || null,
          contactPhone: contactPhone || null,
          contactEmail: contactEmail || null,
          owner: contactName || state.offerData.owner || null,
          phone: contactPhone || state.offerData.phone || null,
          email: contactEmail || state.offerData.email || null,
          plots
        };
        state.plotData = updatedPlot;
        state.tags = [...tagsToSave];
        state.editMode = false;
        renderBasics(state.offerData, state.plotData);
        showToast('Zmiany zapisane w bazie.', 'success');
      } catch (error) {
        console.error(error);
        showToast('Nie udało się zapisać zmian: ' + (error?.message || ''), 'error');
      } finally {
        state.saving = false;
        refreshEditPermissions();
      }
    }

    saveChangesBtn?.addEventListener('click', saveChanges);

    async function loadOfferDetails() {
      if (!offerId) {
        showError('Brak identyfikatora oferty.');
        return;
      }
      try {
        const ref = doc(db, 'propertyListings', offerId);
        const snapshot = await getDoc(ref);
        if (!snapshot.exists()) {
          showError('Nie znaleziono wskazanej oferty.');
          return;
        }
        const offer = snapshot.data();
        const plots = Array.isArray(offer.plots)
          ? offer.plots
              .map((plot, originalIndex) => ({ plot, originalIndex }))
              .filter(({ plot }) => plot?.mock !== false)
          : [];
        if (!plots.length) {
          showError('Oferta nie posiada aktywnych działek.');
          return;
        }
        const selected = plots.find(p => p.originalIndex === state.plotIndex) || plots[0];
        state.offerData = offer;
        state.plotData = selected.plot;
        state.plotIndex = selected.originalIndex;
        toggleState(true);
        renderBasics(offer, selected.plot);
        refreshEditPermissions();
        updateFavoriteButton();
      } catch (error) {
        console.error(error);
        showError('Wystąpił problem podczas pobierania danych.');
      }
    }

    await loadOfferDetails();

    function setupAuthUI() {
      const authButtons = document.getElementById('authButtons');
      const userMenu = document.getElementById('userMenu');
      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const accountBtn = document.getElementById('accountBtn');
      const loginModal = document.getElementById('loginModal');
      const registerModal = document.getElementById('registerModal');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const closeBtns = document.querySelectorAll('.modal-close');
      const switchToRegister = document.getElementById('switchToRegister');
      const switchToLogin = document.getElementById('switchToLogin');
      const googleLoginBtn = document.getElementById('googleLoginBtn');
      const googleLoginBtnLogin = document.getElementById('googleLoginBtnLogin');
      const domainWarning = document.getElementById('domainWarning');

      const allowedDomains = ['localhost', '127.0.0.1', 'trainingtwenty5.github.io', 'twojadomena.pl'];
      if (domainWarning && !allowedDomains.includes(window.location.hostname)) {
        domainWarning.style.display = 'block';
      }

      const openModal = (modal) => modal && (modal.style.display = 'flex');
      const closeModal = (modal) => modal && (modal.style.display = 'none');

      loginBtn?.addEventListener('click', () => openModal(loginModal));
      registerBtn?.addEventListener('click', () => openModal(registerModal));
      closeBtns.forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
      window.addEventListener('click', (event) => {
        if (event.target.classList?.contains('modal')) closeModal(event.target);
      });

      switchToRegister?.addEventListener('click', (event) => {
        event.preventDefault();
        closeModal(loginModal);
        openModal(registerModal);
      });
      switchToLogin?.addEventListener('click', (event) => {
        event.preventDefault();
        closeModal(registerModal);
        openModal(loginModal);
      });

      const provider = new GoogleAuthProvider();

      async function loginWithGoogle() {
        try {
          await signInWithPopup(auth, provider);
          showToast('Zalogowano przez Google.', 'success');
          closeModal(loginModal);
          closeModal(registerModal);
        } catch (error) {
          showToast(error.message || 'Nie udało się zalogować przez Google.', 'error');
        }
      }

      googleLoginBtn?.addEventListener('click', loginWithGoogle);
      googleLoginBtnLogin?.addEventListener('click', loginWithGoogle);

      loginForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
          showToast('Zalogowano pomyślnie.', 'success');
          closeModal(loginModal);
        } catch (error) {
          showToast('Logowanie nieudane: ' + (error?.message || ''), 'error');
        }
      });

      registerForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        const confirm = document.getElementById('registerConfirmPassword').value;
        if (password !== confirm) {
          showToast('Hasła nie są identyczne.', 'warning');
          return;
        }
        try {
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          if (name) await updateProfile(userCred.user, { displayName: name });
          showToast('Konto utworzono pomyślnie.', 'success');
          closeModal(registerModal);
        } catch (error) {
          showToast('Rejestracja nie powiodła się: ' + (error?.message || ''), 'error');
        }
      });

      logoutBtn?.addEventListener('click', async () => {
        try {
          await signOut(auth);
          showToast('Wylogowano.', 'info');
        } catch (error) {
          console.error(error);
        }
      });

      onAuthStateChanged(auth, (user) => {
        const mobileAuth = document.getElementById('mobileAuth');
        state.currentUser = user;
        if (user) {
          authButtons.style.display = 'none';
          userMenu.style.display = 'flex';
          const label = user.displayName ? user.displayName.split(' ')[0] : (user.email || 'Użytkownik');
          if (accountBtn) accountBtn.textContent = label;
          if (mobileAuth) {
            mobileAuth.innerHTML = `
              <div class="nav-link" style="font-weight:600;">
                <i class="fas fa-user"></i> ${label}
              </div>
              <button class="btn btn-secondary" id="mobileLogoutBtn" style="width:100%;">
                <i class="fas fa-sign-out-alt"></i> Wyloguj się
              </button>
            `;
            document.getElementById('mobileLogoutBtn')?.addEventListener('click', async () => {
              await signOut(auth);
              mobileAuth.style.display = 'none';
            });
          }
        } else {
          authButtons.style.display = 'flex';
          userMenu.style.display = 'none';
          if (accountBtn) accountBtn.textContent = 'Moje konto';
          if (mobileAuth) {
            mobileAuth.innerHTML = `
              <a href="#" id="mobileLoginLink" class="nav-link">Zaloguj się</a>
              <a href="#" id="mobileRegisterLink" class="nav-link">Zarejestruj się</a>
            `;
            mobileAuth.querySelector('#mobileLoginLink')?.addEventListener('click', (e) => {
              e.preventDefault();
              openModal(loginModal);
            });
            mobileAuth.querySelector('#mobileRegisterLink')?.addEventListener('click', (e) => {
              e.preventDefault();
              openModal(registerModal);
            });
          }
        }
        refreshEditPermissions();
      });
    }

    setupAuthUI();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pl">
<head>
  <!-- Google tag (gtag.js) i Hotjar są inicjowane po akceptacji cookies w assets/cookies.js -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grunteo - Oferty działek na sprzedaż</title>
  <meta name="description" content="Przeglądaj aktualne oferty działek budowlanych, rolnych i inwestycyjnych z całej Polski na platformie Grunteo." />
  <meta name="keywords" content="działki,oferty,grunty,sprzedaż,wynajem,Polska,nieruchomości,inwestycja,budowlane,rolne" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://grunteo.pl/oferty" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <link rel="icon" type="image/svg+xml" href="https://grunteo.pl/brand/logo-mark.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://grunteo.pl/brand/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://grunteo.pl/brand/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://grunteo.pl/brand/favicon-16x16.png" />
  <link rel="manifest" href="https://grunteo.pl/brand/site.webmanifest" />
  <link rel="mask-icon" href="https://grunteo.pl/brand/safari-pinned-tab.svg" color="#0c0d11" />
  <link rel="shortcut icon" href="https://grunteo.pl/brand/favicon.ico" />
  <meta name="apple-mobile-web-app-title" content="Grunteo" />
  <meta name="application-name" content="Grunteo" />
  <meta name="msapplication-TileColor" content="#0c0d11" />
  <meta name="msapplication-config" content="https://grunteo.pl/brand/browserconfig.xml" />
  <meta name="theme-color" content="#0c0d11" />
  <meta property="og:image" content="https://grunteo.pl/brand/og-image.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="Logo Grunteo" />
  <meta property="og:title" content="Grunteo - Oferty działek na sprzedaż" />
  <meta property="og:description" content="Odkryj najnowsze ogłoszenia działek z całego kraju i znajdź grunt dopasowany do Twoich potrzeb." />
  <meta property="og:url" content="https://grunteo.pl/oferty" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://grunteo.pl/brand/og-image.png" />
  <meta name="twitter:title" content="Grunteo - Oferty działek na sprzedaż" />
  <meta name="twitter:description" content="Przeglądaj aktualne oferty działek w całej Polsce i filtruj ogłoszenia według swoich kryteriów." />
  <link rel="stylesheet" href="assets/main.css" />
  <link rel="stylesheet" href="assets/header.css" />
  <link rel="stylesheet" href="assets/oferty.css" />
  <script src="assets/offers-cache-config.js"></script>
  <!-- Google tag (gtag.js) -->
  <script type="text/plain" data-cookie-consent="analytics" data-cookie-src="https://www.googletagmanager.com/gtag/js?id=G-VH07LRZ8GK" data-cookie-async="true"></script>
  <script type="text/plain" data-cookie-consent="analytics">
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-VH07LRZ8GK', { 'anonymize_ip': true });
  </script>

  <!-- Hotjar Tracking Code for grunteo.pl -->
  <script type="text/plain" data-cookie-consent="analytics">
    (function(h,o,t,j,a,r){
      h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments);};
      h._hjSettings={hjid:6523622,hjsv:6};
      a=o.getElementsByTagName('head')[0];
      r=o.createElement('script');r.async=1;
      r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
      a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>

</head>
<body>
  <div class="top-navbar">
    <div class="contact-info">
      <i class="fas fa-clock"></i> Poniedziałek - Piątek 9:00 - 18:00
      <span><i class="fas fa-phone"></i> +48 505 849 404</span>
    </div>

    <div class="auth-buttons" id="authButtons">
      <button class="btn btn-outline-primary btn-sm" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i> Zaloguj się
      </button>
      <button class="btn btn-primary btn-sm" id="registerBtn">
        <i class="fas fa-user-plus"></i> Zarejestruj się
      </button>
    </div>

    <div class="user-menu" id="userMenu" style="display:none;">
      <button class="btn btn-outline-primary btn-sm" id="accountBtn">
        <i class="fas fa-user"></i> Moje konto
      </button>

      <button class="btn btn-secondary btn-sm" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Wyloguj
      </button>
    </div>
  </div>

  <header>
    <a href="index.html" class="logo">
      <img src="https://grunteo.pl/brand/logo-horizontal-dark.svg" alt="Logo serwisu">
    </a>

    <nav class="desktop-nav">
      <a href="index.html" class="nav-link">Strona główna</a>
      <a href="oferty.html" class="nav-link active">Oferty</a>
      <a href="dodaj.html" class="nav-link">Dodaj</a>
      <a href="Kontakt.html" class="nav-link">Kontakt</a>
    </nav>

    <a href="dodaj.html" class="desktop-add-offer">
      <i class="fas fa-plus"></i> Dodaj ofertę
    </a>
    <a href="dodaj.html" class="mobile-add-offer">
      <i class="fas fa-plus"></i> Dodaj ofertę
    </a>

    <button class="mobile-menu-btn" aria-label="Otwórz menu">
      <i class="fas fa-bars"></i>
    </button>

    <nav class="nav-menu">
      <a href="index.html" class="nav-link">Strona główna</a>
      <a href="oferty.html" class="nav-link active">Oferty</a>
      <a href="dodaj.html" class="nav-link">Dodaj</a>
      <a href="Kontakt.html" class="nav-link">Kontakt</a>
      <a href="index.html#userMenu" class="nav-link">Moje konto</a>

      <!-- Miejsce na elementy auth w menu mobilnym -->
      <div class="mobile-auth" id="mobileAuth" style="display:none;"></div>
    </nav>
  </header>


<!-- Toasts -->
<div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
<!-- Confirm Modal -->
<div class="confirm-modal" id="confirmModal" role="dialog" aria-modal="true">
  <div class="confirm-box">
    <h3 class="confirm-title">Potwierdzenie</h3>
    <p class="confirm-message"></p>
    <div class="confirm-actions">
      <button class="confirm-btn confirm-cancel">Anuluj</button>
      <button class="confirm-btn confirm-yes">Usuń</button>
    </div>
  </div>
</div>
<script>
/* ===== UI: TOAST (vanilla) =====
   showToast('Oferta „...” została usunięta.', 'success')
   type: 'info' | 'success' | 'warning' | 'error'
*/
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  if (!container) return;

  const wrap = document.createElement('div');
  wrap.className = `toast-lite toast-${type}`;
  wrap.setAttribute('role', 'status');
  wrap.setAttribute('aria-live', 'polite');

  // dobierz ikonę
  const icon = {
    success: '✓',
    info: 'ℹ',
    warning: '!',
    error: '✕'
  }[type] || 'ℹ';

  wrap.innerHTML = `
    <div class="toast-icon" aria-hidden="true">${icon}</div>
    <div class="toast-msg">${message}</div>
    <button class="toast-close" aria-label="Zamknij">&times;</button>
  `;

  // zamykanie
  const close = () => {
    wrap.classList.remove('show');
    setTimeout(() => wrap.remove(), 160);
  };
  wrap.querySelector('.toast-close').addEventListener('click', close);

  // dodaj + animacja wejścia
  container.appendChild(wrap);
  requestAnimationFrame(() => wrap.classList.add('show'));

  // auto-hide po 4s
  const t = setTimeout(close, 4000);
  // jeśli użytkownik najedzie, nie chowaj
  wrap.addEventListener('mouseenter', () => clearTimeout(t), { once: true });
}
</script>

<!-- Confirm Modal Script -->
<script>
function showConfirmModal(message) {
  return new Promise(resolve => {
    const modal = document.getElementById('confirmModal');
    if (!modal) return resolve(false);

    modal.querySelector('.confirm-message').textContent = message;
    modal.classList.add('show');

    const yesBtn = modal.querySelector('.confirm-yes');
    const cancelBtn = modal.querySelector('.confirm-cancel');

    const cleanup = () => {
      modal.classList.remove('show');
      yesBtn.removeEventListener('click', onYes);
      cancelBtn.removeEventListener('click', onCancel);
      modal.removeEventListener('click', onOutside);
    };

    const onYes = () => { cleanup(); resolve(true); };
    const onCancel = () => { cleanup(); resolve(false); };
    const onOutside = (e) => { if (e.target === modal) { cleanup(); resolve(false); } };

    yesBtn.addEventListener('click', onYes, { once: true });
    cancelBtn.addEventListener('click', onCancel, { once: true });
    modal.addEventListener('click', onOutside, { once: true });
  });
}
window.showConfirmModal = showConfirmModal;
</script>


  <!-- ===== GŁÓWNY UKŁAD Z MAPĄ I ZAWARTOŚCIĄ ===== -->
  <div class="main-layout">
    <!-- Lewa strona - statyczna mapa -->
    <div class="map-container">
      <div id="map"></div>
    </div>
    
    <!-- Prawa strona - przewijana zawartość -->
    <div class="content-container">
      <!-- Panel filtrów ofert -->
      <div class="filters-panel" id="filtersPanel">
        <h3 class="filters-title">Filtruj działki</h3>
        <div class="filters-row sort-row">
          <span class="filters-label">Sortuj:</span>
          <div class="sort-buttons">
            <button type="button" class="sort-chip" data-sort-key="price" aria-pressed="false">
              Cena
            </button>
            <button type="button" class="sort-chip" data-sort-key="area" aria-pressed="false">
              Powierzchnia
            </button>
          </div>
        </div>
        <div class="filters-row tags-row">
          <span class="filters-label">Tagi:</span>
          <div class="tags-area">
            <div class="tags-wrapper" id="tagFiltersList" data-expanded="false">
              <span class="tag-placeholder">Ładuję tagi…</span>
            </div>
            <button type="button" class="toggle-tags-btn" id="toggleTagsBtn" aria-expanded="false" aria-controls="tagFiltersList" hidden>
              Pokaż wszystkie tagi
            </button>
          </div>
        </div>
      </div>
      <!-- Panel z ofertami publicznymi -->
      <div class="offers-section">
        <div class="section-title">
          <h2>Oferty działek</h2>
        </div>
        <div class="offers-list" id="offersList"></div>
      </div>
      
      <!-- Panel z Twoimi ofertami -->
      <div class="offers-section">
        <div class="section-title">
          <h2>Moje Oferty</h2>
        </div>
        <div id="userDashboard">
          <div class="offers-grid" id="userOffers"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Zaloguj się</h3>
        <button class="modal-close" aria-label="Zamknij">&times;</button>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Hasło</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Zaloguj się</button>
      </form>

      <div class="social-login">
        <button type="button" class="btn btn-google" id="googleLoginBtnLogin">
          <i class="fab fa-google"></i> Kontynuuj z Google
        </button>
      </div>

      <div class="form-footer">
        <p>Nie masz konta? <a href="#" id="switchToRegister">Zarejestruj się</a></p>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Utwórz konto</h3>
        <button class="modal-close" aria-label="Zamknij">&times;</button>
      </div>
      <form id="registerForm">
        <div class="form-group">
          <label for="registerName">Imię i nazwisko</label>
          <input type="text" id="registerName" required>
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">Hasło</label>
          <input type="password" id="registerPassword" required>
        </div>
        <div class="form-group">
          <label for="registerConfirmPassword">Potwierdź hasło</label>
          <input type="password" id="registerConfirmPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Zarejestruj się</button>
      </form>

      <div class="social-login mt-3 text-center">
        <button type="button" class="btn btn-google w-100 mb-2" id="googleLoginBtn">
          <i class="fab fa-google"></i> Kontynuuj z Google
        </button>
      </div>

      <div class="form-footer">
        <p>Masz już konto? <a href="#" id="switchToLogin">Zaloguj się</a></p>
      </div>
    </div>
  </div>

  <!-- Modal edycji -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edytuj ofertę</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editOfferId">
        <input type="hidden" id="editPlotIndex">
        
        <div class="form-group">
          <label for="editPlotId">Identyfikator działki</label>
          <input type="text" id="editPlotId" required>
        </div>
        
        <div class="form-group">
          <label for="editPrice">Cena całkowita (zł)</label>
          <input type="number" id="editPrice" required>
        </div>
        
        <div class="form-group">
          <label for="editPhone">Telefon kontaktowy</label>
          <input type="tel" id="editPhone" required>
        </div>
        
        <div class="form-group">
          <label for="editCity">Miejscowość</label>
          <input type="text" id="editCity" required>
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%;">Zaktualizuj ofertę</button>
      </form>
  </div>
</div>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
      authDomain: "base-468e0.firebaseapp.com",
      projectId: "base-468e0",
      storageBucket: "base-468e0.firebasestorage.app",
      messagingSenderId: "829161895559",
      appId: "1:829161895559:web:d832541aac05b35847ea22"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
  </script>











 <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
  let map;
  let markers = [];
  let markerCluster;
  let allOffers = [];
  let availableTags = [];
  let tagMetrics = new Map();
  const filterState = {
    sortKey: null,
    sortDir: 'asc',
    selectedTags: new Set()
  };
  let tagsExpanded = false;
  const TAG_PREVIEW_COUNT = 5;
  let randomPreviewTags = [];
  let randomPreviewSignature = '';
  let currentVisibleOffers = [];

  const MAP_STATE_STORAGE_KEY = 'grunteo::offers::mapState';
  const MAP_STATE_TTL_MS = 1000 * 60 * 60 * 12; // 12 godzin
  let pendingMapState = readStoredMapState();
  let mapStateViewApplied = false;

  function readStoredMapState() {
    if (typeof window === 'undefined' || !window.localStorage) return null;
    try {
      const raw = window.localStorage.getItem(MAP_STATE_STORAGE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== 'object') return null;
      const timestamp = Number(parsed.timestamp);
      if (Number.isFinite(timestamp) && MAP_STATE_TTL_MS > 0) {
        const age = Date.now() - timestamp;
        if (age > MAP_STATE_TTL_MS) {
          window.localStorage.removeItem(MAP_STATE_STORAGE_KEY);
          return null;
        }
      }
      return parsed;
    } catch (error) {
      console.warn('Nie udało się odczytać zapisanego stanu mapy ofert.', error);
      return null;
    }
  }

  function clearStoredMapState() {
    pendingMapState = null;
    try {
      window.localStorage?.removeItem(MAP_STATE_STORAGE_KEY);
    } catch (error) {
      console.warn('Nie udało się wyczyścić zapisanego stanu mapy ofert.', error);
    }
  }

  function saveMapState(extra = {}) {
    if (!map || typeof window === 'undefined' || !window.localStorage) return;
    const center = typeof map.getCenter === 'function' ? map.getCenter() : null;
    const lat = center && typeof center.lat === 'function' ? center.lat() : null;
    const lng = center && typeof center.lng === 'function' ? center.lng() : null;
    const zoom = typeof map.getZoom === 'function' ? map.getZoom() : null;

    const focusOfferId = typeof extra.focusOfferId === 'string' && extra.focusOfferId.trim()
      ? extra.focusOfferId.trim()
      : (typeof pendingMapState?.focusOfferId === 'string' ? pendingMapState.focusOfferId : null);
    const focusPlotIndex = Number.isInteger(extra.focusPlotIndex)
      ? extra.focusPlotIndex
      : (Number.isInteger(pendingMapState?.focusPlotIndex) ? pendingMapState.focusPlotIndex : null);

    const payload = {
      timestamp: Date.now(),
      center: Number.isFinite(lat) && Number.isFinite(lng) ? { lat, lng } : null,
      zoom: Number.isFinite(zoom) ? zoom : null,
      focusOfferId,
      focusPlotIndex
    };

    try {
      window.localStorage.setItem(MAP_STATE_STORAGE_KEY, JSON.stringify(payload));
      pendingMapState = payload;
    } catch (error) {
      console.warn('Nie udało się zapisać stanu mapy ofert.', error);
    }
  }

  function applySavedMapView() {
    if (!map || !pendingMapState || mapStateViewApplied) return;
    const { center, zoom, focusOfferId } = pendingMapState;
    const zoomValue = Number(zoom);
    if (Number.isFinite(zoomValue)) {
      map.setZoom(zoomValue);
    }
    if (center && Number.isFinite(center.lat) && Number.isFinite(center.lng)) {
      map.setCenter({ lat: center.lat, lng: center.lng });
    }
    mapStateViewApplied = true;
    if (!focusOfferId) {
      clearStoredMapState();
    }
  }

  function focusOfferFromMapState() {
    if (!map || !pendingMapState || !pendingMapState.focusOfferId) return;
    const { focusOfferId } = pendingMapState;
    const focusPlotIndex = Number.isInteger(pendingMapState.focusPlotIndex)
      ? pendingMapState.focusPlotIndex
      : null;

    const match = allOffers.find(entry => {
      if (!entry || entry.id !== focusOfferId) return false;
      if (focusPlotIndex === null) return true;
      return entry.index === focusPlotIndex;
    }) || allOffers.find(entry => entry && entry.id === focusOfferId);

    if (match) {
      let focusPosition = null;
      if (match.marker && typeof match.marker.getPosition === 'function') {
        focusPosition = match.marker.getPosition();
      } else if (match.plot && Number.isFinite(match.plot.lat) && Number.isFinite(match.plot.lng)) {
        focusPosition = { lat: match.plot.lat, lng: match.plot.lng };
      }

      const hasSavedCenter = pendingMapState?.center
        && Number.isFinite(pendingMapState.center.lat)
        && Number.isFinite(pendingMapState.center.lng);
      const shouldRespectSavedView = mapStateViewApplied && hasSavedCenter;

      try {
        if (focusPosition && typeof map.panTo === 'function' && !shouldRespectSavedView) {
          map.panTo(focusPosition);
        }
      } catch (error) {
        console.warn('Nie udało się przesunąć mapy do zapamiętanej oferty.', error);
      }

      const anchor = match.marker && typeof match.marker.getPosition === 'function'
        ? match.marker
        : focusPosition;
      openInfo(anchor, infoHTML(match.plot, match.data, match.id, match.index));
      document.querySelector('.map-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    clearStoredMapState();
  }

  document.addEventListener('click', (event) => {
    const link = event.target?.closest?.('a[data-preserve-map-state]');
    if (!link) return;
    const offerId = typeof link.dataset.offerId === 'string' ? link.dataset.offerId : null;
    const plotIndexRaw = link.dataset.plotIndex;
    const hasPlotIndex = plotIndexRaw !== undefined && plotIndexRaw !== '';
    const plotIndex = hasPlotIndex ? Number(plotIndexRaw) : null;
    saveMapState({
      focusOfferId: offerId || null,
      focusPlotIndex: Number.isInteger(plotIndex) ? plotIndex : null
    });
  }, true);

  const OFFERS_CACHE_KEY = typeof window !== 'undefined' && window.__OFFERS_CACHE_KEY__
    ? window.__OFFERS_CACHE_KEY__
    : 'grunteo::offers-cache::v1';

  const OFFERS_CACHE_SENSITIVE_FIELDS = ['userEmail', 'userUid'];

  function resolveOffersCacheSettings() {
    const revision = typeof window.__OFFERS_REVISION_HINT__ === 'string'
      ? window.__OFFERS_REVISION_HINT__.trim()
      : '';
    const ttlCandidate = Number(window.__OFFERS_CACHE_TTL_MS__);
    const ttlMs = Number.isFinite(ttlCandidate) && ttlCandidate > 0
      ? ttlCandidate
      : null; // brak ustawienia TTL wyłącza cache, jeśli config nie został załadowany
    return {
      revisionHint: revision || null,
      ttlMs
    };
  }

  function clearOffersCache() {
    try {
      window.localStorage?.removeItem(OFFERS_CACHE_KEY);
    } catch (_) {
      /* ignore */
    }
  }

  function cloneForCache(value) {
    try {
      return JSON.parse(JSON.stringify(value ?? null));
    } catch (error) {
      console.warn('Nie udało się sklonować danych oferty do cache:', error);
      return null;
    }
  }

  function getActivePlotEntries(rawPlots) {
    if (!Array.isArray(rawPlots)) return [];
    const result = [];
    rawPlots.forEach((plot, index) => {
      if (!plot || typeof plot !== 'object') return;
      if (plot.mock === false) return;

      const normalizedPlot = { ...plot };
      if (typeof normalizedPlot.mock === 'undefined') {
        normalizedPlot.mock = true;
      }

      const storedIndex = Number.isInteger(plot.__originalIndex)
        ? plot.__originalIndex
        : Number.isInteger(normalizedPlot.__originalIndex)
          ? normalizedPlot.__originalIndex
          : index;

      delete normalizedPlot.__originalIndex;

      result.push({
        plot: normalizedPlot,
        originalIndex: storedIndex
      });
    });
    return result;
  }

  function preparePlotsForCache(rawPlots) {
    return getActivePlotEntries(rawPlots)
      .map(({ plot, originalIndex }) => {
        const safePlot = cloneForCache(plot) || { ...plot };
        if (!safePlot || typeof safePlot !== 'object') {
          return null;
        }
        if (typeof safePlot.mock === 'undefined') {
          safePlot.mock = true;
        }
        safePlot.__originalIndex = originalIndex;
        return safePlot;
      })
      .filter(Boolean);
  }

  function sanitizeOfferDocumentForCache(doc) {
    if (!doc || typeof doc !== 'object') return null;

    const id = doc?.id || null;
    const rawData = doc?.data || {};
    const clonedData = cloneForCache(rawData) || { ...rawData };
    if (!clonedData || typeof clonedData !== 'object') {
      return null;
    }
    if (clonedData.mock === false) {
      return null;
    }

    OFFERS_CACHE_SENSITIVE_FIELDS.forEach((field) => {
      if (field in clonedData) {
        delete clonedData[field];
      }
    });

    const normalizedPlots = preparePlotsForCache(clonedData.plots);
    if (!normalizedPlots.length) {
      return null;
    }

    clonedData.plots = normalizedPlots;

    return {
      id,
      data: clonedData
    };
  }

  function readOffersCache(settings, { allowExpired = false } = {}) {
    if (!window.localStorage) {
      return null;
    }

    let raw = null;
    try {
      raw = window.localStorage.getItem(OFFERS_CACHE_KEY);
    } catch (error) {
      console.warn('Nie udało się odczytać cache ofert:', error);
      return null;
    }

    if (!raw) {
      return null;
    }

    let parsed;
    try {
      parsed = JSON.parse(raw);
    } catch (error) {
      console.warn('Niepoprawny cache ofert – czyszczę.', error);
      clearOffersCache();
      return null;
    }

    if (!parsed || typeof parsed !== 'object' || !Array.isArray(parsed.documents)) {
      return null;
    }

    const revisionHint = settings?.revisionHint || null;
    if (revisionHint) {
      if (!parsed.revisionHint || parsed.revisionHint !== revisionHint) {
        clearOffersCache();
        return null;
      }
    }

    const now = Date.now();
    const expiresAt = typeof parsed.expiresAt === 'string'
      ? Number(parsed.expiresAt)
      : parsed.expiresAt;
    if (!allowExpired && Number.isFinite(expiresAt) && expiresAt <= now) {
      clearOffersCache();
      return null;
    }

    const sanitizedDocuments = Array.isArray(parsed.documents)
      ? parsed.documents
          .map(sanitizeOfferDocumentForCache)
          .filter(Boolean)
      : [];

    const sanitizedPayload = {
      ...parsed,
      documents: sanitizedDocuments
    };

    try {
      window.localStorage.setItem(OFFERS_CACHE_KEY, JSON.stringify(sanitizedPayload));
    } catch (_) {
      /* ignore */
    }

    return sanitizedPayload;
  }

  function writeOffersCache(documents, settings) {
    if (!window.localStorage) {
      return;
    }

    try {
      const safeDocuments = Array.isArray(documents)
        ? documents
            .map(sanitizeOfferDocumentForCache)
            .filter(Boolean)
        : [];

      const now = Date.now();
      const ttl = Number(settings?.ttlMs);
      const payload = {
        revisionHint: settings?.revisionHint || null,
        storedAt: now,
        ttlMs: Number.isFinite(ttl) && ttl > 0 ? ttl : null,
        expiresAt: Number.isFinite(ttl) && ttl > 0 ? now + ttl : null,
        documents: safeDocuments
      };

      window.localStorage.setItem(OFFERS_CACHE_KEY, JSON.stringify(payload));
    } catch (error) {
      console.warn('Nie udało się zapisać cache ofert:', error);
    }
  }

  function hydrateOffersFromDocuments(documents) {
    const listContainer = document.getElementById("offersList");
    if (listContainer) listContainer.innerHTML = "";

    allOffers.forEach(offer => {
      if (offer.marker) offer.marker.setMap(null);
      if (offer.polygon) offer.polygon.setMap(null);
    });

    markers.forEach(marker => marker.setMap(null));
    markers = [];
    allOffers = [];
    availableTags = [];
    tagMetrics = new Map();
    currentVisibleOffers = [];

    if (!Array.isArray(documents)) {
      renderTagFilters();
      updateSortButtonsUI();
      applyFilters();
      return;
    }

    documents.forEach(entry => {
      const offerId = entry?.id || null;
      const data = entry?.data || {};
      const activePlots = getActivePlotEntries(data.plots);
      if (!activePlots.length) return;

      activePlots.forEach(({ plot, originalIndex }) => {

        const lat = plot.lat;
        const lng = plot.lng;
        const geometry = plot.geometry_uldk;
        const tags = normalizeTags(plot.tags);
        const uniquePlotTags = Array.from(new Set(tags));

        const marker = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: data.firstName || "Oferta",
          icon: { url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png" }
        });
        markers.push(marker);

        marker.addListener('click', () => {
          if (map && typeof marker.getPosition === 'function') {
            panMapTo(marker.getPosition(), 17);
          }
          openInfo(marker, infoHTML(plot, data, offerId, originalIndex));
        });

        let polygon = null;
        if (geometry) {
          const coords = parseGeometry(geometry);
          if (coords.length) {
            polygon = new google.maps.Polygon({
              paths: coords,
              strokeColor: "#FF0000",
              strokeOpacity: 0.9,
              strokeWeight: 3,
              fillColor: "#FF0000",
              fillOpacity: 0.15,
              map: null,
              visible: false
            });
            polygon.addListener('click', (evt) => {
              const position = evt?.latLng || null;
              if (map && position) {
                panMapTo(position, 17);
              }
              openInfo(position, infoHTML(plot, data, offerId, originalIndex));
            });
          }
        }

        const hydratedEntry = {
          id: offerId,
          key: `${offerId || 'unknown'}__${originalIndex}`,
          data,
          plot,
          index: originalIndex,
          marker,
          polygon,
          tags: uniquePlotTags
        };

        allOffers.push(hydratedEntry);
      });
    });

    availableTags = [];
    randomPreviewSignature = '';
    randomPreviewTags = [];
    tagsExpanded = false;
    renderTagFilters();
    updateSortButtonsUI();
    applyFilters();

    if (pendingMapState && pendingMapState.focusOfferId) {
      focusOfferFromMapState();
    }
  }

  async function refreshOffersFromSource(settings) {
    const documents = [];
    const snapshot = await window.getDocs(window.collection(window.db, "propertyListings"));
    snapshot.forEach(docSnap => {
      documents.push({ id: docSnap.id, data: docSnap.data() });
    });

    hydrateOffersFromDocuments(documents);
    writeOffersCache(documents, settings);
  }

  const tagFiltersList = document.getElementById('tagFiltersList');
  const toggleTagsBtn = document.getElementById('toggleTagsBtn');
  const sortButtons = document.querySelectorAll('[data-sort-key]');

  const clusterRenderer = {
    render: ({ count, position }) => {
      return new google.maps.Marker({
        position,
        label: { text: String(count), color: 'white', fontSize: '14px', fontWeight: 'bold' },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 20,
          fillColor: 'red',
          fillOpacity: 0.85,
          strokeColor: 'red',
          strokeWeight: 2
        }
      });
    }
  };

  toggleTagsBtn?.addEventListener('click', () => {
    tagsExpanded = !tagsExpanded;
    renderTagFilters();
  });

  sortButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.sortKey;
      if (!key) return;
      if (filterState.sortKey === key) {
        filterState.sortDir = filterState.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        filterState.sortKey = key;
        filterState.sortDir = 'asc';
      }
      updateSortButtonsUI();
      filterOffersByBounds();
    });
  });

  updateSortButtonsUI();

  // jedno, globalne InfoWindow – NIGDY nie tworzymy wielu
  window.infoWin = null;

  // ====== HELPERS ======
  function formatPhone(phone) {
    const digits = String(phone || "").replace(/\D/g, "");
    const core = digits.length >= 9 ? digits.slice(-9) : digits;
    if (core.length === 9) {
      return `+48 ${core.slice(0,3)}-${core.slice(3,6)}-${core.slice(6)}`;
    }
    return "";
  }

  function pickDisplayValue(values, fallback = "") {
    for (const value of values) {
      if (typeof value !== "string") continue;
      const trimmed = value.trim();
      if (trimmed) return trimmed;
    }
    return fallback;
  }

  function infoHTML(plot, data, offerId, plotIndex) {
    const price = Number(plot.price || 0);
    const area  = Number(plot.pow_dzialki_m2_uldk || 0);
    const ppm2  = price && area ? (price/area).toFixed(0) : null;
    const locationLabel = pickDisplayValue(
      [plot.location, plot.city, data.city, data.location],
      "brak"
    );
    const rawName = typeof data.firstName === "string" ? data.firstName.trim() : "";
    const shortName = rawName ? rawName.split(/\s+/)[0] : "";
    const phone = formatPhone(data.phone);
    const detailsUrl = `details.html?id=${offerId}&plot=${plotIndex}`;

    return `
      <div class="map-info-window">
        <h3>${plot.Id || "Brak identyfikatora"}</h3>
        <p><b>Miejscowość:</b> ${locationLabel}</p>
        ${price ? `<p><b>Cena:</b> ${price.toLocaleString('pl-PL')} zł${ppm2 ? ` <span style="color:#718096;">(${ppm2} zł/m²)</span>` : ''}</p>` : ''}
        ${area  ? `<p><b>Powierzchnia:</b> ${area.toLocaleString('pl-PL')} m²</p>` : ''}
        ${shortName ? `<p><b>Imię:</b> ${shortName}</p>` : ''}
        <p><b>Telefon:</b> ${phone || 'brak'}</p>
        <div class="mini-actions center">
          <a
            class="btn-mini"
            href="${detailsUrl}"
            data-preserve-map-state="true"
            ${offerId ? `data-offer-id="${offerId}"` : ''}
            ${Number.isInteger(plotIndex) ? `data-plot-index="${plotIndex}"` : ''}
          >Szczegóły</a>
        </div>
      </div>
    `;
  }

  function normalizeTags(rawTags) {
    if (!Array.isArray(rawTags)) return [];
    return rawTags
      .map(tag => (typeof tag === 'string' ? tag.trim() : String(tag || '').trim()))
      .filter(tag => tag.length);
  }

  function offerMatchesSelectedTags(offer) {
    if (!filterState.selectedTags.size) return true;
    if (!offer.tags || !offer.tags.length) return false;
    for (const tag of filterState.selectedTags) {
      if (!offer.tags.includes(tag)) return false;
    }
    return true;
  }

  function getOffersMatchingFilters() {
    return allOffers.filter(offerMatchesSelectedTags);
  }

  function sortOffers(offers) {
    const { sortKey, sortDir } = filterState;
    if (!sortKey) return offers.slice();

    const dir = sortDir === 'desc' ? -1 : 1;
    const valueFor = (offer) => {
      if (sortKey === 'price') {
        const value = Number(offer.plot?.price);
        return Number.isFinite(value) ? value : null;
      }
      if (sortKey === 'area') {
        const value = Number(offer.plot?.pow_dzialki_m2_uldk);
        return Number.isFinite(value) ? value : null;
      }
      return null;
    };

    return offers.slice().sort((a, b) => {
      const aVal = valueFor(a);
      const bVal = valueFor(b);

      if (aVal === null && bVal === null) return 0;
      if (aVal === null) return 1;
      if (bVal === null) return -1;
      if (aVal === bVal) return 0;
      return aVal > bVal ? dir : -dir;
    });
  }

  function rebuildCluster(activeMarkers) {
    if (!map) return;
    if (markerCluster) {
      markerCluster.clearMarkers();
    }
    markerCluster = new markerClusterer.MarkerClusterer({
      map,
      markers: activeMarkers,
      renderer: clusterRenderer
    });
  }

  function updateMarkersForOffers(filteredOffers) {
    const activeKeys = new Set(filteredOffers.map(o => o.key));
    const activeMarkers = [];
    allOffers.forEach(offer => {
      const isActive = activeKeys.has(offer.key);
      if (offer.marker) {
        offer.marker.setVisible(isActive);
        offer.marker.setMap(isActive ? map : null);
        if (isActive) {
          activeMarkers.push(offer.marker);
        }
      }
    });
    rebuildCluster(activeMarkers);
  }

  function updatePolygonVisibility(filteredOffers = null) {
    if (!map) return;
    const show = map.getZoom() >= 8;
    const source = filteredOffers ?? getOffersMatchingFilters();
    const activeKeys = new Set(source.map(o => o.key));
    allOffers.forEach(offer => {
      if (!offer.polygon) return;
      const shouldShow = show && activeKeys.has(offer.key);
      offer.polygon.setMap(shouldShow ? map : null);
      offer.polygon.setVisible(!!shouldShow);
    });
  }

  function updateSortButtonsUI() {
    sortButtons.forEach(btn => {
      const key = btn.dataset.sortKey;
      const isActive = filterState.sortKey === key;
      btn.dataset.active = isActive ? 'true' : 'false';
      if (isActive) {
        btn.dataset.direction = filterState.sortDir;
        btn.setAttribute('aria-pressed', 'true');
      } else {
        btn.removeAttribute('data-direction');
        btn.setAttribute('aria-pressed', 'false');
      }
    });
  }

  function createTagChip(tag) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'tag-chip';
    btn.dataset.tag = tag;
    btn.addEventListener('click', () => toggleTagFilter(tag));
    return btn;
  }

  function formatTagCount(count) {
    if (!Number.isFinite(count)) return '';
    if (count === 1) return '1 oferta';
    const mod10 = count % 10;
    const mod100 = count % 100;
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) {
      return `${count} oferty`;
    }
    return `${count} ofert`;
  }

  function pickRandomTags(source, count) {
    const pool = Array.isArray(source) ? source.slice() : [];
    for (let i = pool.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [pool[i], pool[j]] = [pool[j], pool[i]];
    }
    return pool.slice(0, Math.min(count, pool.length));
  }

  function ensureRandomPreviewTags() {
    const signature = availableTags.join('|');
    if (signature !== randomPreviewSignature) {
      randomPreviewSignature = signature;
      randomPreviewTags = pickRandomTags(availableTags, TAG_PREVIEW_COUNT);
    } else {
      randomPreviewTags = randomPreviewTags.filter(tag => availableTags.includes(tag));
      const missing = Math.min(TAG_PREVIEW_COUNT, availableTags.length) - randomPreviewTags.length;
      if (missing > 0) {
        const pool = availableTags.filter(tag => !randomPreviewTags.includes(tag));
        randomPreviewTags = randomPreviewTags.concat(pickRandomTags(pool, missing));
      }
    }
    return randomPreviewTags.slice(0, Math.min(TAG_PREVIEW_COUNT, availableTags.length));
  }

  function formatTagLabel(tag) {
    if (typeof tag !== 'string') return '';
    return tag.startsWith('#') ? tag : `#${tag}`;
  }

  function updateTagCollectionsForVisibleOffers(visibleOffers) {
    currentVisibleOffers = Array.isArray(visibleOffers) ? visibleOffers.slice() : [];

    const metrics = new Map();

    currentVisibleOffers.forEach(offer => {
      const offerTags = Array.isArray(offer.tags) ? offer.tags : [];
      offerTags.forEach(tag => {
        metrics.set(tag, (metrics.get(tag) || 0) + 1);
      });
    });

    filterState.selectedTags.forEach(tag => {
      if (!metrics.has(tag)) {
        metrics.set(tag, 0);
      }
    });

    tagMetrics = metrics;

    const sortedTags = Array.from(metrics.entries())
      .sort((a, b) => {
        if (b[1] !== a[1]) {
          return b[1] - a[1];
        }
        return a[0].localeCompare(b[0], 'pl', { sensitivity: 'base' });
      })
      .map(([tag]) => tag);

    const previousSignature = availableTags.join('|');
    availableTags = sortedTags;

    if (availableTags.join('|') !== previousSignature) {
      randomPreviewSignature = '';
      randomPreviewTags = [];
    }

    renderTagFilters();
  }

  function computeTagDisplayCounts(filteredOffers) {
    const counts = new Map();

    if (!filterState.selectedTags.size) {
      availableTags.forEach(tag => {
        const total = Number(tagMetrics.get(tag)) || 0;
        counts.set(tag, total);
      });
      return counts;
    }

    const matches = Array.isArray(filteredOffers) ? filteredOffers : getOffersMatchingFilters();
    const matchCount = matches.length;

    filterState.selectedTags.forEach(tag => counts.set(tag, matchCount));

    matches.forEach(offer => {
      const offerTags = Array.isArray(offer.tags) ? offer.tags : [];
      offerTags.forEach(tag => {
        if (filterState.selectedTags.has(tag)) return;
        counts.set(tag, (counts.get(tag) || 0) + 1);
      });
    });

    availableTags.forEach(tag => {
      if (!counts.has(tag)) counts.set(tag, 0);
    });

    return counts;
  }

  function configureTagChip(chip, tag, displayCounts = null) {
    const isActive = filterState.selectedTags.has(tag);
    chip.classList.toggle('is-active', isActive);
    chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    chip.dataset.tag = tag;
    chip.innerHTML = '';

    const labelSpan = document.createElement('span');
    labelSpan.className = 'tag-chip__label';
    const formattedLabel = formatTagLabel(tag);
    labelSpan.textContent = formattedLabel;
    chip.appendChild(labelSpan);

    const countValue = displayCounts?.get(tag);
    const numericCount = Number.isFinite(countValue) ? countValue : (Number(tagMetrics.get(tag)) || 0);

    const compatibleCount = Number.isFinite(countValue) ? countValue : 0;
    const isCompatible = filterState.selectedTags.size > 0 && !isActive && compatibleCount > 0;
    chip.classList.toggle('is-compatible', isCompatible);
    if (isCompatible) {
      chip.dataset.compatible = 'true';
    } else {
      chip.removeAttribute('data-compatible');
    }

    let tooltip = formattedLabel;
    if (Number.isFinite(numericCount)) {
      tooltip += ` • ${formatTagCount(numericCount)}`;
    }
    if (isCompatible) {
      const suffix = compatibleCount === 1 ? 'ofercie' : 'ofertach';
      tooltip += ` • razem z wybranymi w ${compatibleCount} ${suffix}`;
    }
    chip.title = tooltip;
  }

  function renderTagFilters() {
    if (!tagFiltersList) return;

    tagFiltersList.innerHTML = '';
    tagFiltersList.classList.remove('is-empty');

    if (!availableTags.length) {
      const placeholder = document.createElement('span');
      placeholder.className = 'tag-placeholder';
      placeholder.textContent = 'Brak tagów w ofertach';
      tagFiltersList.appendChild(placeholder);
      tagFiltersList.dataset.expanded = 'false';
      tagFiltersList.dataset.state = 'empty';
      tagFiltersList.classList.add('is-empty');
      if (toggleTagsBtn) {
        toggleTagsBtn.hidden = true;
        toggleTagsBtn.setAttribute('aria-expanded', 'false');
        toggleTagsBtn.dataset.state = 'empty';
      }
      return;
    }

    const selectedTags = Array.from(filterState.selectedTags);
    const filteredForCounts = currentVisibleOffers.length ? currentVisibleOffers : getOffersMatchingFilters();
    const displayCounts = computeTagDisplayCounts(filteredForCounts);

    const visibleTags = tagsExpanded ? availableTags.slice() : ensureRandomPreviewTags().slice();
    const visibleSet = new Set(visibleTags);

    selectedTags.forEach(tag => {
      if (!visibleSet.has(tag)) {
        visibleSet.add(tag);
        visibleTags.push(tag);
      }
    });

    const listWrap = document.createElement('div');
    listWrap.className = 'tags-preview';
    if (tagsExpanded) {
      listWrap.dataset.mode = 'expanded';
    }
    tagFiltersList.appendChild(listWrap);

    visibleTags.forEach(tag => {
      const chip = createTagChip(tag);
      configureTagChip(chip, tag, displayCounts);
      listWrap.appendChild(chip);
    });

    const hiddenCount = Math.max(availableTags.length - visibleSet.size, 0);

    if (!tagsExpanded && hiddenCount > 0) {
      const summary = document.createElement('span');
      summary.className = 'tags-summary';
      summary.textContent = `+${hiddenCount} więcej`;
      listWrap.appendChild(summary);
    }

    const shouldShowToggle = availableTags.length > TAG_PREVIEW_COUNT;
    if (!shouldShowToggle) {
      tagsExpanded = false;
    }

    if (toggleTagsBtn) {
      if (shouldShowToggle) {
        toggleTagsBtn.hidden = false;
        toggleTagsBtn.textContent = tagsExpanded ? 'Ukryj tagi' : 'Pokaż wszystkie tagi';
        toggleTagsBtn.setAttribute('aria-expanded', tagsExpanded ? 'true' : 'false');
        toggleTagsBtn.dataset.state = tagsExpanded ? 'expanded' : 'collapsed';
      } else {
        toggleTagsBtn.hidden = true;
        toggleTagsBtn.setAttribute('aria-expanded', 'false');
        toggleTagsBtn.dataset.state = 'all-visible';
      }
    }

    tagFiltersList.dataset.expanded = tagsExpanded ? 'true' : 'false';
    tagFiltersList.dataset.state = shouldShowToggle ? (tagsExpanded ? 'expanded' : 'collapsed') : 'all-visible';
  }

  function toggleTagFilter(tag) {
    if (!tag) return;
    if (filterState.selectedTags.has(tag)) {
      filterState.selectedTags.delete(tag);
    } else {
      filterState.selectedTags.add(tag);
    }
    renderTagFilters();
    applyFilters();
  }

  function applyFilters() {
    const filtered = getOffersMatchingFilters();
    updateMarkersForOffers(filtered);
    filterOffersByBounds(filtered);
    updatePolygonVisibility(filtered);
  }

  function openInfo(anchorOrPosition, html) {
    if (!window.infoWin) window.infoWin = new google.maps.InfoWindow();
    const infoWin = window.infoWin;

    infoWin.close();
    infoWin.setContent(html);

    if (!map) return;

    if (anchorOrPosition && typeof anchorOrPosition.getPosition === 'function') {
      infoWin.open({ map, anchor: anchorOrPosition });
      return;
    }

    let position = null;
    if (anchorOrPosition) {
      if (typeof anchorOrPosition.lat === 'function' && typeof anchorOrPosition.lng === 'function') {
        position = anchorOrPosition;
      } else if (typeof anchorOrPosition.lat === 'number' && typeof anchorOrPosition.lng === 'number') {
        position = anchorOrPosition;
      }
    }

    if (position) {
      infoWin.setPosition(position);
    }

    infoWin.open({ map });
  }

  function panMapTo(position, minZoom = 16) {
    if (!map || !position) return;

    const target = position;
    map.panTo(target);

    if (typeof minZoom === 'number') {
      const currentZoom = map.getZoom();
      if (typeof currentZoom !== 'number' || currentZoom < minZoom) {
        map.setZoom(minZoom);
      }
    }
  }

  // ====== MAPA ======
  async function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 52.0, lng: 19.0 },
      zoom: 6,
      gestureHandling: "greedy",
      mapTypeId: google.maps.MapTypeId.HYBRID,
      tilt: 0,
      heading: 0,
      tiltControl: false
    });

    const keepMapFlat = () => {
      if (!map) return;
      if (map.getTilt && map.getTilt() !== 0) {
        map.setTilt(0);
      }
      if (map.getHeading && map.getHeading() !== 0) {
        map.setHeading(0);
      }
    };

    keepMapFlat();

    applySavedMapView();

    google.maps.event.addListener(map, "idle", () => {
      keepMapFlat();
      filterOffersByBounds();
    });
    google.maps.event.addListener(map, "zoom_changed", () => {
      keepMapFlat();
      updatePolygonVisibility();
    });
    await loadOffers();
    focusOfferFromMapState();

    // delikatny zoom kółkiem (opcjonalne)
    const mapContainer = document.getElementById('map');
    mapContainer.addEventListener('wheel', function(e) {
      if (e.target.closest('.gm-style')) {
        e.preventDefault();
        const delta = e.deltaY || e.detail || (-e.wheelDelta);
        const currentZoom = map.getZoom();
        map.setZoom(delta < 0 ? currentZoom + 0.5 : currentZoom - 0.5);
      }
    }, { passive: false });
  }

  async function loadOffers(options = {}) {
    const { forceRefresh = false } = options || {};
    const settings = resolveOffersCacheSettings();

    if (!forceRefresh) {
      const cached = readOffersCache(settings);
      if (cached && Array.isArray(cached.documents)) {
        hydrateOffersFromDocuments(cached.documents);
        refreshOffersFromSource(settings).catch(error => {
          console.warn('Nie udało się odświeżyć ofert z sieci po użyciu cache:', error);
        });
        return;
      }
    }

    try {
      await refreshOffersFromSource(settings);
    } catch (err) {
      console.error("Błąd pobierania ofert:", err);
      const fallback = readOffersCache(settings, { allowExpired: true });
      if (fallback && Array.isArray(fallback.documents) && !allOffers.length) {
        hydrateOffersFromDocuments(fallback.documents);
      }
    }
  }

  window.loadOffers = loadOffers;

  // widoczność listy wg granic + sortowanie wyników
  function filterOffersByBounds(filteredOffers = null) {
    if (!map || !allOffers.length) return;
    const bounds = map.getBounds();
    if (!bounds) return;

    const base = Array.isArray(filteredOffers) ? filteredOffers : getOffersMatchingFilters();
    const visibleOffers = base.filter(o => bounds.contains(o.marker.getPosition()));
    updateTagCollectionsForVisibleOffers(visibleOffers);

    const listContainer = document.getElementById("offersList");
    if (!listContainer) return;

    const sortedOffers = sortOffers(visibleOffers);

    listContainer.innerHTML = "";
    if (!sortedOffers.length) {
      listContainer.innerHTML = '<p class="no-offers">Brak ofert w widocznym obszarze</p>';
      return;
    }

    sortedOffers.forEach(o => {
      const card = document.createElement("div");
      card.className = "offer-card";
      const price = Number(o.plot.price || 0);
      const area  = Number(o.plot.pow_dzialki_m2_uldk || 0);
      const ppm2  = price && area ? (price/area).toFixed(2) : "0.00";
      const detailsUrl = `details.html?id=${o.id}&plot=${o.index}`;
      const tagList = Array.isArray(o.tags) ? o.tags : [];
      const tagsMarkup = tagList.length
        ? `<div class="offer-tags">${tagList.map(tag => formatTagLabel(tag)).join(' ')}</div>`
        : '';

      card.innerHTML = `
        <h5>${o.plot.Id || "Brak identyfikatora"}</h5>
        ${o.data.city ? `<p><b>Miejscowość:</b> ${o.data.city}</p>` : ""}
        ${o.data.firstName ? `<p><b>Imię:</b> ${o.data.firstName}</p>` : ""}
        <p><b>Telefon:</b> ${formatPhone(o.data.phone) || "-"}</p>
        ${price ? `<p><b>Cena całkowita:</b> ${price.toLocaleString('pl-PL')} zł <span style="color:#888;font-size:.85em;margin-left:5px;">${ppm2} zł/m²</span></p>` : ""}
        ${area  ? `<p><b>Powierzchnia:</b> ${area.toLocaleString('pl-PL')} m²</p>` : ""}
        ${tagsMarkup}
        <div class="offer-actions center">
          <a
            class="btn btn-accent btn-sm"
            href="${detailsUrl}"
            data-preserve-map-state="true"
            ${o.id ? `data-offer-id="${o.id}"` : ''}
            ${Number.isInteger(o.index) ? `data-plot-index="${o.index}"` : ''}
          >
            <i class="fas fa-info-circle"></i> Szczegóły
          </a>
        </div>
      `;

      card.addEventListener("click", (e) => {
        if (e.target.closest('a')) return;
        panMapTo(o.marker.getPosition());
        openInfo(o.marker, infoHTML(o.plot, o.data, o.id, o.index));
      });

      listContainer.appendChild(card);
    });
  }

  // EPSG:2180 -> WGS84
  function parseGeometry(geometryString) {
    const coords = [];
    try {
      proj4.defs("EPSG:2180", "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");
      const coordString = geometryString.match(/\(\(([^)]+)\)\)/)[1];
      const points = coordString.split(',');
      points.forEach(point => {
        const [xStr, yStr] = point.trim().split(' ');
        const x = parseFloat(xStr), y = parseFloat(yStr);
        const [lng, lat] = proj4("EPSG:2180", "WGS84", [x, y]);
        coords.push({ lat, lng });
      });
    } catch (e) { console.error("Błąd parsowania geometrii:", e, geometryString); }
    return coords;
  }

  // PUBLIC: focus z „Moje Oferty”
  window.focusOfferOnMap = function(offerId, plotIndex) {
    const match = allOffers.find(o => o.id === offerId && o.index === plotIndex);
    if (!match || !map) return;
    panMapTo(match.marker.getPosition(), 17);
    openInfo(match.marker, infoHTML(match.plot, match.data, match.id, match.index));
    document.querySelector('.map-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  // ładowanie Google Maps
  function loadGoogleMaps() {
    const apiKey = localStorage.getItem('googleMapsApiKey') || 'AIzaSyCr5TmFxnT3enxmyr6vujF8leP995giw8I';
    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
    script.async = true; script.defer = true;
    document.head.appendChild(script);
  }
  document.addEventListener("DOMContentLoaded", loadGoogleMaps);
</script>




<script type="module">
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendEmailVerification,
    GoogleAuthProvider, signInWithPopup, signInWithRedirect,
    setPersistence,
    indexedDBLocalPersistence,
    browserLocalPersistence,
    browserSessionPersistence,
    inMemoryPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc,
    collection, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- KONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
    authDomain: "base-468e0.firebaseapp.com",
    projectId: "base-468e0",
    storageBucket: "base-468e0.firebasestorage.app",
    messagingSenderId: "829161895559",
    appId: "1:829161895559:web:d832541aac05b35847ea22"
  };

  // --- INIT ---
  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  auth.languageCode = 'pl';

  const persistenceChain = [
    ['indexedDB', indexedDBLocalPersistence],
    ['localStorage', browserLocalPersistence],
    ['session', browserSessionPersistence],
    ['memory', inMemoryPersistence]
  ];

  let configured = false;
  let lastError = null;
  for (const [label, persistence] of persistenceChain) {
    try {
      await setPersistence(auth, persistence);
      configured = true;
      break;
    } catch (error) {
      lastError = error;
      console.warn(`⚠️ Nie udało się ustawić persystencji Firebase (${label}).`, error);
    }
  }

  if (!configured && lastError) {
    console.error('❌ Wszystkie tryby persystencji Firebase nie powiodły się. Sesja może być niestabilna.', lastError);
  }

  const REGISTER_PROMPT_KEY = 'grunteo.registerPrompt';

  (function domainHint(){
    const hint = document.getElementById('domainWarning');
    if (!hint) return;
    const knownGood = ['localhost','127.0.0.1','trainingtwenty5.github.io','grunteo.pl','grunte.pl'];
    if (!knownGood.includes(location.hostname)) {
      hint.style.display = 'block';
    }
  })();

  const googleProvider = new GoogleAuthProvider();
  googleProvider.setCustomParameters({ prompt: 'select_account' });

  // --- DOM ---
  const authButtons   = document.getElementById('authButtons');
  const userMenu      = document.getElementById('userMenu');
  const loginBtn      = document.getElementById('loginBtn');
  const registerBtn   = document.getElementById('registerBtn');
  const accountBtn    = document.getElementById('accountBtn');
  const logoutBtn     = document.getElementById('logoutBtn');

  const loginModal    = document.getElementById('loginModal');
  const registerModal = document.getElementById('registerModal');
  const closeBtns     = document.querySelectorAll('.modal-close');
  const switchToRegister = document.getElementById('switchToRegister');
  const switchToLogin    = document.getElementById('switchToLogin');
  const loginForm     = document.getElementById('loginForm');
  const registerForm  = document.getElementById('registerForm');

  const userDashboard = document.getElementById('userDashboard');
  const userOffers    = document.getElementById('userOffers');

  const googleBtnRegister = document.getElementById('googleLoginBtn');
  const googleBtnLogin    = document.getElementById('googleLoginBtnLogin');

  let pendingRegisterPrompt = null;
  let rawRegisterPrompt = null;
  try {
    rawRegisterPrompt = sessionStorage.getItem(REGISTER_PROMPT_KEY);
    if (rawRegisterPrompt) {
      sessionStorage.removeItem(REGISTER_PROMPT_KEY);
    }
  } catch (_) {
    rawRegisterPrompt = null;
  }

  if (rawRegisterPrompt) {
    try {
      const parsed = JSON.parse(rawRegisterPrompt);
      if (parsed && typeof parsed === 'object') {
        pendingRegisterPrompt = parsed;
      } else {
        pendingRegisterPrompt = { openRegister: true };
      }
    } catch (_) {
      pendingRegisterPrompt = { openRegister: true };
    }
  }

  // --- POMOCNICZE UI ---
  const openModal  = (m) => m && (m.style.display = 'flex');
  const closeModal = (m) => m && (m.style.display = 'none');

  const triggerRegisterPrompt = () => {
    if (!pendingRegisterPrompt || !pendingRegisterPrompt.openRegister) return;
    if (registerModal) openModal(registerModal);
    const message = pendingRegisterPrompt.message || 'Po zalogowaniu się będziesz mógł edytować swoje ogłoszenie.';
    if (typeof window !== 'undefined' && typeof window.showToast === 'function') {
      window.showToast(message, pendingRegisterPrompt.type || 'info');
    } else {
      alert(message);
    }
    pendingRegisterPrompt = null;
  };

  function renderMobileAuth(user) {
    const navMenu = document.querySelector('.nav-menu');
    const mobileAuthC = document.getElementById('mobileAuth');
    if (!mobileAuthC) return;

    if (user) {
      const label = user.displayName ? user.displayName.split(' ')[0] : (user.email || 'Użytkownik');
      mobileAuthC.innerHTML = `
        <div class="nav-link" style="font-weight:600;">
          <i class="fas fa-user"></i> ${label}
        </div>
        <a href="index.html#userDashboard" class="nav-link" id="mobileAccountLink">Moje konto</a>
        <button class="btn btn-secondary" id="mobileLogoutBtn" style="width:100%;">
          <i class="fas fa-sign-out-alt"></i> Wyloguj się
        </button>
      `;
    } else {
      mobileAuthC.innerHTML = `
        <a href="#" id="loginLink" class="nav-link">Zaloguj się</a>
        <a href="#" id="registerLink" class="nav-link">Zarejestruj się</a>
      `;
    }

    const loginLink = document.getElementById('loginLink');
    const registerLink = document.getElementById('registerLink');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const mobileAccountLink = document.getElementById('mobileAccountLink');

    loginLink && loginLink.addEventListener('click', (e) => {
      e.preventDefault();
      openModal(loginModal);
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
    });

    registerLink && registerLink.addEventListener('click', (e) => {
      e.preventDefault();
      openModal(registerModal);
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
    });

    mobileLogoutBtn && mobileLogoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); } catch(e){ console.error(e); }
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
    });

    mobileAccountLink && mobileAccountLink.addEventListener('click', (e) => {
      e.preventDefault();
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
      window.location.href = 'index.html#userDashboard';
    });

    mobileAuthC.style.display = navMenu?.classList.contains('active') ? 'flex' : 'none';
  }

  // --- HANDLERY MODALI (desktop) ---
  loginBtn    && loginBtn.addEventListener('click', () => openModal(loginModal));
  registerBtn && registerBtn.addEventListener('click', () => openModal(registerModal));

  // Przełączanie między modalami
  switchToRegister && switchToRegister.addEventListener('click', (e) => {
    e.preventDefault(); closeModal(loginModal);  openModal(registerModal);
  });
  switchToLogin && switchToLogin.addEventListener('click', (e) => {
    e.preventDefault(); closeModal(registerModal); openModal(loginModal);
  });

  // Zamknięcie X i klik w tło
  closeBtns.forEach(b => b.addEventListener('click', () => closeModal(b.closest('.modal'))));
  window.addEventListener('click', (e) => {
    if (e.target.classList?.contains('modal')) closeModal(e.target);
  });

  accountBtn && accountBtn.addEventListener('click', (event) => {
    event.preventDefault?.();
    window.location.href = 'index.html#userDashboard';
  });

  // --- ŁADNE BŁĘDY ---
  const niceAuthError = (err) => {
    const code = err?.code || '';
    switch (code) {
      case 'auth/invalid-email':
        return 'Nieprawidłowy adres e-mail.';
      case 'auth/missing-password':
        return 'Podaj hasło.';
      case 'auth/invalid-credential':
        return 'Nieprawidłowy e-mail lub hasło.';
      case 'auth/user-not-found':
        return 'Użytkownik nie istnieje.';
      case 'auth/wrong-password':
        return 'Błędne hasło.';
      case 'auth/too-many-requests':
        return 'Za dużo prób. Spróbuj ponownie później.';
      case 'auth/unauthorized-domain':
        return `Domena ${location.hostname} nie jest autoryzowana w Firebase (Authentication → Authorized domains).`;
      case 'auth/network-request-failed':
        return 'Błąd sieci. Sprawdź połączenie z internetem.';
      case 'auth/popup-closed-by-user':
        return 'Zamykanie okna logowania przerwało proces.';
      case 'auth/cancelled-popup-request':
        return 'Logowanie zostało przerwane przez inne żądanie. Spróbuj ponownie.';
      case 'auth/popup-blocked':
        return 'Przeglądarka zablokowała okno logowania Google. Użyj przekierowania.';
      case 'auth/operation-not-supported-in-this-environment':
        return 'To środowisko nie wspiera tego typu logowania (np. file://). Uruchom stronę przez https.';
      default:
        return `Błąd: ${code || err?.message || 'nieznany'}`;
    }
  };

  // --- Email/hasło ---
  loginForm && loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      console.error('[login]', err);
      showToast(niceAuthError(err), 'error');
    }
  });

  registerForm && registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name  = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const pass1 = document.getElementById('registerPassword').value;
    const pass2 = document.getElementById('registerConfirmPassword').value;
    if (pass1 !== pass2) {
      showToast('Hasła nie są identyczne!', 'error');
      return;
    }
    try {
      const { user } = await createUserWithEmailAndPassword(auth, email, pass1);
      if (name) await updateProfile(user, { displayName: name });
      await setDoc(doc(db, 'users', user.uid), {
        name: name || null,
        email,
        createdAt: new Date(),
        provider: "password"
      }, { merge: true });
      try {
        await sendEmailVerification(user);
        if (typeof window !== 'undefined') {
          if (typeof window.showToast === 'function') {
            window.showToast('Na Twój adres wysłaliśmy wiadomość z linkiem aktywacyjnym. Sprawdź skrzynkę i potwierdź konto.', 'info');
          } else {
            alert('Na Twój adres wysłaliśmy wiadomość z linkiem aktywacyjnym. Sprawdź skrzynkę i potwierdź konto.');
          }
        }
      } catch (verificationError) {
        console.error('[register][verification]', verificationError);
      }
    } catch (err) {
      console.error('[register]', err);
      showToast(niceAuthError(err), 'error');
    }
  });

  // --- Google ---
  async function signInWithGoogleSmart() {
    const isHttps = location.protocol === 'https:';
    if (!isHttps) {
      showToast('Uruchom stronę przez https (nie file://).', 'error');
      return;
    }
    try {
      await signInWithPopup(auth, googleProvider);
      closeModal(loginModal); closeModal(registerModal);
      document.querySelector('.nav-menu')?.classList.remove('active');
      document.getElementById('mobileAuth')?.setAttribute('style', 'display:none;');
    } catch (err) {
      console.error('[google]', err);
      if (err?.code === 'auth/popup-blocked' || err?.code === 'auth/operation-not-supported-in-this-environment') {
        await signInWithRedirect(auth, googleProvider);
      } else {
        showToast(niceAuthError(err), 'error');
      }
    }
  }
  [googleBtnRegister, googleBtnLogin].forEach(btn =>
    btn && btn.addEventListener('click', (e) => { e.preventDefault(); signInWithGoogleSmart(); })
  );

  // --- STAN LOGOWANIA ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      authButtons && (authButtons.style.display = 'none');
      userMenu    && (userMenu.style.display   = 'flex');
      userDashboard && (userDashboard.style.display = 'block');
      if (accountBtn) {
        const label = user.displayName || user.email || 'Moje konto';
        accountBtn.innerHTML = `<i class="fas fa-user"></i> ${label}`;
      }

      try { await loadUserOffers(user.email || null, user.uid || null); } catch(e){ console.error(e); }
      closeModal(loginModal); closeModal(registerModal);
      pendingRegisterPrompt = null;
    } else {
      authButtons && (authButtons.style.display = 'flex');
      userMenu    && (userMenu.style.display   = 'none');
      userDashboard && (userDashboard.style.display = 'none');
      userOffers && (userOffers.innerHTML = '');
      triggerRegisterPrompt();
    }
    renderMobileAuth(user);
  });

  // --- WYLOGOWANIE ---
  logoutBtn && logoutBtn.addEventListener('click', async () => {
    try { await signOut(auth); } catch(_) {}
  });
  
  
  
  
  
  
  
  

  // --- „Miękkie usuwanie” i ładowanie ofert (jeśli używasz) ---
async function loadUserOffers(email, uid) {
  try {
    const emailFields = ['email', 'userEmail', 'ownerEmail', 'createdByEmail', 'contactEmail'];
    const idFields    = ['userUid', 'uid', 'userId', 'ownerId', 'createdBy'];

    userOffers.innerHTML = '<p>Ładuję Twoje oferty…</p>';

    // Zbierz WSZYSTKIE pasujące dokumenty z wielu zapytań i zdeduplikuj po id
    const results = new Map(); // id -> QueryDocumentSnapshot

    // — po e-mailu (uwzględnij różne wielkości liter)
    if (email) {
      const variants = [...new Set([email, email.toLowerCase()])];
      for (const field of emailFields) {
        for (const val of variants) {
          try {
            const s = await getDocs(query(collection(db, 'propertyListings'), where(field, '==', val)));
            s.forEach(d => results.set(d.id, d));
          } catch (e) {
            console.warn('Email query failed for', field, e);
          }
        }
      }
    }

    // — po UID
    if (uid) {
      for (const field of idFields) {
        try {
          const s = await getDocs(query(collection(db, 'propertyListings'), where(field, '==', uid)));
          s.forEach(d => results.set(d.id, d));
        } catch (e) {
          console.warn('UID query failed for', field, e);
        }
      }
    }

    userOffers.innerHTML = '';

    if (results.size === 0) {
      userOffers.innerHTML = '<p>Nie masz jeszcze żadnych aktywnych ofert.</p>';
      return;
    }

    // Render (twój fragment bez zmian poza źródłem danych)
    Array.from(results.values()).forEach((docu) => {
      const offer  = docu.data();
      const offerId = docu.id;
      const activePlots = getActivePlotEntries(offer.plots);
      if (!activePlots.length) return;

      activePlots.forEach(({ plot, originalIndex }, i) => {
        const price = Number(plot.price || 0);
        const area  = Number(plot.pow_dzialki_m2_uldk || plot.area || plot.areaM2 || 0);
        const ppm2  = price && area ? Math.round(price/area) : 0;
        const detailsUrl = `details.html?id=${offerId}&plot=${originalIndex}`;
        const locationSources = [plot.location, plot.city, offer.city];
        if (typeof offer.location === 'string') {
          locationSources.push(offer.location);
        } else if (offer.location && typeof offer.location === 'object') {
          locationSources.push(offer.location.city, offer.location.town, offer.location.municipality);
        }
        const locationLabel = pickDisplayValue(locationSources, 'Nie podano');

        const el = document.createElement('div');
        el.className = 'offer-card';
        el.innerHTML = `
          <h3 class="offer-title">${plot.Id || `Działka ${i+1}`}</h3>
          <div class="offer-details">
            <p><strong>Lokalizacja:</strong> ${locationLabel}</p>
            ${area  ? `<p><strong>Powierzchnia:</strong> ${area.toLocaleString('pl-PL')} m²</p>` : ''}
            ${price ? `<p><strong>Cena całkowita:</strong> ${price.toLocaleString('pl-PL')} zł
              ${ppm2 ? `<span style="color:#888;font-size:.85em;margin-left:5px;">${ppm2.toLocaleString('pl-PL')} zł/m²</span>`:''}
            </p>` : ''}
          </div>
          <div class="offer-actions">
            <a
              class="btn btn-accent btn-sm"
              href="${detailsUrl}"
              data-preserve-map-state="true"
              ${offerId ? `data-offer-id="${offerId}"` : ''}
              ${Number.isInteger(originalIndex) ? `data-plot-index="${originalIndex}"` : ''}
            >
              <i class="fas fa-info-circle"></i> Szczegóły
            </a>
            <button class="btn btn-primary btn-sm" onclick="window.location.href='edit.html?id=${offerId}&plot=${originalIndex}'">
              <i class="fas fa-edit"></i> Edytuj
            </button>
            <button class="btn btn-secondary btn-sm" onclick="deletePlot && deletePlot('${offerId}', ${originalIndex}, '${(plot.Id||`Działka ${i+1}`).replace(/'/g,"\\'")}')">
              <i class="fas fa-trash"></i> Usuń
            </button>
          </div>
        `;
        el.addEventListener('click', (e) => {
          if (e.target.closest('.offer-actions')) return;
          window.focusOfferOnMap?.(offerId, originalIndex);
        });
        userOffers.appendChild(el);
      });
    });

    if (!userOffers.querySelector('.offer-card')) {
      userOffers.innerHTML = '<p>Nie masz jeszcze żadnych aktywnych ofert.</p>';
    }
  } catch (error) {
    console.error('Error loading offers: ', error);
    userOffers.innerHTML = '<p>Wystąpił błąd podczas ładowania ofert.</p>';
  }
}

async function deletePlot(offerId, plotIndex, title) {
  if (!(await showConfirmModal(`Czy na pewno chcesz usunąć działkę "${title}"?`))) return;
  try {
    const offerRef = doc(db, 'propertyListings', offerId);
    const snap = await getDoc(offerRef);
    if (!snap.exists()) {
      showToast('Ogłoszenie nie istnieje.', 'error');
      return;
    }
    const data = snap.data();
    if (!Array.isArray(data.plots)) {
      showToast('Brak działek do usunięcia.', 'error');
      return;
    }
    const plots = Array.isArray(data.plots) ? [...data.plots] : [];
    const plot = plots[plotIndex];
    if (!plot) {
      showToast('Nie znaleziono wskazanej działki.', 'error');
      return;
    }
    plots[plotIndex] = { ...plot, mock: false };
    await setDoc(offerRef, { plots }, { merge: true });
    showToast('Działka usunięta', 'success');
    if (auth.currentUser) {
      loadUserOffers(auth.currentUser.email || null, auth.currentUser.uid || null);
    }
    if (typeof window.loadOffers === 'function') {
      await window.loadOffers({ forceRefresh: true });
    }
  } catch (err) {
    console.error('deletePlot', err);
    showToast('Nie udało się usunąć działki.', 'error');
  }
}

window.deletePlot = deletePlot;



  // --- EXPORTY DLA ZWYKŁYCH SKRYPTÓW (jeśli używasz poza module) ---
  window.db = db;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.where = where;
  window.doc       = doc;
  window.updateDoc = updateDoc;
</script>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const navMenu = document.querySelector('.nav-menu');
    const mobileAuth = document.getElementById('mobileAuth');

    mobileMenuBtn?.addEventListener('click', function () {
      navMenu.classList.toggle('active');
      if (mobileAuth) {
        mobileAuth.style.display = navMenu.classList.contains('active') ? 'flex' : 'none';
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        navMenu.classList.remove('active');
        if (mobileAuth) mobileAuth.style.display = 'none';
      }
    });
  });
</script>

  <div class="cookie-banner" data-cookie-banner role="dialog" aria-modal="false" aria-live="polite" tabindex="-1">
    <div class="cookie-banner__icon" aria-hidden="true">
      <i class="fas fa-cookie-bite"></i>
    </div>
    <div class="cookie-banner__content">
      <h3 class="cookie-banner__title">Szanujemy Twoją prywatność</h3>
      <p class="cookie-banner__text">
        Korzystamy z plików cookies, aby zapewnić prawidłowe działanie serwisu, analizować ruch i rozwijać nasze usługi.
        Szczegółowe informacje znajdziesz w <a href="RODO.html">Informacji RODO</a> oraz w
        <a href="polityka-prywatnosci.html">Polityce prywatności i cookies</a>.
      </p>
      <div class="cookie-banner__actions">
        <button type="button" class="btn btn-primary cookie-banner__btn" data-cookie-accept>Akceptuję wszystkie</button>
        <button type="button" class="btn btn-secondary cookie-banner__btn" data-cookie-decline>Tylko niezbędne</button>
        <a class="cookie-banner__link" href="polityka-prywatnosci.html#cookies">
          <i class="fas fa-sliders" aria-hidden="true"></i>
          Zarządzaj ustawieniami
        </a>
      </div>
    </div>
  </div>
  <button class="cookie-preferences" type="button" data-cookie-preferences hidden aria-haspopup="dialog" aria-expanded="false">
    <i class="fas fa-cookie-bite" aria-hidden="true"></i>
    Ustawienia cookies
  </button>
  <script src="assets/cookies.js"></script>

</body>
</html>

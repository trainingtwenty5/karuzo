<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Działkofert - Dodaj darmowe ogłoszenie</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  
    <!-- Favicon dla przeglądarek -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png">
  <link rel="icon" type="image/png" sizes="64x64" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png">

  <!-- Ikona dla Apple (po zapisaniu strony na ekranie głównym iPhone/iPad) -->
  <link rel="apple-touch-icon" sizes="180x180" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png">

  <!-- Ikona dla Androida (progressive web app / home screen) -->
  <link rel="icon" type="image/png" sizes="192x192" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png">
  <link rel="icon" type="image/png" sizes="512x512" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png">


  <link rel="stylesheet" href="assets/main.css">
  <link rel="stylesheet" href="assets/oferty.css">

  </head>
<body>
  <div class="top-navbar">
    <div class="contact-info">
      <i class="fas fa-clock"></i> Poniedziałek - Piątek 9:00 - 18:00
      <span><i class="fas fa-phone"></i> +48 505 849 404</span>
    </div>

    <div class="auth-buttons" id="authButtons">
      <button class="btn btn-outline-primary btn-sm me-2" id="loginBtn">
        <i class="fas fa-sign-in-alt me-1"></i> Zaloguj się
      </button>
      <button class="btn btn-primary btn-sm" id="registerBtn">
        <i class="fas fa-user-plus me-1"></i> Zarejestruj się
      </button>
    </div>

    <div class="user-menu" id="userMenu" style="display:none;">
      <button class="btn btn-outline-primary btn-sm me-2" id="accountBtn">
        <i class="fas fa-user me-1"></i> Moje konto
      </button>

      <button class="btn btn-secondary btn-sm ms-2" id="logoutBtn">
        <i class="fas fa-sign-out-alt me-1"></i> Wyloguj
      </button>
    </div>
  </div>

  <header>
    <a href="index.html" class="logo">
      <img src="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png" alt="Działkofert">
      <span>Działkofert</span>
    </a>

    <nav class="desktop-nav">
      <a href="index.html" class="nav-link">Strona główna</a>
      <a href="oferty.html" class="nav-link">Oferty</a>
      <a href="#contact" class="nav-link">Kontakt</a>
    </nav>

    <a href="dodaj.html" class="desktop-add-offer">
      <i class="fas fa-plus"></i> Dodaj ofertę
    </a>
    <a href="dodaj.html" class="mobile-add-offer">
      <i class="fas fa-plus"></i> Dodaj ofertę
    </a>

    <button class="mobile-menu-btn" aria-label="Otwórz menu">
      <i class="fas fa-bars"></i>
    </button>

    <nav class="nav-menu">
      <a href="index.html" class="nav-link">Strona główna</a>
      <a href="oferty.html" class="nav-link">Oferty</a>
      <a href="dodaj.html" class="nav-link">Dodaj ofertę</a>
      <a href="#contact" class="nav-link">Kontakt</a>

      <!-- Miejsce na elementy auth w menu mobilnym -->
      <div class="mobile-auth" id="mobileAuth" style="display:none;"></div>
    </nav>
  </header>


<!-- Toasts -->
<div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
<script>
/* ===== UI: TOAST (vanilla) =====
   showToast('Oferta „...” została usunięta.', 'success')
   type: 'info' | 'success' | 'warning' | 'error'
*/
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  if (!container) return;

  const wrap = document.createElement('div');
  wrap.className = `toast-lite toast-${type}`;
  wrap.setAttribute('role', 'status');
  wrap.setAttribute('aria-live', 'polite');

  // dobierz ikonę
  const icon = {
    success: '✓',
    info: 'ℹ',
    warning: '!',
    error: '✕'
  }[type] || 'ℹ';

  wrap.innerHTML = `
    <div class="toast-icon" aria-hidden="true">${icon}</div>
    <div class="toast-msg">${message}</div>
    <button class="toast-close" aria-label="Zamknij">&times;</button>
  `;

  // zamykanie
  const close = () => {
    wrap.classList.remove('show');
    setTimeout(() => wrap.remove(), 160);
  };
  wrap.querySelector('.toast-close').addEventListener('click', close);

  // dodaj + animacja wejścia
  container.appendChild(wrap);
  requestAnimationFrame(() => wrap.classList.add('show'));

  // auto-hide po 4s
  const t = setTimeout(close, 4000);
  // jeśli użytkownik najedzie, nie chowaj
  wrap.addEventListener('mouseenter', () => clearTimeout(t), { once: true });
}

window.deletePlot = async function(offerId, plotIndex, plotTitle) {
  // ładne potwierdzenie (używa Twojego showConfirm)
  const ok = await showConfirm({
    title: 'Usunąć ofertę?',
    message: `Czy na pewno chcesz usunąć ofertę „${plotTitle}”?`,
    yesText: 'Usuń',
    noText: 'Anuluj'
  });
  if (!ok) return;

  try {
    // pobierz dokument
    const offerDoc = await getDoc(doc(db, "propertyListings", offerId));
    if (!offerDoc.exists()) {
      showToast("Oferta nie istnieje.", "warning");
      return;
    }

    const offerData = offerDoc.data();
    if (!Array.isArray(offerData.plots) || plotIndex >= offerData.plots.length) {
      showToast("Wybrana działka nie istnieje.", "warning");
      return;
    }

    // miękkie usunięcie: mock:false tylko dla wskazanej działki
    const updated = [...offerData.plots];
    updated[plotIndex] = { ...updated[plotIndex], mock: false };

    await updateDoc(doc(db, "propertyListings", offerId), { plots: updated });

    // odśwież listę + toast sukcesu
	const user = auth.currentUser;
	if (user) await loadUserOffers(user.email || null, user.uid || null);

    showToast(`Oferta „${plotTitle}” została usunięta.`, "success");
  } catch (err) {
    console.error("Błąd podczas usuwania oferty:", err);
    showToast("Wystąpił błąd podczas usuwania oferty.", "error");
  }
};

</script>

<!-- Confirm (Tak/Nie) -->
<div id="confirmModal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-hidden="true">
  <div class="confirm-box" role="document">
    <h3 id="confirmTitle" class="confirm-title">Potwierdzenie</h3>
    <p id="confirmMessage" class="confirm-message">Czy na pewno chcesz kontynuować?</p>
    <div class="confirm-actions">
      <button type="button" class="confirm-btn confirm-cancel" id="confirmNo">Nie</button>
      <button type="button" class="confirm-btn confirm-yes" id="confirmYes">Tak</button>
    </div>
  </div>
</div>


<script>
// Ładny modal potwierdzenia: zwraca Promise<boolean>
function showConfirm({ title = 'Potwierdzenie', message = 'Czy na pewno chcesz kontynuować?', yesText = 'Tak', noText = 'Nie' } = {}) {
  return new Promise((resolve) => {
    const modal   = document.getElementById('confirmModal');
    const box     = modal.querySelector('.confirm-box');
    const titleEl = document.getElementById('confirmTitle');
    const msgEl   = document.getElementById('confirmMessage');
    const btnNo   = document.getElementById('confirmNo');
    const btnYes  = document.getElementById('confirmYes');

    // Ustaw treści
    titleEl.textContent = title;
    msgEl.textContent   = message;
    btnYes.textContent  = yesText;
    btnNo.textContent   = noText;

    // Pokazanie
    modal.style.display = 'flex';
    // timeout żeby CSS transition złapał klasę
    requestAnimationFrame(() => modal.classList.add('show'));

    // Handlery zamknięcia
    const cleanup = (val) => {
      modal.classList.remove('show');
      setTimeout(() => { modal.style.display = 'none'; }, 120);
      document.removeEventListener('keydown', onKey);
      modal.removeEventListener('click', onBackdrop);
      btnNo.removeEventListener('click', onNo);
      btnYes.removeEventListener('click', onYes);
      resolve(val);
    };

    const onNo = () => cleanup(false);
    const onYes = () => cleanup(true);
    const onBackdrop = (e) => { if (e.target === modal) cleanup(false); };
    const onKey = (e) => {
      if (e.key === 'Escape') cleanup(false);
      if (e.key === 'Enter')  cleanup(true);
    };

    btnNo.addEventListener('click', onNo);
    btnYes.addEventListener('click', onYes);
    modal.addEventListener('click', onBackdrop);
    document.addEventListener('keydown', onKey);

    // Fokus na „Tak”
    btnYes.focus();
  });
}
</script>

  <!-- ===== GŁÓWNY UKŁAD Z MAPĄ I ZAWARTOŚCIĄ ===== -->
  <div class="main-layout">
    <!-- Lewa strona - statyczna mapa -->
    <div class="map-container">
      <div id="map"></div>
    </div>
    
    <!-- Prawa strona - przewijana zawartość -->
    <div class="content-container">
      <!-- Panel z ofertami publicznymi -->
      <div class="offers-section">
        <div class="section-title">
          <h2>Oferty działek</h2>
        </div>
        <div class="offers-list" id="offersList"></div>
      </div>
      
      <!-- Panel z Twoimi ofertami -->
      <div class="offers-section">
        <div class="section-title">
          <h2>Moje Oferty</h2>
        </div>
        <div id="userDashboard">
          <div class="offers-grid" id="userOffers"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Zaloguj się</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Hasło</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Zaloguj się</button>
      </form>
	  
	  <div class="social-login">
  <button type="button" class="btn btn-google" id="googleLoginBtnLogin">
    <i class="fab fa-google"></i> Kontynuuj z Google
  </button>
</div>
	  
      <div class="form-footer">
        <p>Nie masz konta? <a href="#" id="switchToRegister">Zarejestruj się</a></p>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Utwórz konto</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="registerForm">
        <div class="form-group">
          <label for="registerName">Imię i nazwisko</label>
          <input type="text" id="registerName" required>
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">Hasło</label>
          <input type="password" id="registerPassword" required>
        </div>
        <div class="form-group">
          <label for="registerConfirmPassword">Potwierdź hasło</label>
          <input type="password" id="registerConfirmPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Zarejestruj się</button>
      </form>
	  
      <div class="social-login mt-3 text-center">
        <button type="button" class="btn btn-google w-100 mb-2" id="googleLoginBtn">
          <i class="fab fa-google me-1"></i> Zaloguj przez Google
        </button>

      </div>
      
      <div class="domain-warning" id="domainWarning">
        <i class="fas fa-exclamation-triangle"></i> 
        Uwaga: Logowanie przez Facebook może nie działać na tej domenie. 
        Aby rozwiązać ten problem, dodaj swoją domenę w ustawieniach Firebase.
      </div>
	  
      <div class="form-footer">
        <p>Masz już konto? <a href="#" id="switchToLogin">Zaloguj się</a></p>
      </div>
    </div>
  </div>

  <!-- Modal edycji -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edytuj ofertę</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editOfferId">
        <input type="hidden" id="editPlotIndex">
        
        <div class="form-group">
          <label for="editPlotId">Identyfikator działki</label>
          <input type="text" id="editPlotId" required>
        </div>
        
        <div class="form-group">
          <label for="editPrice">Cena całkowita (zł)</label>
          <input type="number" id="editPrice" required>
        </div>
        
        <div class="form-group">
          <label for="editPhone">Telefon kontaktowy</label>
          <input type="tel" id="editPhone" required>
        </div>
        
        <div class="form-group">
          <label for="editCity">Miejscowość</label>
          <input type="text" id="editCity" required>
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%;">Zaktualizuj ofertę</button>
      </form>
    </div>
  </div>


<footer id="contact">
  <div class="container">
    <div class="footer-container">
      <div class="footer-about">
        <a href="index.html" class="footer-logo">
          <img src="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png" alt="Działkofert">
          <span>Działkofert</span>
        </a>
        <p>Bezpłatne ogłoszenia nieruchomości. Szybka sprzedaż działek bez zbędnych kosztów i formalności.</p>
      </div>

      <div class="footer-links">
        <h3>Przydatne linki</h3>
        <ul>
          <li><a href="index.html">Strona główna</a></li>
          <li><a href="oferty.html">Oferty</a></li>
          <li><a href="dodaj.html">Dodaj ofertę</a></li>
          <li><a href="#contact">Kontakt</a></li>
        </ul>
      </div>

      <div class="footer-contact">
        <h3>Kontakt</h3>
        <p><i class="fas fa-envelope"></i> info@dzialkofert.pl</p>
        <p><i class="fas fa-phone"></i> +48 123 456 789</p>
      </div>
    </div>

    <div class="footer-bottom">
      © 2025 Działkofert. Wszelkie prawa zastrzeżone.
    </div>
  </div>
</footer>


  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
      authDomain: "base-468e0.firebaseapp.com",
      projectId: "base-468e0",
      storageBucket: "base-468e0.firebasestorage.app",
      messagingSenderId: "829161895559",
      appId: "1:829161895559:web:d832541aac05b35847ea22"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
  </script>











 <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
  let map;
  let markers = [];
  let markerCluster;
  let allOffers = [];

  // jedno, globalne InfoWindow – NIGDY nie tworzymy wielu
  window.infoWin = null;

  // ====== HELPERS ======
  function infoHTML(plot, data, offerId, plotIndex) {
    const price = Number(plot.price || 0);
    const area  = Number(plot.pow_dzialki_m2_uldk || 0);
    const ppm2  = price && area ? (price/area).toFixed(0) : null;
    const city  = data.city || "brak";
    const phone = data.phone || "brak";
    const detailsUrl = `oferta.html?id=${offerId}&plot=${plotIndex}`;

    return `
      <div class="map-info-window">
        <h3>${plot.Id || "Brak identyfikatora"}</h3>
        <p><b>Miejscowość:</b> ${city}</p>
        ${price ? `<p><b>Cena:</b> ${price.toLocaleString('pl-PL')} zł${ppm2 ? ` <span style="color:#718096;">(${ppm2} zł/m²)</span>` : ''}</p>` : ''}
        ${area  ? `<p><b>Powierzchnia:</b> ${area.toLocaleString('pl-PL')} m²</p>` : ''}
        <p><b>Telefon:</b> ${phone}</p>
        <div class="mini-actions center">
          <a class="btn-mini" target="_blank" href="${detailsUrl}">Szczegóły</a>
        </div>
      </div>
    `;
  }

  function openInfo(marker, html) {
    if (!window.infoWin) window.infoWin = new google.maps.InfoWindow();
    window.infoWin.setContent(html);
    window.infoWin.open(map, marker);
  }

  // ====== MAPA ======
  async function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 52.0, lng: 19.0 },
      zoom: 6,
      gestureHandling: "greedy",
      mapTypeId: google.maps.MapTypeId.HYBRID
    });

    google.maps.event.addListener(map, "idle", () => filterOffersByBounds());
    await loadOffers();

    // delikatny zoom kółkiem (opcjonalne)
    const mapContainer = document.getElementById('map');
    mapContainer.addEventListener('wheel', function(e) {
      if (e.target.closest('.gm-style')) {
        e.preventDefault();
        const delta = e.deltaY || e.detail || (-e.wheelDelta);
        const currentZoom = map.getZoom();
        map.setZoom(delta < 0 ? currentZoom + 0.5 : currentZoom - 0.5);
      }
    }, { passive: false });
  }

  async function loadOffers() {
    try {
      const snapshot = await window.getDocs(window.collection(window.db, "propertyListings"));
      const listContainer = document.getElementById("offersList");
      listContainer && (listContainer.innerHTML = "");

      // reset
      allOffers = [];
      markers.forEach(m => m.setMap(null));
      markers = [];
      const plotPolygons = [];

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.plots || !data.plots.length) return;

        data.plots.forEach((plot, index) => {
          // POKAZUJ wszystko oprócz jawnie ukrytych
          if (plot.mock === false) return;

          const lat = plot.lat, lng = plot.lng;
          const geometry = plot.geometry_uldk;
          const offerId = docSnap.id;

          // marker
          const marker = new google.maps.Marker({
            position: { lat, lng }, map,
            title: data.firstName || "Oferta",
            icon: { url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png" }
          });
          markers.push(marker);

          // klik w marker → InfoWindow + „Szczegóły”
          marker.addListener('click', () => openInfo(marker, infoHTML(plot, data, offerId, index)));

          // polygon (pokazywany od określonego zoomu)
          let polygon = null;
          if (geometry) {
            const coords = parseGeometry(geometry);
            if (coords.length) {
              polygon = new google.maps.Polygon({
                paths: coords,
                strokeColor: "#FF0000",
                strokeOpacity: 0.9,
                strokeWeight: 3,
                fillColor: "#FF0000",
                fillOpacity: 0.15,
                map: null, visible: false
              });
              polygon.addListener('click', (evt) => {
                // klik w obrys także otwiera JEDNO info okno
                const fakeMarker = new google.maps.Marker({ position: evt.latLng, map: null });
                openInfo(fakeMarker, infoHTML(plot, data, offerId, index));
              });
              plotPolygons.push({ polygon, bounds: getPolygonBounds(coords), marker });
            }
          }

          // zapisz wpis
          allOffers.push({ id: offerId, data, plot, index, marker, polygon });
        });
      });

      // klastrowanie
      if (markerCluster) markerCluster.clearMarkers();
      markerCluster = new markerClusterer.MarkerClusterer({
        map, markers,
        renderer: {
          render: ({ count, position }) => {
            return new google.maps.Marker({
              position,
              label: { text: String(count), color: "white", fontSize: "14px", fontWeight: "bold" },
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 20,
                fillColor: "red",
                fillOpacity: 0.85,
                strokeColor: "red",
                strokeWeight: 2
              }
            });
          }
        }
      });

      // polygony od zoom >= 8
      google.maps.event.addListener(map, 'zoom_changed', () => {
        const show = map.getZoom() >= 8;
        plotPolygons.forEach(p => {
          if (!p.polygon) return;
          p.polygon.setMap(show ? map : null);
          p.polygon.setVisible(!!show);
        });
      });

      filterOffersByBounds();
    } catch (err) {
      console.error("Błąd pobierania ofert:", err);
    }
  }

  // widoczność listy wg granic + SZCZEGÓŁY na środku
  function filterOffersByBounds() {
    if (!map || !allOffers.length) return;
    const bounds = map.getBounds();
    if (!bounds) return;

    const visibleOffers = allOffers.filter(o => bounds.contains(o.marker.getPosition()));
    const listContainer = document.getElementById("offersList");
    if (!listContainer) return;

    listContainer.innerHTML = "";
    if (!visibleOffers.length) {
      listContainer.innerHTML = '<p class="no-offers">Brak ofert w widocznym obszarze</p>';
      return;
    }

    visibleOffers.forEach(o => {
      const card = document.createElement("div");
      card.className = "offer-card";
      const price = Number(o.plot.price || 0);
      const area  = Number(o.plot.pow_dzialki_m2_uldk || 0);
      const ppm2  = price && area ? (price/area).toFixed(2) : "0.00";
      const detailsUrl = `oferta.html?id=${o.id}&plot=${o.index}`;

      card.innerHTML = `
        <h5>${o.plot.Id || "Brak identyfikatora"}</h5>
        ${o.data.city ? `<p><b>Miejscowość:</b> ${o.data.city}</p>` : ""}
        <p><b>Telefon:</b> ${o.data.phone || "-"}</p>
        ${price ? `<p><b>Cena całkowita:</b> ${price.toLocaleString('pl-PL')} zł <span style="color:#888;font-size:.85em;margin-left:5px;">${ppm2} zł/m²</span></p>` : ""}
        ${area  ? `<p><b>Powierzchnia:</b> ${area.toLocaleString('pl-PL')} m²</p>` : ""}
        <div class="offer-actions center">
          <a class="btn btn-accent btn-sm" target="_blank" href="${detailsUrl}">
            <i class="fas fa-info-circle"></i> Szczegóły
          </a>
        </div>
      `;

      // klik w kartę (publiczną) → ogniskuj na mapie + InfoWindow
      card.addEventListener("click", (e) => {
        // jeśli klik to „Szczegóły” – nie ogniskuj mapy
        if (e.target.closest('a')) return;
        map.panTo(o.marker.getPosition());
        map.setZoom(Math.max(16, map.getZoom()));
        openInfo(o.marker, infoHTML(o.plot, o.data, o.id, o.index));
      });

      listContainer.appendChild(card);
    });
  }

  // EPSG:2180 -> WGS84
  function parseGeometry(geometryString) {
    const coords = [];
    try {
      proj4.defs("EPSG:2180", "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");
      const coordString = geometryString.match(/\(\(([^)]+)\)\)/)[1];
      const points = coordString.split(',');
      points.forEach(point => {
        const [xStr, yStr] = point.trim().split(' ');
        const x = parseFloat(xStr), y = parseFloat(yStr);
        const [lng, lat] = proj4("EPSG:2180", "WGS84", [x, y]);
        coords.push({ lat, lng });
      });
    } catch (e) { console.error("Błąd parsowania geometrii:", e, geometryString); }
    return coords;
  }

  function getPolygonBounds(coords) {
    const bounds = new google.maps.LatLngBounds();
    coords.forEach(c => bounds.extend(c));
    return bounds;
  }

  // PUBLIC: focus z „Moje Oferty”
  window.focusOfferOnMap = function(offerId, plotIndex) {
    const match = allOffers.find(o => o.id === offerId && o.index === plotIndex);
    if (!match || !map) return;
    map.panTo(match.marker.getPosition());
    map.setZoom(17);
    openInfo(match.marker, infoHTML(match.plot, match.data, match.id, match.index));
    document.querySelector('.map-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  // ładowanie Google Maps
  function loadGoogleMaps() {
    const apiKey = localStorage.getItem('googleMapsApiKey') || 'AIzaSyCr5TmFxnT3enxmyr6vujF8leP995giw8I';
    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
    script.async = true; script.defer = true;
    document.head.appendChild(script);
  }
  document.addEventListener("DOMContentLoaded", loadGoogleMaps);
</script>




<script type="module">
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
    GoogleAuthProvider, signInWithPopup, signInWithRedirect,
    setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc,
    collection, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- KONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
    authDomain: "base-468e0.firebaseapp.com",
    projectId: "base-468e0",
    storageBucket: "base-468e0.firebasestorage.app",
    messagingSenderId: "829161895559",
    appId: "1:829161895559:web:d832541aac05b35847ea22"
  };

  // --- INIT ---
  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  auth.languageCode = 'pl';

  try { await setPersistence(auth, browserLocalPersistence); }
  catch { try { await setPersistence(auth, browserSessionPersistence); }
  catch { await setPersistence(auth, inMemoryPersistence); } }

  const googleProvider = new GoogleAuthProvider();
  googleProvider.setCustomParameters({ prompt: 'select_account' });

  // --- DOM ---
  const authButtons   = document.getElementById('authButtons');
  const userMenu      = document.getElementById('userMenu');
  const loginBtn      = document.getElementById('loginBtn');
  const registerBtn   = document.getElementById('registerBtn');
  const accountBtn    = document.getElementById('accountBtn');
  const logoutBtn     = document.getElementById('logoutBtn');

  const loginModal    = document.getElementById('loginModal');
  const registerModal = document.getElementById('registerModal');
  const closeBtns     = document.querySelectorAll('.modal-close');
  const switchToRegister = document.getElementById('switchToRegister');
  const switchToLogin    = document.getElementById('switchToLogin');

  const loginForm     = document.getElementById('loginForm');
  const registerForm  = document.getElementById('registerForm');

  const userDashboard = document.getElementById('userDashboard');
  const userOffers    = document.getElementById('userOffers');

  const googleBtnRegister = document.getElementById('googleLoginBtn');
  const googleBtnLogin    = document.getElementById('googleLoginBtnLogin');

  // --- POMOCNICZE UI ---
  const openModal  = (m) => m && (m.style.display = 'flex');
  const closeModal = (m) => m && (m.style.display = 'none');

  // Pokaż ostrzeżenie o domenie (jeśli nie jest autoryzowana w Firebase)
  const domainWarning = document.getElementById('domainWarning');
  const okDomains = ['localhost','127.0.0.1','trainingtwenty5.github.io','twojadomena.pl'];
  if (domainWarning && !okDomains.includes(location.hostname)) domainWarning.style.display = 'block';

  function renderMobileAuth(user) {
    const navMenu = document.querySelector('.nav-menu');
    const mobileAuthC = document.getElementById('mobileAuth');
    if (!mobileAuthC) return;

    if (user) {
      const label = user.displayName ? user.displayName.split(' ')[0] : (user.email || 'Użytkownik');
      mobileAuthC.innerHTML = `
        <div class="nav-link" style="font-weight:600;">
          <i class="fas fa-user"></i> ${label}
        </div>
        <a href="#userDashboard" class="nav-link" id="mobileAccountLink">Moje konto</a>
        <button class="btn btn-secondary" id="mobileLogoutBtn" style="width:100%;">
          <i class="fas fa-sign-out-alt"></i> Wyloguj się
        </button>
      `;
    } else {
      mobileAuthC.innerHTML = `
        <a href="#" id="loginLink" class="nav-link">Zaloguj się</a>
        <a href="#" id="registerLink" class="nav-link">Zarejestruj się</a>
      `;
    }

    const loginLink = document.getElementById('loginLink');
    const registerLink = document.getElementById('registerLink');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const mobileAccountLink = document.getElementById('mobileAccountLink');

    loginLink && loginLink.addEventListener('click', (e) => {
      e.preventDefault();
      openModal(loginModal);
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
    });

    registerLink && registerLink.addEventListener('click', (e) => {
      e.preventDefault();
      openModal(registerModal);
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
    });

    mobileLogoutBtn && mobileLogoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); } catch(e){ console.error(e); }
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
    });

    mobileAccountLink && mobileAccountLink.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('userDashboard')?.scrollIntoView({behavior:'smooth'});
      navMenu?.classList.remove('active');
      mobileAuthC.style.display = 'none';
    });

    mobileAuthC.style.display = navMenu?.classList.contains('active') ? 'flex' : 'none';
  }

  // --- HANDLERY MODALI (desktop) ---
  loginBtn    && loginBtn.addEventListener('click', () => openModal(loginModal));
  registerBtn && registerBtn.addEventListener('click', () => openModal(registerModal));

  // Przełączanie między modalami
  switchToRegister && switchToRegister.addEventListener('click', (e) => {
    e.preventDefault(); closeModal(loginModal);  openModal(registerModal);
  });
  switchToLogin && switchToLogin.addEventListener('click', (e) => {
    e.preventDefault(); closeModal(registerModal); openModal(loginModal);
  });

  // Zamknięcie X i klik w tło
  closeBtns.forEach(b => b.addEventListener('click', () => closeModal(b.closest('.modal'))));
  window.addEventListener('click', (e) => {
    if (e.target.classList?.contains('modal')) closeModal(e.target);
  });

  // --- ŁADNE BŁĘDY ---
  const niceErr = (err) => {
    switch (err?.code) {
      case 'auth/invalid-email': return 'Nieprawidłowy adres e-mail.';
      case 'auth/missing-password': return 'Podaj hasło.';
      case 'auth/user-not-found':
      case 'auth/wrong-password':
      case 'auth/invalid-credential': return 'Nieprawidłowy e-mail lub hasło.';
      case 'auth/too-many-requests': return 'Za dużo prób. Spróbuj później.';
      case 'auth/unauthorized-domain': return `Domena ${location.hostname} nie jest dodana w Firebase (Authorized domains).`;
      case 'auth/popup-blocked': return 'Przeglądarka zablokowała okno logowania Google.';
      case 'auth/operation-not-supported-in-this-environment': return 'Uruchom stronę przez http/https (nie file://).';
      default: return 'Błąd: ' + (err?.code || err?.message || 'nieznany');
    }
  };

  // --- E-mail/hasło ---
  loginForm && loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    try { await signInWithEmailAndPassword(auth, email, pass); closeModal(loginModal); }
    catch (err) { showToast(niceErr(err)); }
  });

  registerForm && registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name  = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const pass1 = document.getElementById('registerPassword').value;
    const pass2 = document.getElementById('registerConfirmPassword').value;
    if (pass1 !== pass2) return showToast('Hasła nie są identyczne!');
    try {
      const { user } = await createUserWithEmailAndPassword(auth, email, pass1);
      if (name) await updateProfile(user, { displayName: name });
      await setDoc(doc(db, "users", user.uid), {
        name: name || null, email, createdAt: new Date(), provider: 'password'
      }, { merge: true });
      closeModal(registerModal);
    } catch (err) { showToast(niceErr(err)); }
  });

  // --- Google ---
  async function signInWithGoogleSmart() {
    if (!['http:', 'https:'].includes(location.protocol))
      return showToast('Uruchom stronę przez http/https (nie file://).');
    try {
      const res = await signInWithPopup(auth, googleProvider);
      const user = res.user;
      const uref = doc(db, "users", user.uid);
      const udoc = await getDoc(uref);
      if (!udoc.exists()) {
        await setDoc(uref, { name: user.displayName, email: user.email, createdAt: new Date(), provider: 'google' });
      }
      closeModal(loginModal); closeModal(registerModal);
    } catch (err) {
      if (['auth/popup-blocked','auth/operation-not-supported-in-this-environment'].includes(err?.code)) {
        await signInWithRedirect(auth, googleProvider);
      } else {
        showToast(niceErr(err));
      }
    }
  }
  [googleBtnRegister, googleBtnLogin].forEach(btn =>
    btn && btn.addEventListener('click', (e) => { e.preventDefault(); signInWithGoogleSmart(); })
  );

  // --- STAN LOGOWANIA ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      authButtons && (authButtons.style.display = 'none');
      userMenu    && (userMenu.style.display   = 'flex');
      userDashboard && (userDashboard.style.display = 'block');

      accountBtn  && (accountBtn.innerHTML = `<i class="fas fa-user me-1"></i> ${user.displayName || user.email}`);
      accountBtn  && accountBtn.addEventListener('click', () => {
        location.hash = '#userDashboard';
        userDashboard?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, { once: true });

      try { await loadUserOffers(user.email || null, user.uid || null); } catch(e){ console.error(e); }
      closeModal(loginModal); closeModal(registerModal);
    } else {
      authButtons && (authButtons.style.display = 'flex');
      userMenu    && (userMenu.style.display   = 'none');
      userDashboard && (userDashboard.style.display = 'none');
      userOffers && (userOffers.innerHTML = '');
    }
    renderMobileAuth(user);
  });

  // --- WYLOGOWANIE ---
  logoutBtn && logoutBtn.addEventListener('click', async () => {
    try { await signOut(auth); } catch(_) {}
  });
  
  
  
  
  
  
  
  

  // --- „Miękkie usuwanie” i ładowanie ofert (jeśli używasz) ---
async function loadUserOffers(email, uid) {
  try {
    const emailFields = ['email', 'userEmail', 'ownerEmail', 'createdByEmail', 'contactEmail'];
    const idFields    = ['userUid', 'uid', 'userId', 'ownerId', 'createdBy'];

    userOffers.innerHTML = '<p>Ładuję Twoje oferty…</p>';

    // Zbierz WSZYSTKIE pasujące dokumenty z wielu zapytań i zdeduplikuj po id
    const results = new Map(); // id -> QueryDocumentSnapshot

    // — po e-mailu (uwzględnij różne wielkości liter)
    if (email) {
      const variants = [...new Set([email, email.toLowerCase()])];
      for (const field of emailFields) {
        for (const val of variants) {
          try {
            const s = await getDocs(query(collection(db, 'propertyListings'), where(field, '==', val)));
            s.forEach(d => results.set(d.id, d));
          } catch (e) {
            console.warn('Email query failed for', field, e);
          }
        }
      }
    }

    // — po UID
    if (uid) {
      for (const field of idFields) {
        try {
          const s = await getDocs(query(collection(db, 'propertyListings'), where(field, '==', uid)));
          s.forEach(d => results.set(d.id, d));
        } catch (e) {
          console.warn('UID query failed for', field, e);
        }
      }
    }

    userOffers.innerHTML = '';

    if (results.size === 0) {
      userOffers.innerHTML = '<p>Nie masz jeszcze żadnych aktywnych ofert.</p>';
      return;
    }

    // Render (twój fragment bez zmian poza źródłem danych)
    Array.from(results.values()).forEach((docu) => {
      const offer  = docu.data();
      const offerId = docu.id;
      if (!Array.isArray(offer.plots) || offer.plots.length === 0) return;

      const activePlots = offer.plots
        .map((plot, originalIndex) => ({ plot, originalIndex }))
        .filter(({ plot }) => plot?.mock !== false);

      activePlots.forEach(({ plot, originalIndex }, i) => {
        const price = Number(plot.price || 0);
        const area  = Number(plot.pow_dzialki_m2_uldk || plot.area || plot.areaM2 || 0);
        const ppm2  = price && area ? Math.round(price/area) : 0;
        const detailsUrl = `oferta.html?id=${offerId}&plot=${originalIndex}`;

        const el = document.createElement('div');
        el.className = 'offer-card';
        el.innerHTML = `
          <h3 class="offer-title">${plot.Id || `Działka ${i+1}`}</h3>
          <div class="offer-details">
            <p><strong>Lokalizacja:</strong> ${offer.city || offer.location?.city || 'Nie podano'}</p>
            ${area  ? `<p><strong>Powierzchnia:</strong> ${area.toLocaleString('pl-PL')} m²</p>` : ''}
            ${price ? `<p><strong>Cena całkowita:</strong> ${price.toLocaleString('pl-PL')} zł
              ${ppm2 ? `<span style="color:#888;font-size:.85em;margin-left:5px;">${ppm2.toLocaleString('pl-PL')} zł/m²</span>`:''}
            </p>` : ''}
          </div>
          <div class="offer-actions">
            <a class="btn btn-accent btn-sm" target="_blank" href="${detailsUrl}">
              <i class="fas fa-info-circle"></i> Szczegóły
            </a>
            <button class="btn btn-primary btn-sm" onclick="window.location.href='dodaj.html?edit=${offerId}&plot=${originalIndex}'">
              <i class="fas fa-edit"></i> Edytuj
            </button>
            <button class="btn btn-secondary btn-sm" onclick="deletePlot && deletePlot('${offerId}', ${originalIndex}, '${(plot.Id||`Działka ${i+1}`).replace(/'/g,"\\'")}')">
              <i class="fas fa-trash"></i> Usuń
            </button>
          </div>
        `;
        el.addEventListener('click', (e) => {
          if (e.target.closest('.offer-actions')) return;
          window.focusOfferOnMap?.(offerId, originalIndex);
        });
        userOffers.appendChild(el);
      });
    });

    if (!userOffers.querySelector('.offer-card')) {
      userOffers.innerHTML = '<p>Nie masz jeszcze żadnych aktywnych ofert.</p>';
    }
  } catch (error) {
    console.error('Error loading offers: ', error);
    userOffers.innerHTML = '<p>Wystąpił błąd podczas ładowania ofert.</p>';
  }
}



  // --- EXPORTY DLA ZWYKŁYCH SKRYPTÓW (jeśli używasz poza module) ---
  window.db = db;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.where = where;
  window.doc       = doc;
  window.updateDoc = updateDoc;
  window.getDoc    = getDoc;
</script>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const navMenu = document.querySelector('.nav-menu');
    const mobileAuth = document.getElementById('mobileAuth');

    mobileMenuBtn?.addEventListener('click', function () {
      navMenu.classList.toggle('active');
      if (mobileAuth) {
        mobileAuth.style.display = navMenu.classList.contains('active') ? 'flex' : 'none';
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        navMenu.classList.remove('active');
        if (mobileAuth) mobileAuth.style.display = 'none';
      }
    });
  });
</script>


</body>
</html>

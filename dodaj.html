<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grunteo - Dodaj darmowe ogłoszenie</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/logo-mark.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/favicon-16x16.png" />
  <link rel="manifest" href="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/site.webmanifest" />
  <link rel="mask-icon" href="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/safari-pinned-tab.svg" color="#0c0d11" />
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/favicon.ico" />
  <meta name="apple-mobile-web-app-title" content="Grunteo" />
  <meta name="application-name" content="Grunteo" />
  <meta name="msapplication-TileColor" content="#0c0d11" />
  <meta name="msapplication-config" content="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/browserconfig.xml" />
  <meta name="theme-color" content="#0c0d11" />
  <meta property="og:image" content="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/og-image.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="Logo Grunteo" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/og-image.png" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Firebase SDK (APP, Firestore, Analytics, Auth) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
      authDomain: "base-468e0.firebaseapp.com",
      projectId: "base-468e0",
      storageBucket: "base-468e0.firebasestorage.app",
      messagingSenderId: "829161895559",
      appId: "1:829161895559:web:d832541aac05b35847ea22"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Udostępniamy do zwykłych skryptów
    window.db = db;
    window.addDoc = addDoc;
    window.collection = collection;
    window.getDoc = getDoc;
    window.doc = doc;
    window.setDoc = setDoc;
    window.auth = auth;
  </script>

  <link rel="stylesheet" href="assets/main.css">
  <link rel="stylesheet" href="assets/header.css">
  <link rel="stylesheet" href="assets/dodaj.css">
  <link rel="stylesheet" href="assets/form.css">
</head>

  <body style="padding-top: calc(var(--topbar-height) + var(--header-height));" onload="loadGoogleMaps()">
    <!-- Top Navbar (desktop) -->
    <div class="top-navbar">
      <div class="contact-info">
        <i class="fas fa-clock"></i> Poniedziałek - Piątek 9:00 - 18:00
        <span><i class="fas fa-phone"></i> +48 505 849 404</span>
      </div>

      <div class="auth-buttons" id="authButtons">
        <button class="btn btn-outline-primary btn-sm" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i> Zaloguj się
        </button>
        <button class="btn btn-primary btn-sm" id="registerBtn">
          <i class="fas fa-user-plus"></i> Zarejestruj się
        </button>
      </div>

      <div class="user-menu" id="userMenu" style="display:none;">
        <button class="btn btn-outline-primary btn-sm" id="accountBtn">
          <i class="fas fa-user"></i> Moje konto
        </button>
        <button class="btn btn-secondary btn-sm" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Wyloguj
        </button>
      </div>
    </div>

    <!-- Header + Nawigacja -->
    <header>
      <a href="index.html" class="logo">
        <img src="https://raw.githubusercontent.com/trainingtwenty5/karuzo/main/brand/logo-horizontal-dark.svg" alt="Logo serwisu">
      </a>

      <nav class="desktop-nav">
        <a href="index.html" class="nav-link">Strona główna</a>
        <a href="oferty.html" class="nav-link">Oferty</a>
        <a href="dodaj.html" class="nav-link active">Dodaj</a>
        <a href="Kontakt.html" class="nav-link">Kontakt</a>
      </nav>

      <a href="dodaj.html" class="desktop-add-offer">
        <i class="fas fa-plus"></i> Dodaj ofertę
      </a>

      <a href="dodaj.html" class="mobile-add-offer">
        <i class="fas fa-plus"></i> Dodaj ofertę
      </a>

      <button class="mobile-menu-btn" aria-label="Otwórz menu">
        <i class="fas fa-bars"></i>
      </button>

      <nav class="nav-menu">
        <a href="index.html" class="nav-link">Strona główna</a>
        <a href="oferty.html" class="nav-link">Oferty</a>
        <a href="dodaj.html" class="nav-link active">Dodaj</a>
        <a href="Kontakt.html" class="nav-link">Kontakt</a>

        <!-- Miejsce na elementy auth w menu mobilnym -->
        <div class="mobile-auth" id="mobileAuth" style="display:none;"></div>
      </nav>
    </header>
    <!-- Toasts -->
    <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal" role="dialog" aria-modal="true">
      <div class="confirm-box">
        <h3 class="confirm-title">Potwierdzenie</h3>
        <p class="confirm-message"></p>
        <div class="confirm-actions">
          <button class="confirm-btn confirm-cancel">Anuluj</button>
          <button class="confirm-btn confirm-yes">Usuń</button>
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Zaloguj się</h3>
          <button class="modal-close" aria-label="Zamknij">&times;</button>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Hasło</label>
            <input type="password" id="loginPassword" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Zaloguj się</button>
        </form>

        <div class="social-login">
          <button type="button" class="btn btn-google" id="googleLoginBtnLogin">
            <i class="fab fa-google"></i> Kontynuuj z Google
          </button>
        </div>

        <div class="form-footer">
          <p>Nie masz konta? <a href="#" id="switchToRegister">Zarejestruj się</a></p>
        </div>
      </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Utwórz konto</h3>
          <button class="modal-close" aria-label="Zamknij">&times;</button>
        </div>
        <form id="registerForm">
          <div class="form-group">
            <label for="registerName">Imię i nazwisko</label>
            <input type="text" id="registerName" required>
          </div>
          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" required>
          </div>
          <div class="form-group">
            <label for="registerPassword">Hasło</label>
            <input type="password" id="registerPassword" required>
          </div>
          <div class="form-group">
            <label for="registerConfirmPassword">Potwierdź hasło</label>
            <input type="password" id="registerConfirmPassword" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Zarejestruj się</button>
        </form>

        <div class="social-login mt-3 text-center">
          <button type="button" class="btn btn-google w-100 mb-2" id="googleLoginBtn">
            <i class="fab fa-google"></i> Kontynuuj z Google
          </button>
        </div>

        <div class="form-footer">
          <p>Masz już konto? <a href="#" id="switchToLogin">Zaloguj się</a></p>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        getAuth, onAuthStateChanged, signOut,
        signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
        GoogleAuthProvider, signInWithPopup, signInWithRedirect,
        setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const auth = getAuth();
      const db = getFirestore();

      async function useBestPersistence() {
        try { await setPersistence(auth, browserLocalPersistence); }
        catch { try { await setPersistence(auth, browserSessionPersistence); }
          catch { await setPersistence(auth, inMemoryPersistence); } }
      }
      await useBestPersistence();

      const googleProvider = new GoogleAuthProvider();
      googleProvider.setCustomParameters({ prompt: 'select_account' });

      const authButtons = document.getElementById('authButtons');
      const userMenu    = document.getElementById('userMenu');
      const loginBtn    = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      const accountBtn  = document.getElementById('accountBtn');
      const logoutBtn   = document.getElementById('logoutBtn');
      const loginModal  = document.getElementById('loginModal');
      const registerModal = document.getElementById('registerModal');
      const closeBtns   = document.querySelectorAll('.modal-close');
      const switchToReg = document.getElementById('switchToRegister');
      const switchToLog = document.getElementById('switchToLogin');
      const loginForm   = document.getElementById('loginForm');
      const registerForm= document.getElementById('registerForm');
      const mobileAuthC = document.getElementById('mobileAuth');
      const navMenu     = document.querySelector('.nav-menu');

      const openModal  = (m) => m && (m.style.display = 'flex');
      const closeModal = (m) => m && (m.style.display = 'none');

      function renderMobileAuth(user) {
        if (!mobileAuthC) return;
        if (user) {
          const label = user.displayName ? user.displayName.split(' ')[0] : (user.email || 'Użytkownik');
          mobileAuthC.innerHTML = `
            <div class="nav-link" style="font-weight:600;">
              <i class="fas fa-user"></i> ${label}
            </div>
            <button class="btn btn-secondary" id="mobileLogoutBtn" style="width:100%;">
              <i class="fas fa-sign-out-alt"></i> Wyloguj się
            </button>
          `;
          document.getElementById('mobileLogoutBtn')?.addEventListener('click', async () => {
            try { await signOut(auth); } catch(e){ console.error(e); }
            navMenu?.classList.remove('active');
            mobileAuthC.style.display = 'none';
          });
        } else {
          mobileAuthC.innerHTML = `
            <a href="#" id="loginLink" class="nav-link">Zaloguj się</a>
            <a href="#" id="registerLink" class="nav-link">Zarejestruj się</a>
          `;
          document.getElementById('loginLink')?.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(loginModal);
            navMenu?.classList.remove('active');
            mobileAuthC.style.display = 'none';
          });
          document.getElementById('registerLink')?.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(registerModal);
            navMenu?.classList.remove('active');
            mobileAuthC.style.display = 'none';
          });
        }
        mobileAuthC.style.display = navMenu?.classList.contains('active') ? 'flex' : 'none';
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          authButtons && (authButtons.style.display = 'none');
          userMenu    && (userMenu.style.display = 'flex');
          if (accountBtn) {
            const label = user.displayName || user.email || 'Moje konto';
            accountBtn.innerHTML = `<i class="fas fa-user"></i> ${label}`;
          }
          closeModal(loginModal); closeModal(registerModal);
        } else {
          authButtons && (authButtons.style.display = 'flex');
          userMenu    && (userMenu.style.display = 'none');
        }
        renderMobileAuth(user);
        window.currentUser = user || null;
        window.dispatchEvent(new CustomEvent('auth-state-changed', { detail: user }));
      });

      loginBtn?.addEventListener('click', () => openModal(loginModal));
      registerBtn?.addEventListener('click', () => openModal(registerModal));
      switchToReg?.addEventListener('click', (e) => { e.preventDefault(); closeModal(loginModal);  openModal(registerModal); });
      switchToLog?.addEventListener('click', (e) => { e.preventDefault(); closeModal(registerModal); openModal(loginModal); });
      closeBtns.forEach(b => b.addEventListener('click', () => closeModal(b.closest('.modal'))));
      window.addEventListener('click', (e) => { if (e.target.classList?.contains('modal')) closeModal(e.target); });
      logoutBtn?.addEventListener('click', async () => { try { await signOut(auth); } catch(e){ console.error(e); } });

      loginForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const pass  = document.getElementById('loginPassword').value;
        try { await signInWithEmailAndPassword(auth, email, pass); }
        catch (err) { alert(err.message); }
      });

      registerForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name  = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const pass1 = document.getElementById('registerPassword').value;
        const pass2 = document.getElementById('registerConfirmPassword').value;
        if (pass1 !== pass2) return alert('Hasła nie są identyczne!');
        try {
          const { user } = await createUserWithEmailAndPassword(auth, email, pass1);
          if (name) await updateProfile(user, { displayName: name });
          await setDoc(doc(db, 'users', user.uid), { name: name || null, email }, { merge: true });
        } catch (err) {
          alert(err.message);
        }
      });

      async function signInWithGoogleSmart() {
        const ok = location.protocol === 'https:';
        if (!ok) return alert('Uruchom stronę przez https (nie file://).');
        try {
          await signInWithPopup(auth, googleProvider);
          closeModal(loginModal); closeModal(registerModal);
          navMenu?.classList.remove('active');
          mobileAuthC?.setAttribute('style', 'display:none;');
        } catch (err) {
          if (err?.code === 'auth/popup-blocked' || err?.code === 'auth/operation-not-supported-in-this-environment') {
            await signInWithRedirect(auth, googleProvider);
          } else {
            alert(err.message);
          }
        }
      }
      document.getElementById('googleLoginBtn')?.addEventListener('click', (e) => { e.preventDefault(); signInWithGoogleSmart(); });
      document.getElementById('googleLoginBtnLogin')?.addEventListener('click', (e) => { e.preventDefault(); signInWithGoogleSmart(); });
    </script>

    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <div class="container-main">
      <!-- Mapa desktop -->
      <div class="map-container">
        <div id="map"></div>
        <div class="map-overlay map-overlay-desktop">
        <button id="clearPlotsBtn" class="btn-overlay">🗑️ Wyczyść punkty</button>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="autoSave" />
          <label class="form-check-label" for="autoSave">Auto-zapis</label>
        </div>
      </div>
    </div>

      <!-- Formularz -->
      <div class="form-container">
        <p class="form-heading">Dodaj darmowe ogłoszenie</p>
        <p class="lead text-center mb-4 d-none d-lg-block">Kliknij na mapę, aby wskazać lokalizację działki</p>

      <hr />

      <form id="propertyForm" class="mt-3">
        <div class="mb-3">
          <label for="firstName" class="form-label">Imię *</label>
          <input type="text" class="form-control" id="firstName" required />
        </div>

        <div class="mb-3">
          <label for="phone" class="form-label">Telefon *</label>
          <input type="tel" class="form-control" id="phone" required pattern="^(\+48\d{9}|\d{9})$" placeholder="Np. 505849404 lub +48505849404" />
          <div class="form-text">Numer telefonu: 9 cyfr lub +48 i 9 cyfr</div>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">E-mail *</label>
          <input type="email" class="form-control" id="email" required />
        </div>

        <div class="mb-3">
          <label for="city" class="form-label">Miejscowość *</label>
          <input type="text" class="form-control" id="city" required />
        </div>

        <div class="mb-3">
          <label for="price" class="form-label">Cena działki (zł)</label>
          <input type="number" class="form-control" id="price" />
        </div>

        <div id="selectedPlots"><p class="text-muted">Brak wskazanych działek.</p></div>

        <!-- MOBILE MAPA -->
        <div class="map-container mb-3 d-lg-none full-bleed-mobile">
          <p class="lead-over-map">Kliknij na mapę, aby wskazać lokalizację działki</p>
          <div id="map-mobile"></div>
          <div class="map-overlay map-overlay-mobile">
            <button id="clearPlotsBtnMobile" class="btn-overlay" aria-label="Wyczyść punkty">🗑️</button>
          </div>
        </div>

        <!-- ZGODY + SUBMIT -->
        <div class="consents-block">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="selectAllConsents" />
            <label class="form-check-label" for="selectAllConsents">Zaznacz wszystkie zgody</label>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="termsConsent" required />
            <label class="form-check-label" for="termsConsent">Zapoznałem się z <a href="RODO.html" target="_blank" rel="noopener">RODO</a> i <a href="polityka-prywatnosci.html" target="_blank" rel="noopener">Polityką prywatności</a> oraz akceptuję ich treść *</label>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="marketingConsent" />
            <label class="form-check-label" for="marketingConsent">Akceptuję zgodę marketingową</label>
          </div>

          <button type="submit" class="btn btn-primary w-100"><span id="submitText">Dodaj bezpłatne ogłoszenie</span></button>
        </div>
      </form>

      <div class="privacy-text">
        Za przetwarzanie danych osobowych podanych w formularzu odpowiada Grunteo, ul. Edwarda Suchardy 4, 50-362 Wrocław. Współadministratorem pozostaje Grunteo, ul. Edwarda Suchardy 4, 50-362 Wrocław. Zasady przetwarzania opisaliśmy w <a href="RODO.html" target="_blank" rel="noopener">Informacji RODO</a> oraz <a href="polityka-prywatnosci.html" target="_blank" rel="noopener">Polityce prywatności</a>. Masz prawo odwołać zgody w dowolnym momencie.
      </div>
  </div>
</div>

    <!-- Bootstrap + jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Skrypt: menu mobilne (toggle + zamykanie przy zmianie rozmiaru) -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const navMenu = document.querySelector('.nav-menu');
        const mobileAuth = document.getElementById('mobileAuth');

        mobileMenuBtn?.addEventListener('click', function () {
          navMenu.classList.toggle('active');
          if (mobileAuth) {
            mobileAuth.style.display = navMenu.classList.contains('active') ? 'flex' : 'none';
          }
        });

        window.addEventListener('resize', () => {
          if (window.innerWidth > 768) {
            navMenu.classList.remove('active');
            if (mobileAuth) mobileAuth.style.display = 'none';
          }
        });
      });
    </script>

    <script>
      /* ===== PERSISTENCJA FORMULARZA I PUNKTÓW ===== */
      const FORM_KEY = 'df.form.v1';
    const POINTS_KEY = 'df.points.v1';
    let isLoggedIn = false;

    function saveFormToStorage() {
      const data = {
        firstName: $('#firstName').val()?.trim() || '',
        phone:     $('#phone').val()?.trim() || '',
        email:     $('#email').val()?.trim() || '',
        city:      $('#city').val()?.trim() || '',
        price:     $('#price').val()?.trim() || '',
        termsConsent: $('#termsConsent').is(':checked'),
        marketingConsent: $('#marketingConsent').is(':checked')
      };
      localStorage.setItem(FORM_KEY, JSON.stringify(data));
    }

    function loadFormFromStorage() {
      const raw = localStorage.getItem(FORM_KEY);
      if (!raw) return;
      try {
        const d = JSON.parse(raw);
        if (d.firstName !== undefined) $('#firstName').val(d.firstName);
        if (d.phone     !== undefined) $('#phone').val(d.phone);
        if (d.email     !== undefined) $('#email').val(d.email);
        if (d.city      !== undefined) $('#city').val(d.city);
        if (d.price     !== undefined) $('#price').val(d.price);
        if (d.termsConsent !== undefined) $('#termsConsent').prop('checked', d.termsConsent);
        if (d.marketingConsent !== undefined) $('#marketingConsent').prop('checked', d.marketingConsent);
      } catch (_) {}
    }

    function persistSelectedPoints() { localStorage.setItem(POINTS_KEY, JSON.stringify(selectedPoints)); }
    function loadSelectedPointsFromStorage() {
      const raw = localStorage.getItem(POINTS_KEY);
      if (!raw) return;
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) { selectedPoints = arr; updateSelectedPointsList(); }
      } catch (_) {}
    }

    function restoreMarkersFromSelectedPoints() {
      if (!selectedPoints || selectedPoints.length === 0) return;
      selectedPoints.forEach((p) => {
        const latLng = new google.maps.LatLng(p.lat, p.lng);
        const markerObj = { id: p.id, labelOpen: false };

        if (desktopMap) {
          const desktopMarker = new google.maps.Marker({ position: latLng, map: desktopMap });
          const desktopInfoWindow = createMarkerInfoWindow(desktopMarker, desktopMap, {
            shouldOpen: false,
            onClose: () => handleMarkerLabelClose(markerObj)
          });
          desktopMarker.addListener('click', () => handleMarkerLabelOpen(markerObj));
          markerObj.desktopMarker = desktopMarker;
          markerObj.desktopInfoWindow = desktopInfoWindow;
        }

        if (mobileMap) {
          const mobileMarker  = new google.maps.Marker({ position: latLng, map: mobileMap });
          const mobileInfoWindow = createMarkerInfoWindow(mobileMarker, mobileMap, {
            shouldOpen: false,
            onClose: () => handleMarkerLabelClose(markerObj)
          });
          mobileMarker.addListener('click', () => handleMarkerLabelOpen(markerObj));
          markerObj.mobileMarker = mobileMarker;
          markerObj.mobileInfoWindow = mobileInfoWindow;
        }

        pointMarkers.push(markerObj);
      });

      updateMarkerLabels();
    }


      /* ===== UI: TOAST (vanilla) =====
         showToast('Oferta „...” została usunięta.', 'success')
         type: 'info' | 'success' | 'warning' | 'error'
      */
      function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const wrap = document.createElement('div');
        wrap.className = `toast-lite toast-${type}`;
        wrap.setAttribute('role', 'status');
        wrap.setAttribute('aria-live', 'polite');

        const icon = {
          success: '✓',
          info: 'ℹ',
          warning: '!',
          error: '✕'
        }[type] || 'ℹ';

        wrap.innerHTML = `
          <div class="toast-icon" aria-hidden="true">${icon}</div>
          <div class="toast-msg">${message}</div>
          <button class="toast-close" aria-label="Zamknij">&times;</button>
        `;

        const close = () => {
          wrap.classList.remove('show');
          setTimeout(() => wrap.remove(), 160);
        };
        wrap.querySelector('.toast-close').addEventListener('click', close);

        container.appendChild(wrap);
        requestAnimationFrame(() => wrap.classList.add('show'));

        const t = setTimeout(close, 4000);
        wrap.addEventListener('mouseenter', () => clearTimeout(t), { once: true });
      }

      function showConfirmModal(message) {
        return new Promise(resolve => {
          const modal = document.getElementById('confirmModal');
          if (!modal) return resolve(false);

          modal.querySelector('.confirm-message').textContent = message;
          modal.classList.add('show');

          const yesBtn = modal.querySelector('.confirm-yes');
          const cancelBtn = modal.querySelector('.confirm-cancel');

          const cleanup = () => {
            modal.classList.remove('show');
            yesBtn.removeEventListener('click', onYes);
            cancelBtn.removeEventListener('click', onCancel);
            modal.removeEventListener('click', onOutside);
          };

          const onYes = () => { cleanup(); resolve(true); };
          const onCancel = () => { cleanup(); resolve(false); };
          const onOutside = (e) => { if (e.target === modal) { cleanup(); resolve(false); } };

          yesBtn.addEventListener('click', onYes, { once: true });
          cancelBtn.addEventListener('click', onCancel, { once: true });
          modal.addEventListener('click', onOutside, { once: true });
        });
      }
      window.showConfirmModal = showConfirmModal;

    /* ===== WALIDACJA FORMULARZA ===== */
    function validateForm() {
      const firstName = $("#firstName").val().trim();
      const phone = $("#phone").val().trim();
      const email = $("#email").val().trim();
      const city = $("#city").val().trim();
      const termsConsent = $("#termsConsent").is(":checked");

      const phoneRegex = /^(\+48\d{9}|\d{9})$/;
      const emailValid = email.length > 0 && email.includes("@");

      if (!firstName || !phone || !emailValid || !city || !termsConsent) return false;
      if (!phoneRegex.test(phone)) {
        showToast("Numer telefonu musi być w formacie 505849404 lub +48505849404", "warning");
        return false;
      }
      return true;
    }

    /* ===== GOOGLE MAPS ===== */
    function loadGoogleMaps() {
      const apiKey = 'AIzaSyCr5TmFxnT3enxmyr6vujF8leP995giw8I';
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    let desktopMap, mobileMap;
    let selectedPoints = [];
    let pointMarkers = []; // {id, desktopMarker, mobileMarker, desktopInfoWindow, mobileInfoWindow, labelOpen}
    const MARKER_NOTE_TEXT = 'Po upływie 60 sekund od przesłania danych pinezka zmienia się w ogłoszenie z obrysem działki i edytowalnym opisem.';
    const SECOND_MARKER_NOTE_TEXT = 'Uwaga: w formularzu wpisujesz jedną cenę. Ta kwota domyślnie trafi do wszystkich dodawanych działek, ale po zalogowaniu możesz edytować ceny indywidualnie.';
    let isSaving = false;
    let lastCenter = { lat: 51.63538575429843, lng: 16.45740592647929 };
    let lastZoom = 17;

    function initMap() {
      const mapOptionsBase = {
        center: lastCenter,
        zoom: lastZoom,
        fullscreenControl: false,
        styles: [
          { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] },
          { featureType: "administrative.locality", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "water", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "road", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "poi", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "address", elementType: "labels.text", stylers: [{ visibility: "on" }] }
        ]
      };

      // Desktop
      const desktopEl = document.getElementById('map');
      if (desktopEl) {
        desktopMap = new google.maps.Map(desktopEl, { ...mapOptionsBase, streetViewControl: true });
        desktopMap.addListener('click', e => addPointToSelection(e.latLng));
        desktopMap.addListener('idle', () => {
          if (isVisible(desktopEl)) { const c = desktopMap.getCenter(); if (c) lastCenter = c.toJSON(); lastZoom = desktopMap.getZoom(); }
        });
        addWmsLayer(desktopMap, "dzialki");
        addWmsLayer(desktopMap, "numery_dzialek");
      }

      // Mobile
      const mobileEl = document.getElementById('map-mobile');
      if (mobileEl) {
        mobileMap = new google.maps.Map(mobileEl, { ...mapOptionsBase, streetViewControl: false });
        mobileMap.addListener('click', e => addPointToSelection(e.latLng));
        mobileMap.addListener('idle', () => {
          if (isVisible(mobileEl)) { const c = mobileMap.getCenter(); if (c) lastCenter = c.toJSON(); lastZoom = mobileMap.getZoom(); }
        });
        addWmsLayer(mobileMap, "dzialki");
        addWmsLayer(mobileMap, "numery_dzialek");
      }

      restoreMarkersFromSelectedPoints();
      handleResize();
    }

    function isVisible(el) { if (!el) return false; const style = window.getComputedStyle(el); return style && style.display !== 'none' && style.visibility !== 'hidden'; }

    let resizeTimer = null;
    function handleResize() {
      const desktopEl = document.getElementById('map');
      const mobileEl = document.getElementById('map-mobile');
      const useMobile = isVisible(mobileEl);
      const map = useMobile ? mobileMap : desktopMap;
      if (!map) return;
      map.setCenter(lastCenter);
      map.setZoom(lastZoom);
      google.maps.event.trigger(map, 'resize');
    }

    window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(handleResize, 150); });
    window.addEventListener('orientationchange', handleResize);

    function addWmsLayer(map, layerName) {
      const wmsUrl = "https://integracja.gugik.gov.pl/cgi-bin/KrajowaIntegracjaEwidencjiGruntow";
      const wmsMapType = new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
          const proj = map.getProjection();
          const zfactor = Math.pow(2, zoom);
          const ul = proj.fromPointToLatLng(new google.maps.Point(coord.x * 256 / zfactor, coord.y * 256 / zfactor));
          const lr = proj.fromPointToLatLng(new google.maps.Point((coord.x + 1) * 256 / zfactor, (coord.y + 1) * 256 / zfactor));
          const bbox = ul.lng() + "," + lr.lat() + "," + lr.lng() + "," + ul.lat();
          return wmsUrl +
            "?service=WMS&version=1.1.1&request=GetMap" +
            "&layers=" + layerName +
            "&styles=" +
            "&bbox=" + bbox +
            "&width=256&height=256" +
            "&srs=EPSG:4326" +
            "&format=image/png" +
            "&transparent=true";
        },
        tileSize: new google.maps.Size(256, 256),
        opacity: 0.7,
        name: layerName
      });
      map.overlayMapTypes.push(wmsMapType);
    }

    /* ===== POLSKA BOUNDS ===== */
    const POLAND_BOUNDS = { north: 55.0, south: 49.0, west: 14.1, east: 24.2 };
    function isInPoland(latLng) {
      return (
        latLng.lat() >= POLAND_BOUNDS.south &&
        latLng.lat() <= POLAND_BOUNDS.north &&
        latLng.lng() >= POLAND_BOUNDS.west &&
        latLng.lng() <= POLAND_BOUNDS.east
      );
    }

    function createMarkerInfoWindow(marker, map, { shouldOpen = true, onClose } = {}) {
      if (!marker || !map) return null;
      const infoWindow = new google.maps.InfoWindow({
        content: '',
        disableAutoPan: true,
        pixelOffset: new google.maps.Size(24, -28)
      });
      if (typeof onClose === 'function') {
        infoWindow.addListener('closeclick', onClose);
      }
      if (shouldOpen) {
        infoWindow.open({ anchor: marker, map });
      }
      return infoWindow;
    }

    function createMarkerLabelContent(index) {
      const noteSegments = [];
      if (index === 1) {
        noteSegments.push(MARKER_NOTE_TEXT);
      } else if (index === 2) {
        noteSegments.push(SECOND_MARKER_NOTE_TEXT);
      }

      const noteHtml = noteSegments.length
        ? `<div class="plot-marker-label__note">${noteSegments.map(text => `<p>${text}</p>`).join('')}</div>`
        : '';

      return `
        <div class="plot-marker-label">
          <div class="plot-marker-label__title">Działka nr ${index}</div>
          ${noteHtml}
        </div>
      `;
    }

    function handleMarkerLabelClose(markerObj) {
      if (!markerObj) return;
      if (markerObj.labelOpen !== false) {
        markerObj.labelOpen = false;
      }
      updateMarkerLabels();
    }

    function handleMarkerLabelOpen(markerObj) {
      if (!markerObj) return;
      if (markerObj.labelOpen !== true) {
        markerObj.labelOpen = true;
      }
      updateMarkerLabels();
    }

    function updateMarkerLabels() {
      if (!selectedPoints || selectedPoints.length === 0) {
        pointMarkers.forEach(markerObj => {
          if (markerObj.desktopInfoWindow) markerObj.desktopInfoWindow.close();
          if (markerObj.mobileInfoWindow) markerObj.mobileInfoWindow.close();
        });
        return;
      }
      selectedPoints.forEach((point, index) => {
        const markerObj = pointMarkers.find(m => m.id === point.id);
        if (!markerObj) return;
        const content = createMarkerLabelContent(index + 1);
        const shouldBeOpen = markerObj.labelOpen !== false;

        if (markerObj.desktopInfoWindow && markerObj.desktopMarker && desktopMap) {
          markerObj.desktopInfoWindow.setContent(content);
          if (shouldBeOpen) {
            markerObj.desktopInfoWindow.open({ anchor: markerObj.desktopMarker, map: desktopMap });
          } else {
            markerObj.desktopInfoWindow.close();
          }
        }

        if (markerObj.mobileInfoWindow && markerObj.mobileMarker && mobileMap) {
          markerObj.mobileInfoWindow.setContent(content);
          if (shouldBeOpen) {
            markerObj.mobileInfoWindow.open({ anchor: markerObj.mobileMarker, map: mobileMap });
          } else {
            markerObj.mobileInfoWindow.close();
          }
        }
      });
    }

    /* ===== PUNKTY / MARKERY ===== */
    function addPointToSelection(latLng) {
      if (!isInPoland(latLng)) { showToast("Możesz dodać punkt tylko na terenie Polski 🇵🇱", "warning"); return; }

      const pointId = 'point_' + Date.now();
      const point = { id: pointId, lat: latLng.lat(), lng: latLng.lng(), timestamp: new Date().toISOString() };
      selectedPoints.push(point);

      const markerObj = { id: pointId, labelOpen: true };
      if (desktopMap) {
        const desktopMarker = new google.maps.Marker({ position: latLng, map: desktopMap });
        const desktopInfoWindow = createMarkerInfoWindow(desktopMarker, desktopMap, {
          shouldOpen: true,
          onClose: () => handleMarkerLabelClose(markerObj)
        });
        desktopMarker.addListener('click', () => handleMarkerLabelOpen(markerObj));
        markerObj.desktopMarker = desktopMarker;
        markerObj.desktopInfoWindow = desktopInfoWindow;
      }
      if (mobileMap) {
        const mobileMarker  = new google.maps.Marker({ position: latLng, map: mobileMap });
        const mobileInfoWindow = createMarkerInfoWindow(mobileMarker, mobileMap, {
          shouldOpen: true,
          onClose: () => handleMarkerLabelClose(markerObj)
        });
        mobileMarker.addListener('click', () => handleMarkerLabelOpen(markerObj));
        markerObj.mobileMarker = mobileMarker;
        markerObj.mobileInfoWindow = mobileInfoWindow;
      }
      pointMarkers.push(markerObj);

      updateSelectedPointsList();
      persistSelectedPoints();

      // Auto-zapis: klik zapisuje i usuwa punkt
      if ($('#autoSave').is(':checked')) {
        const toSave = { lat: point.lat, lng: point.lng };
        removePlot(pointId);
        savePlots([toSave]);
      }
    }

    function removePlot(pointId) {
      selectedPoints = selectedPoints.filter(p => p.id !== pointId);
      const markerObj = pointMarkers.find(m => m.id === pointId);
      if (markerObj) {
        if (markerObj.desktopMarker) markerObj.desktopMarker.setMap(null);
        if (markerObj.mobileMarker)  markerObj.mobileMarker.setMap(null);
        if (markerObj.desktopInfoWindow) markerObj.desktopInfoWindow.close();
        if (markerObj.mobileInfoWindow)  markerObj.mobileInfoWindow.close();
      }
      pointMarkers = pointMarkers.filter(m => m.id !== pointId);
      updateSelectedPointsList();
      persistSelectedPoints();
    }

    function clearAllPoints() {
      selectedPoints = [];
      pointMarkers.forEach(m => {
        if (m.desktopMarker) m.desktopMarker.setMap(null);
        if (m.mobileMarker) m.mobileMarker.setMap(null);
        if (m.desktopInfoWindow) m.desktopInfoWindow.close();
        if (m.mobileInfoWindow)  m.mobileInfoWindow.close();
      });
      pointMarkers = [];
      updateSelectedPointsList();
      persistSelectedPoints();
    }

    function updateSelectedPointsList() {
      const container = document.getElementById('selectedPlots');
      if (selectedPoints.length === 0) {
        container.innerHTML = '<p class="text-muted">Brak wskazanych działek.</p>';
        updateMarkerLabels();
        return;
      }
      let html = '';
      selectedPoints.forEach((p, i) => {
        html += `
          <div class="plot-item">
            <span>Działka nr ${i + 1}</span>
            <button onclick="removePlot('${p.id}')" aria-label="Usuń działkę ${i+1}"><i class="fas fa-trash"></i></button>
          </div>`;
      });
      container.innerHTML = html;

      updateMarkerLabels();
    }

    /* ===== ZGODY – zaznacz wszystkie ===== */
    $("#selectAllConsents").on("change", function() {
      const checked = $(this).is(":checked");
      $("#termsConsent, #marketingConsent").prop("checked", checked);
    });
    $("#termsConsent, #marketingConsent").on("change", function() {
      if (!$("#termsConsent").is(":checked") || !$("#marketingConsent").is(":checked")) { $("#selectAllConsents").prop("checked", false); } else { $("#selectAllConsents").prop("checked", true); }
    });

    /* ===== BUDOWANIE DANYCH DO ZAPISU ===== */
    function buildFormData(points) {
      const user = window.currentUser || null;

      const firstName = $('#firstName').val().trim();
      const phone = $('#phone').val().trim();
      const email = $('#email').val().trim() || (user ? (user.email || '') : '');
      const city = $('#city').val().trim();
      const price = $('#price').val().trim();
      const termsConsent = $('#termsConsent').is(':checked');
      const marketingConsent = $('#marketingConsent').is(':checked');

      const base = {
          price,
          mock: true,
          plots: points.map(p => ({
            Id: "", idDzialki_uldk: "",
            lat: p.lat, lng: p.lng,
            mock: true,
            geometry_uldk: null,
            pow_dzialki_m2_uldk: null,
            price: price || "",
            termsConsent: termsConsent,
            timestamp: new Date()
          })),
          timestamp: new Date(),
          firstName,
          phone,
          email,
          city,
          termsConsent,
          marketingConsent
        };

        if (isLoggedIn) {
          base.userUid = user?.uid || '';
          base.userEmail = user?.email || '';
        }
        return base;
    }

    /* ===== ZAPIS DO FIRESTORE ===== */
    async function savePlots(points) {
      if (isSaving) return false;
      if (!points || points.length === 0) { showToast("Żadna działka nie jest zaznaczona.", "warning"); return false; }
      if (!validateForm()) { showToast("Uzupełnij wymagane pola.", "warning"); return false; }

      const formData = buildFormData(points);
      const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
      const submitText = document.getElementById('submitText');

      try {
        isSaving = true; if (submitBtn) submitBtn.disabled = true; if (submitText) submitText.textContent = "Zapisywanie...";
        await window.addDoc(window.collection(window.db, "propertyListings"), formData);
        showToast("Zapisano do bazy!", "success");
        return true;
      } catch (err) {
        showToast("Błąd zapisu: " + err.message, "error");
        return false;
      } finally {
        isSaving = false; if (submitBtn) submitBtn.disabled = false; if (submitText) submitText.textContent = "Dodaj bezpłatne ogłoszenie";
      }
    }

    async function saveToDatabase() {
      if (selectedPoints.length === 0) { showToast("Żadna działka nie jest zaznaczona. Dodaj co najmniej jeden punkt.", "warning"); return; }
      const ok = await savePlots([...selectedPoints]);
      if (ok) {
        clearAllPoints(); /* localStorage.removeItem(POINTS_KEY); */
        try {
          sessionStorage.setItem('grunteo.registerPrompt', JSON.stringify({
            openRegister: true,
            message: 'Po zalogowaniu się będziesz mógł edytować swoje ogłoszenie.'
          }));
        } catch (_) {}
        window.location.href = 'index.html';
      }
    }

    /* ===== POBIERANIE NUMERU TEL. UŻYTKOWNIKA ===== */
    async function fetchAndPrefillPhone(user) {
      if (!user) return;
      try {
        // Spróbuj w kolekcji 'users/{uid}'
        let snap = await window.getDoc(window.doc(window.db, 'users', user.uid));
        let phone = snap.exists() ? (snap.data().phone || snap.data().telefon) : '';

        // Jeżeli brak, spróbuj alternatywnie 'profiles/{uid}'
        if (!phone) {
          snap = await window.getDoc(window.doc(window.db, 'profiles', user.uid));
          if (snap.exists()) phone = snap.data().phone || snap.data().telefon || '';
        }

        if (phone && !$('#phone').val()) $('#phone').val(phone);
      } catch (e) {
        // cicho ignoruj – brak profilu to nie błąd krytyczny
      }
    }

    /* ===== TRYB LOGOWANIA – ukrywanie/wyświetlanie pól ===== */
    function toggleFieldsForAuth(user) {
      isLoggedIn = !!user;

      // Wymagane pola zawsze aktywne
      ['#firstName', '#phone', '#email', '#city'].forEach(sel => {
        const $wrap = $(sel).closest('.mb-3');
        $(sel).prop('readonly', false).prop('disabled', false).prop('required', true);
        $wrap.removeClass('d-none disabled-field');
      });

      // Pole ceny opcjonalne
      $('#price').prop('readonly', false).prop('disabled', false).prop('required', false)
        .closest('.mb-3').removeClass('d-none disabled-field');

      // Zgody zawsze widoczne i wymagane (RODO)
      $('#selectAllConsents').closest('.form-check').removeClass('d-none');
      $('#termsConsent').prop('required', true).closest('.form-check').removeClass('d-none');
      $('#marketingConsent').closest('.form-check').removeClass('d-none');

      // Autowartości z profilu zalogowanego użytkownika
      if (user?.email) $('#email').val(user.email);
      if (user?.displayName) $('#firstName').val(user.displayName);
      if (user) fetchAndPrefillPhone(user);

      // Po zalogowaniu imię i e-mail są tylko do odczytu
      if (user) {
        ['#firstName', '#email'].forEach(sel => {
          $(sel)
            .prop('readonly', true)
            .prop('disabled', true)
            .closest('.mb-3')
            .addClass('disabled-field');
        });
      }
    }

    window.addEventListener('auth-state-changed', (e) => toggleFieldsForAuth(e.detail));

    /* ===== READY ===== */
    $(document).ready(function() {
      loadFormFromStorage();
      loadSelectedPointsFromStorage();

      $('#propertyForm').on('input change', 'input, textarea, select', saveFormToStorage);

      $("#propertyForm").on("submit", function(e){ e.preventDefault(); saveToDatabase(); });

      $("#autoSave").on("change", async function () {
        if ($(this).is(":checked")) {
          if (!validateForm()) { showToast("Aby włączyć Auto-zapis, najpierw uzupełnij wymagane pola!", "warning"); $(this).prop("checked", false); return; }
          if (selectedPoints.length > 0) { const ok = await savePlots([...selectedPoints]); if (ok) clearAllPoints(); }
          showToast("Auto-zapis włączony. Nowe kliknięcia będą zapisywane automatycznie.", "success");
        } else {
          showToast("Auto-zapis wyłączony.", "info");
        }
      });

      $("#clearPlotsBtn, #clearPlotsBtnMobile").on("click", function(){ clearAllPoints(); });

      toggleFieldsForAuth(window.currentUser || null);
    });
	
	
	
  </script>
</body>
</html>

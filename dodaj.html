<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grunteo - Dodaj darmowe ogÅ‚oszenie</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Firebase SDK (APP, Firestore, Analytics, Auth) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
      authDomain: "base-468e0.firebaseapp.com",
      projectId: "base-468e0",
      storageBucket: "base-468e0.firebasestorage.app",
      messagingSenderId: "829161895559",
      appId: "1:829161895559:web:d832541aac05b35847ea22"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // UdostÄ™pniamy do zwykÅ‚ych skryptÃ³w
    window.db = db;
    window.addDoc = addDoc;
    window.collection = collection;
    window.getDoc = getDoc;
    window.doc = doc;
    window.auth = auth;

    // Emituj event o stanie logowania
    onAuthStateChanged(auth, (user) => {
      window.currentUser = user || null;
      window.dispatchEvent(new CustomEvent('auth-state-changed', { detail: user }));
    });
  </script>

  <link rel="stylesheet" href="assets/main.css">
  <link rel="stylesheet" href="assets/dodaj.css">
</head>

<body onload="loadGoogleMaps()">
  <div class="top-navbar">
    <div class="contact-info">
      <i class="fas fa-clock"></i> PoniedziaÅ‚ek - PiÄ…tek 9:00 - 18:00
      <span><i class="fas fa-phone"></i> +48 505 849 404</span>
    </div>

    <div class="auth-buttons" id="authButtons">
      <button class="btn btn-outline-primary btn-sm me-2" id="loginBtn">
        <i class="fas fa-sign-in-alt me-1"></i> Zaloguj siÄ™
      </button>
      <button class="btn btn-primary btn-sm" id="registerBtn">
        <i class="fas fa-user-plus me-1"></i> Zarejestruj siÄ™
      </button>
    </div>

    <div class="user-menu" id="userMenu" style="display:none;">
      <button class="btn btn-outline-primary btn-sm me-2" id="accountBtn">
        <i class="fas fa-user me-1"></i> Moje konto
      </button>
      <button class="btn btn-secondary btn-sm ms-2" id="logoutBtn">
        <i class="fas fa-sign-out-alt me-1"></i> Wyloguj
      </button>
    </div>
  </div>

  <header>
    <a href="index.html" class="logo">
      <img src="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Grunteo_logo.png" alt="Grunteo">
      <span>Grunteo</span>
    </a>

    <nav class="desktop-nav">
      <a href="index.html" class="nav-link">Strona gÅ‚Ã³wna</a>
      <a href="oferty.html" class="nav-link">Oferty</a>
      <a href="#contact" class="nav-link">Kontakt</a>
    </nav>

    <button class="mobile-menu-btn" aria-label="OtwÃ³rz menu">
      <i class="fas fa-bars"></i>
    </button>

    <nav class="nav-menu">
      <a href="index.html" class="nav-link">Strona gÅ‚Ã³wna</a>
      <a href="oferty.html" class="nav-link">Oferty</a>
      <a href="#contact" class="nav-link">Kontakt</a>
      <div class="mobile-auth" id="mobileAuth" style="display:none;"></div>
    </nav>
  </header>

  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <div class="container-main">
    <!-- Mapa desktop -->
    <div class="map-container">
      <div id="map"></div>
      <div class="map-overlay map-overlay-desktop">
        <button id="clearPlotsBtn" class="btn-overlay">ğŸ—‘ï¸ WyczyÅ›Ä‡ punkty</button>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="autoSave" />
          <label class="form-check-label" for="autoSave">Auto-zapis</label>
        </div>
      </div>
    </div>

    <!-- Formularz -->
    <div class="form-container">
      <h1 class="text-center mb-3">Dodaj darmowe ogÅ‚oszenie</h1>
      <p class="lead text-center mb-4 d-none d-lg-block">Kliknij na mapÄ™, aby wskazaÄ‡ lokalizacjÄ™ dziaÅ‚ki</p>

      <hr />

      <form id="propertyForm" class="mt-3">
        <div class="mb-3">
          <label for="firstName" class="form-label">ImiÄ™ *</label>
          <input type="text" class="form-control" id="firstName" required />
        </div>

        <div class="mb-3">
          <label for="phone" class="form-label">Telefon *</label>
          <input type="tel" class="form-control" id="phone" required pattern="^(\+48\d{9}|\d{9})$" placeholder="Np. 505849404 lub +48505849404" />
          <div class="form-text">Numer telefonu: 9 cyfr lub +48 i 9 cyfr</div>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">E-mail *</label>
          <input type="email" class="form-control" id="email" required />
        </div>

        <div class="mb-3">
          <label for="city" class="form-label">MiejscowoÅ›Ä‡ *</label>
          <input type="text" class="form-control" id="city" required />
        </div>

        <div class="mb-3">
          <label for="price" class="form-label">Cena dziaÅ‚ki (zÅ‚)</label>
          <input type="number" class="form-control" id="price" />
        </div>

        <div id="selectedPlots"><p class="text-muted">Brak wskazanych dziaÅ‚ek.</p></div>

        <!-- MOBILE MAPA -->
        <div class="map-container mb-3 d-lg-none full-bleed-mobile">
          <p class="lead-over-map">Kliknij na mapÄ™, aby wskazaÄ‡ lokalizacjÄ™ dziaÅ‚ki</p>
          <div id="map-mobile"></div>
          <div class="map-overlay map-overlay-mobile">
            <button id="clearPlotsBtnMobile" class="btn-overlay" aria-label="WyczyÅ›Ä‡ punkty">ğŸ—‘ï¸</button>
          </div>
        </div>

        <!-- ZGODY + SUBMIT -->
        <div class="consents-block">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="selectAllConsents" />
            <label class="form-check-label" for="selectAllConsents">Zaznacz wszystkie zgody</label>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="termsConsent" required />
            <label class="form-check-label" for="termsConsent">ZapoznaÅ‚em siÄ™ z <a href="#" target="_blank">RODO</a> i <a href="#" target="_blank">PolitykÄ… prywatnoÅ›ci</a> oraz akceptujÄ™ ich treÅ›Ä‡ *</label>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="marketingConsent" />
            <label class="form-check-label" for="marketingConsent">AkceptujÄ™ zgodÄ™ marketingowÄ…</label>
          </div>

          <button type="submit" class="btn btn-primary w-100"><span id="submitText">Dodaj bezpÅ‚atne ogÅ‚oszenie</span></button>
        </div>
      </form>

      <div class="privacy-text">
        Za przetwarzanie danych osobowych podanych w formularzu odpowiada Grunteo, ul. Edwarda Suchardy 4, 50-362 WrocÅ‚aw. WspÃ³Å‚administratorem pozostaje Grunteo, ul. Edwarda Suchardy 4, 50-362 WrocÅ‚aw. Zasady przetwarzania opisaliÅ›my tutaj: <a href="https://www.grunteo.pl/polityka-prywatnosci" target="_blank">www.grunteo.pl/polityka-prywatnosci</a>. Masz prawo odwoÅ‚aÄ‡ zgody w dowolnym momencie.
      </div>
  </div>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Zaloguj siÄ™</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">HasÅ‚o</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Zaloguj siÄ™</button>
      </form>
      <div class="social-login">
        <button type="button" class="btn btn-google" id="googleLoginBtnLogin">
          <i class="fab fa-google"></i> Kontynuuj z Google
        </button>
      </div>
      <div class="form-footer">
        <p>Nie masz konta? <a href="#" id="switchToRegister">Zarejestruj siÄ™</a></p>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>UtwÃ³rz konto</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="registerForm">
        <div class="form-group">
          <label for="registerName">ImiÄ™ i nazwisko</label>
          <input type="text" id="registerName" required>
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">HasÅ‚o</label>
          <input type="password" id="registerPassword" required>
        </div>
        <div class="form-group">
          <label for="registerConfirmPassword">PotwierdÅº hasÅ‚o</label>
          <input type="password" id="registerConfirmPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Zarejestruj siÄ™</button>
      </form>
      <div class="social-login mt-3 text-center">
        <button type="button" class="btn btn-google w-100 mb-2" id="googleLoginBtn">
          <i class="fab fa-google me-1"></i> Zaloguj przez Google
        </button>
      </div>
      <div class="domain-warning" id="domainWarning">
        <i class="fas fa-exclamation-triangle"></i>
        Uwaga: Logowanie przez Google moÅ¼e nie dziaÅ‚aÄ‡ na tej domenie.
        Aby rozwiÄ…zaÄ‡ ten problem, dodaj swojÄ… domenÄ™ w ustawieniach Firebase.
      </div>
      <div class="form-footer">
        <p>Masz juÅ¼ konto? <a href="#" id="switchToLogin">Zaloguj siÄ™</a></p>
      </div>
    </div>
  </div>

  <!-- Bootstrap + jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ===== PERSISTENCJA FORMULARZA I PUNKTÃ“W ===== */
    const FORM_KEY = 'df.form.v1';
    const POINTS_KEY = 'df.points.v1';
    let isLoggedIn = false;

    function saveFormToStorage() {
      const data = {
        firstName: $('#firstName').val()?.trim() || '',
        phone:     $('#phone').val()?.trim() || '',
        email:     $('#email').val()?.trim() || '',
        city:      $('#city').val()?.trim() || '',
        price:     $('#price').val()?.trim() || '',
        termsConsent: $('#termsConsent').is(':checked'),
        marketingConsent: $('#marketingConsent').is(':checked')
      };
      localStorage.setItem(FORM_KEY, JSON.stringify(data));
    }

    function loadFormFromStorage() {
      const raw = localStorage.getItem(FORM_KEY);
      if (!raw) return;
      try {
        const d = JSON.parse(raw);
        if (d.firstName !== undefined) $('#firstName').val(d.firstName);
        if (d.phone     !== undefined) $('#phone').val(d.phone);
        if (d.email     !== undefined) $('#email').val(d.email);
        if (d.city      !== undefined) $('#city').val(d.city);
        if (d.price     !== undefined) $('#price').val(d.price);
        if (d.termsConsent !== undefined) $('#termsConsent').prop('checked', d.termsConsent);
        if (d.marketingConsent !== undefined) $('#marketingConsent').prop('checked', d.marketingConsent);
      } catch (_) {}
    }

    function persistSelectedPoints() { localStorage.setItem(POINTS_KEY, JSON.stringify(selectedPoints)); }
    function loadSelectedPointsFromStorage() {
      const raw = localStorage.getItem(POINTS_KEY);
      if (!raw) return;
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) { selectedPoints = arr; updateSelectedPointsList(); }
      } catch (_) {}
    }

    function restoreMarkersFromSelectedPoints() {
      if (!selectedPoints || selectedPoints.length === 0) return;
      selectedPoints.forEach(p => {
        const latLng = new google.maps.LatLng(p.lat, p.lng);
        let desktopMarker = null, mobileMarker = null;
        if (desktopMap) desktopMarker = new google.maps.Marker({ position: latLng, map: desktopMap });
        if (mobileMap)  mobileMarker  = new google.maps.Marker({ position: latLng, map: mobileMap });
        pointMarkers.push({ id: p.id, desktopMarker, mobileMarker });
      });
    }

    /* ===== UI: TOAST ===== */
    function showToast(message, type = "info") {
      let bgClass = "bg-primary";
      if (type === "success") bgClass = "bg-success";
      if (type === "warning") bgClass = "bg-warning text-dark";
      if (type === "error")   bgClass = "bg-danger";

      const toast = $(`
        <div class="toast align-items-center text-white ${bgClass} border-0" role="showToast" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `);

      $(".toast-container").append(toast);
      const bsToast = new bootstrap.Toast(toast[0], { delay: 4000 });
      bsToast.show();
      toast.on("hidden.bs.toast", () => toast.remove());
    }

    /* ===== WALIDACJA FORMULARZA ===== */
    function validateForm() {
      const firstName = $("#firstName").val().trim();
      const phone = $("#phone").val().trim();
      const email = $("#email").val().trim();
      const city = $("#city").val().trim();
      const termsConsent = $("#termsConsent").is(":checked");

      const phoneRegex = /^(\+48\d{9}|\d{9})$/;
      const emailValid = email.length > 0 && email.includes("@");

      if (!firstName || !phone || !emailValid || !city || !termsConsent) return false;
      if (!phoneRegex.test(phone)) {
        showToast("Numer telefonu musi byÄ‡ w formacie 505849404 lub +48505849404", "warning");
        return false;
      }
      return true;
    }

    /* ===== GOOGLE MAPS ===== */
    function loadGoogleMaps() {
      const apiKey = 'AIzaSyCr5TmFxnT3enxmyr6vujF8leP995giw8I';
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    let desktopMap, mobileMap;
    let selectedPoints = [];
    let pointMarkers = []; // {id, desktopMarker, mobileMarker}
    let isSaving = false;
    let lastCenter = { lat: 51.63538575429843, lng: 16.45740592647929 };
    let lastZoom = 17;

    function initMap() {
      const mapOptionsBase = {
        center: lastCenter,
        zoom: lastZoom,
        fullscreenControl: false,
        styles: [
          { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] },
          { featureType: "administrative.locality", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "water", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "road", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "poi", elementType: "labels.text", stylers: [{ visibility: "on" }] },
          { featureType: "address", elementType: "labels.text", stylers: [{ visibility: "on" }] }
        ]
      };

      // Desktop
      const desktopEl = document.getElementById('map');
      if (desktopEl) {
        desktopMap = new google.maps.Map(desktopEl, { ...mapOptionsBase, streetViewControl: true });
        desktopMap.addListener('click', e => addPointToSelection(e.latLng));
        desktopMap.addListener('idle', () => {
          if (isVisible(desktopEl)) { const c = desktopMap.getCenter(); if (c) lastCenter = c.toJSON(); lastZoom = desktopMap.getZoom(); }
        });
        addWmsLayer(desktopMap, "dzialki");
        addWmsLayer(desktopMap, "numery_dzialek");
      }

      // Mobile
      const mobileEl = document.getElementById('map-mobile');
      if (mobileEl) {
        mobileMap = new google.maps.Map(mobileEl, { ...mapOptionsBase, streetViewControl: false });
        mobileMap.addListener('click', e => addPointToSelection(e.latLng));
        mobileMap.addListener('idle', () => {
          if (isVisible(mobileEl)) { const c = mobileMap.getCenter(); if (c) lastCenter = c.toJSON(); lastZoom = mobileMap.getZoom(); }
        });
        addWmsLayer(mobileMap, "dzialki");
        addWmsLayer(mobileMap, "numery_dzialek");
      }

      restoreMarkersFromSelectedPoints();
      handleResize();
    }

    function isVisible(el) { if (!el) return false; const style = window.getComputedStyle(el); return style && style.display !== 'none' && style.visibility !== 'hidden'; }

    let resizeTimer = null;
    function handleResize() {
      const desktopEl = document.getElementById('map');
      const mobileEl = document.getElementById('map-mobile');
      const useMobile = isVisible(mobileEl);
      const map = useMobile ? mobileMap : desktopMap;
      if (!map) return;
      map.setCenter(lastCenter);
      map.setZoom(lastZoom);
      google.maps.event.trigger(map, 'resize');
    }

    window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(handleResize, 150); });
    window.addEventListener('orientationchange', handleResize);

    function addWmsLayer(map, layerName) {
      const wmsUrl = "https://integracja.gugik.gov.pl/cgi-bin/KrajowaIntegracjaEwidencjiGruntow";
      const wmsMapType = new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
          const proj = map.getProjection();
          const zfactor = Math.pow(2, zoom);
          const ul = proj.fromPointToLatLng(new google.maps.Point(coord.x * 256 / zfactor, coord.y * 256 / zfactor));
          const lr = proj.fromPointToLatLng(new google.maps.Point((coord.x + 1) * 256 / zfactor, (coord.y + 1) * 256 / zfactor));
          const bbox = ul.lng() + "," + lr.lat() + "," + lr.lng() + "," + ul.lat();
          return wmsUrl +
            "?service=WMS&version=1.1.1&request=GetMap" +
            "&layers=" + layerName +
            "&styles=" +
            "&bbox=" + bbox +
            "&width=256&height=256" +
            "&srs=EPSG:4326" +
            "&format=image/png" +
            "&transparent=true";
        },
        tileSize: new google.maps.Size(256, 256),
        opacity: 0.7,
        name: layerName
      });
      map.overlayMapTypes.push(wmsMapType);
    }

    /* ===== POLSKA BOUNDS ===== */
    const POLAND_BOUNDS = { north: 55.0, south: 49.0, west: 14.1, east: 24.2 };
    function isInPoland(latLng) {
      return (
        latLng.lat() >= POLAND_BOUNDS.south &&
        latLng.lat() <= POLAND_BOUNDS.north &&
        latLng.lng() >= POLAND_BOUNDS.west &&
        latLng.lng() <= POLAND_BOUNDS.east
      );
    }

    /* ===== PUNKTY / MARKERY ===== */
    function addPointToSelection(latLng) {
      if (!isInPoland(latLng)) { showToast("MoÅ¼esz dodaÄ‡ punkt tylko na terenie Polski ğŸ‡µğŸ‡±", "warning"); return; }

      const pointId = 'point_' + Date.now();
      const point = { id: pointId, lat: latLng.lat(), lng: latLng.lng(), timestamp: new Date().toISOString() };
      selectedPoints.push(point);

      let desktopMarker = null, mobileMarker = null;
      if (desktopMap) desktopMarker = new google.maps.Marker({ position: latLng, map: desktopMap });
      if (mobileMap)  mobileMarker  = new google.maps.Marker({ position: latLng, map: mobileMap });
      pointMarkers.push({ id: pointId, desktopMarker, mobileMarker });

      updateSelectedPointsList();
      persistSelectedPoints();

      // Auto-zapis: klik zapisuje i usuwa punkt
      if ($('#autoSave').is(':checked')) {
        const toSave = { lat: point.lat, lng: point.lng };
        removePlot(pointId);
        savePlots([toSave]);
      }
    }

    function removePlot(pointId) {
      selectedPoints = selectedPoints.filter(p => p.id !== pointId);
      const markerObj = pointMarkers.find(m => m.id === pointId);
      if (markerObj) { if (markerObj.desktopMarker) markerObj.desktopMarker.setMap(null); if (markerObj.mobileMarker)  markerObj.mobileMarker.setMap(null); }
      pointMarkers = pointMarkers.filter(m => m.id !== pointId);
      updateSelectedPointsList();
      persistSelectedPoints();
    }

    function clearAllPoints() {
      selectedPoints = [];
      pointMarkers.forEach(m => { if (m.desktopMarker) m.desktopMarker.setMap(null); if (m.mobileMarker) m.mobileMarker.setMap(null); });
      pointMarkers = [];
      updateSelectedPointsList();
      persistSelectedPoints();
    }

    function updateSelectedPointsList() {
      const container = document.getElementById('selectedPlots');
      if (selectedPoints.length === 0) { container.innerHTML = '<p class="text-muted">Brak wskazanych dziaÅ‚ek.</p>'; return; }
      let html = '';
      selectedPoints.forEach((p, i) => {
        html += `
          <div class="plot-item">
            <span>DziaÅ‚ka nr ${i + 1}</span>
            <button onclick="removePlot('${p.id}')" aria-label="UsuÅ„ dziaÅ‚kÄ™ ${i+1}"><i class="fas fa-trash"></i></button>
          </div>`;
      });
      container.innerHTML = html;
    }

    /* ===== ZGODY â€“ zaznacz wszystkie ===== */
    $("#selectAllConsents").on("change", function() {
      const checked = $(this).is(":checked");
      $("#termsConsent, #marketingConsent").prop("checked", checked);
    });
    $("#termsConsent, #marketingConsent").on("change", function() {
      if (!$("#termsConsent").is(":checked") || !$("#marketingConsent").is(":checked")) { $("#selectAllConsents").prop("checked", false); } else { $("#selectAllConsents").prop("checked", true); }
    });

    /* ===== BUDOWANIE DANYCH DO ZAPISU ===== */
    function buildFormData(points) {
      const user = window.currentUser || null;

      const firstName = $('#firstName').val().trim();
      const phone = $('#phone').val().trim();
      const email = $('#email').val().trim() || (user ? (user.email || '') : '');
      const city = $('#city').val().trim();
      const price = $('#price').val().trim();
      const termsConsent = $('#termsConsent').is(':checked');
      const marketingConsent = $('#marketingConsent').is(':checked');

      const base = {
          price,
          mock: true,
          plots: points.map(p => ({
            Id: "", idDzialki_uldk: "",
            lat: p.lat, lng: p.lng,
            mock: true,
            geometry_uldk: null,
            pow_dzialki_m2_uldk: null,
            price: price || "",
            termsConsent: termsConsent,
            timestamp: new Date()
          })),
          timestamp: new Date(),
          firstName,
          phone,
          email,
          city,
          termsConsent,
          marketingConsent
        };

        if (isLoggedIn) {
          base.userUid = user?.uid || '';
          base.userEmail = user?.email || '';
        }
        return base;
    }

    /* ===== ZAPIS DO FIRESTORE ===== */
    async function savePlots(points) {
      if (isSaving) return false;
      if (!points || points.length === 0) { showToast("Å»adna dziaÅ‚ka nie jest zaznaczona.", "warning"); return false; }
      if (!validateForm()) { showToast("UzupeÅ‚nij wymagane pola.", "warning"); return false; }

      const formData = buildFormData(points);
      const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
      const submitText = document.getElementById('submitText');

      try {
        isSaving = true; if (submitBtn) submitBtn.disabled = true; if (submitText) submitText.textContent = "Zapisywanie...";
        await window.addDoc(window.collection(window.db, "propertyListings"), formData);
        showToast("Zapisano do bazy!", "success");
        return true;
      } catch (err) {
        showToast("BÅ‚Ä…d zapisu: " + err.message, "error");
        return false;
      } finally {
        isSaving = false; if (submitBtn) submitBtn.disabled = false; if (submitText) submitText.textContent = "Dodaj bezpÅ‚atne ogÅ‚oszenie";
      }
    }

    async function saveToDatabase() {
      if (selectedPoints.length === 0) { showToast("Å»adna dziaÅ‚ka nie jest zaznaczona. Dodaj co najmniej jeden punkt.", "warning"); return; }
      const ok = await savePlots([...selectedPoints]);
      if (ok) { clearAllPoints(); /* localStorage.removeItem(POINTS_KEY); */ }
    }

    /* ===== POBIERANIE NUMERU TEL. UÅ»YTKOWNIKA ===== */
    async function fetchAndPrefillPhone(user) {
      if (!user) return;
      try {
        // SprÃ³buj w kolekcji 'users/{uid}'
        let snap = await window.getDoc(window.doc(window.db, 'users', user.uid));
        let phone = snap.exists() ? (snap.data().phone || snap.data().telefon) : '';

        // JeÅ¼eli brak, sprÃ³buj alternatywnie 'profiles/{uid}'
        if (!phone) {
          snap = await window.getDoc(window.doc(window.db, 'profiles', user.uid));
          if (snap.exists()) phone = snap.data().phone || snap.data().telefon || '';
        }

        if (phone && !$('#phone').val()) $('#phone').val(phone);
      } catch (e) {
        // cicho ignoruj â€“ brak profilu to nie bÅ‚Ä…d krytyczny
      }
    }

    /* ===== TRYB LOGOWANIA â€“ ukrywanie/wyÅ›wietlanie pÃ³l ===== */
    function toggleFieldsForAuth(user) {
      isLoggedIn = !!user;

      // Wymagane pola zawsze aktywne
      ['#firstName', '#phone', '#email', '#city'].forEach(sel => {
        const $wrap = $(sel).closest('.mb-3');
        $(sel).prop('readonly', false).prop('disabled', false).prop('required', true);
        $wrap.removeClass('d-none disabled-field');
      });

      // Pole ceny opcjonalne
      $('#price').prop('readonly', false).prop('disabled', false).prop('required', false)
        .closest('.mb-3').removeClass('d-none disabled-field');

      // Zgody zawsze widoczne i wymagane (RODO)
      $('#selectAllConsents').closest('.form-check').removeClass('d-none');
      $('#termsConsent').prop('required', true).closest('.form-check').removeClass('d-none');
      $('#marketingConsent').closest('.form-check').removeClass('d-none');

      // AutowartoÅ›ci z profilu zalogowanego uÅ¼ytkownika
      if (user?.email) $('#email').val(user.email);
      if (user?.displayName) $('#firstName').val(user.displayName);
      if (user) fetchAndPrefillPhone(user);

      // Po zalogowaniu imiÄ™ i e-mail sÄ… tylko do odczytu
      if (user) {
        ['#firstName', '#email'].forEach(sel => {
          $(sel)
            .prop('readonly', true)
            .prop('disabled', true)
            .closest('.mb-3')
            .addClass('disabled-field');
        });
      }
    }

    window.addEventListener('auth-state-changed', (e) => toggleFieldsForAuth(e.detail));

    /* ===== READY ===== */
    $(document).ready(function() {
      loadFormFromStorage();
      loadSelectedPointsFromStorage();

      $('#propertyForm').on('input change', 'input, textarea, select', saveFormToStorage);

      $("#propertyForm").on("submit", function(e){ e.preventDefault(); saveToDatabase(); });

      $("#autoSave").on("change", async function () {
        if ($(this).is(":checked")) {
          if (!validateForm()) { showToast("Aby wÅ‚Ä…czyÄ‡ Auto-zapis, najpierw uzupeÅ‚nij wymagane pola!", "warning"); $(this).prop("checked", false); return; }
          if (selectedPoints.length > 0) { const ok = await savePlots([...selectedPoints]); if (ok) clearAllPoints(); }
          showToast("Auto-zapis wÅ‚Ä…czony. Nowe klikniÄ™cia bÄ™dÄ… zapisywane automatycznie.", "success");
        } else {
          showToast("Auto-zapis wyÅ‚Ä…czony.", "info");
        }
      });

  $("#clearPlotsBtn, #clearPlotsBtnMobile").on("click", function(){ clearAllPoints(); });

      toggleFieldsForAuth(window.currentUser || null);
    });



  </script>
  <script type="module">
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      setPersistence, browserLocalPersistence, browserSessionPersistence, inMemoryPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
      authDomain: "base-468e0.firebaseapp.com",
      projectId: "base-468e0",
      storageBucket: "base-468e0.firebasestorage.app",
      messagingSenderId: "829161895559",
      appId: "1:829161895559:web:d832541aac05b35847ea22"
    };

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    auth.languageCode = 'pl';

    try { await setPersistence(auth, browserLocalPersistence); }
    catch { try { await setPersistence(auth, browserSessionPersistence); }
    catch { await setPersistence(auth, inMemoryPersistence); } }

    const googleProvider = new GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: 'select_account' });

    const authButtons = document.getElementById('authButtons');
    const userMenu    = document.getElementById('userMenu');
    const loginBtn    = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const accountBtn  = document.getElementById('accountBtn');
    const logoutBtn   = document.getElementById('logoutBtn');

    const loginModal    = document.getElementById('loginModal');
    const registerModal = document.getElementById('registerModal');
    const closeBtns     = document.querySelectorAll('.modal-close');
    const switchToRegister = document.getElementById('switchToRegister');
    const switchToLogin    = document.getElementById('switchToLogin');

    const loginForm    = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const googleBtnRegister = document.getElementById('googleLoginBtn');
    const googleBtnLogin    = document.getElementById('googleLoginBtnLogin');

    const openModal  = (m) => m && (m.style.display = 'flex');
    const closeModal = (m) => m && (m.style.display = 'none');

    function renderMobileAuth(user) {
      const navMenu = document.querySelector('.nav-menu');
      const mobileAuthC = document.getElementById('mobileAuth');
      if (!mobileAuthC) return;

      if (user) {
        const label = user.displayName ? user.displayName.split(' ')[0] : (user.email || 'UÅ¼ytkownik');
        mobileAuthC.innerHTML = `
          <div class="nav-link" style="font-weight:600;">
            <i class="fas fa-user"></i> ${label}
          </div>
          <button class="btn btn-secondary" id="mobileLogoutBtn" style="width:100%;">
            <i class="fas fa-sign-out-alt"></i> Wyloguj siÄ™
          </button>
        `;
      } else {
        mobileAuthC.innerHTML = `
          <a href="#" id="loginLink" class="nav-link">Zaloguj siÄ™</a>
          <a href="#" id="registerLink" class="nav-link">Zarejestruj siÄ™</a>
        `;
      }

      const loginLink = document.getElementById('loginLink');
      const registerLink = document.getElementById('registerLink');
      const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');

      loginLink && loginLink.addEventListener('click', (e) => {
        e.preventDefault();
        openModal(loginModal);
        navMenu?.classList.remove('active');
        mobileAuthC.style.display = 'none';
      });

      registerLink && registerLink.addEventListener('click', (e) => {
        e.preventDefault();
        openModal(registerModal);
        navMenu?.classList.remove('active');
        mobileAuthC.style.display = 'none';
      });

      mobileLogoutBtn && mobileLogoutBtn.addEventListener('click', async () => {
        try { await signOut(auth); } catch(e){ console.error(e); }
        navMenu?.classList.remove('active');
        mobileAuthC.style.display = 'none';
      });

      mobileAuthC.style.display = navMenu?.classList.contains('active') ? 'flex' : 'none';
    }

    loginBtn    && loginBtn.addEventListener('click', () => openModal(loginModal));
    registerBtn && registerBtn.addEventListener('click', () => openModal(registerModal));
    accountBtn  && accountBtn.addEventListener('click', () => { window.location.href = 'oferty.html#userDashboard'; });
    closeBtns.forEach(b => b.addEventListener('click', () => closeModal(b.closest('.modal'))));
    window.addEventListener('click', (e) => {
      if (e.target.classList?.contains('modal')) closeModal(e.target);
    });

    const niceErr = (err) => {
      switch (err?.code) {
        case 'auth/invalid-email': return 'NieprawidÅ‚owy adres e-mail.';
        case 'auth/missing-password': return 'Podaj hasÅ‚o.';
        case 'auth/user-not-found':
        case 'auth/wrong-password':
        case 'auth/invalid-credential': return 'NieprawidÅ‚owy e-mail lub hasÅ‚o.';
        case 'auth/too-many-requests': return 'Za duÅ¼o prÃ³b. SprÃ³buj pÃ³Åºniej.';
        case 'auth/unauthorized-domain': return `Domena ${location.hostname} nie jest dodana w Firebase (Authorized domains).`;
        case 'auth/popup-blocked': return 'PrzeglÄ…darka zablokowaÅ‚a okno logowania Google.';
        case 'auth/operation-not-supported-in-this-environment': return 'Uruchom stronÄ™ przez http/https (nie file://).';
        default: return 'BÅ‚Ä…d: ' + (err?.code || err?.message || 'nieznany');
      }
    };

    loginForm && loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass  = document.getElementById('loginPassword').value;
      try { await signInWithEmailAndPassword(auth, email, pass); closeModal(loginModal); }
      catch (err) { showToast(niceErr(err)); }
    });

    registerForm && registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name  = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const pass1 = document.getElementById('registerPassword').value;
      const pass2 = document.getElementById('registerConfirmPassword').value;
      if (pass1 !== pass2) return showToast('HasÅ‚a nie sÄ… identyczne!');
      try {
        const { user } = await createUserWithEmailAndPassword(auth, email, pass1);
        if (name) await updateProfile(user, { displayName: name });
        await setDoc(doc(db, "users", user.uid), { name: name || null, email, createdAt: new Date(), provider: 'password' }, { merge: true });
        closeModal(registerModal);
      } catch (err) { showToast(niceErr(err)); }
    });

    async function signInWithGoogleSmart() {
      if (!['http:', 'https:'].includes(location.protocol))
        return showToast('Uruchom stronÄ™ przez http/https (nie file://).');
      try {
        const res = await signInWithPopup(auth, googleProvider);
        const user = res.user;
        await setDoc(doc(db, "users", user.uid), {
          name: user.displayName || null,
          email: user.email || null,
          provider: 'google',
          createdAt: new Date(),
        }, { merge: true });
        closeModal(loginModal); closeModal(registerModal);
      } catch (err) {
        if (err?.code === 'auth/popup-blocked' || err?.code === 'auth/operation-not-supported-in-this-environment') {
          await signInWithRedirect(auth, googleProvider);
        } else {
          showToast(niceErr(err));
        }
      }
    }

    googleBtnRegister && googleBtnRegister.addEventListener('click', signInWithGoogleSmart);
    googleBtnLogin    && googleBtnLogin.addEventListener('click', signInWithGoogleSmart);
    logoutBtn && logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch(e){ console.error(e); } });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authButtons && (authButtons.style.display = 'none');
        userMenu && (userMenu.style.display = 'flex');
        if (accountBtn) {
          const label = user.displayName || user.email || 'Moje konto';
          accountBtn.innerHTML = `<i class="fas fa-user me-1"></i> ${label}`;
        }
      } else {
        authButtons && (authButtons.style.display = 'flex');
        userMenu && (userMenu.style.display = 'none');
      }
      renderMobileAuth(user);
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
      const navMenu = document.querySelector('.nav-menu');
      const mobileAuth = document.getElementById('mobileAuth');

      mobileMenuBtn?.addEventListener('click', function () {
        navMenu.classList.toggle('active');
        if (mobileAuth) {
          mobileAuth.style.display = navMenu.classList.contains('active') ? 'flex' : 'none';
        }
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          navMenu.classList.remove('active');
          if (mobileAuth) mobileAuth.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
